<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Random Notes on Coding – TinyML</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../cc-cli/cc-cli.html" rel="next">
<link href="../cc-os/cc-os.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-2fef5ea3f8957b3e4ecc936fc74692ca.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-6353c5142b84b22f6683470407aecb9b.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-5549b3ede58740172b4e45471f64731a.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../site_libs/bootstrap/bootstrap-6353c5142b84b22f6683470407aecb9b.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating slimcontent quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const queryPrefersDark = window.matchMedia('(prefers-color-scheme: dark)');
    const darkModeDefault = queryPrefersDark.matches;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    queryPrefersDark.addEventListener("change", e => {
      if(window.localStorage.getItem("quarto-color-scheme") !== null)
        return;
      const alternate = e.matches
      toggleColorMode(alternate);
      localAlternateSentinel = e.matches ? 'alternate' : 'default'; // this is used alongside local storage!
      toggleGiscusIfUsed(alternate, darkModeDefault);
    });
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../c-riscv-asm/c-riscv-asm.html">Crash Courses</a></li><li class="breadcrumb-item"><a href="../cc-coding/cc-coding.html"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Random Notes on Coding</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">TinyML</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Prologue</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction 引入</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../resources/resources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Resources 学习资料汇总</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../glossary/glossary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Glossary 名词解释</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../research-proposal/research-proposal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Research Proposal: New Inference Paradigms for ML at the Edge</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Environment Setup</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../env-setup/env-setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">FPGA 开发环境配置</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">EDA</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../eda-notes/eda-notes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">EDA Notes 笔记</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Crash Courses</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../c-riscv-asm/c-riscv-asm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">C 和 RISCV 汇编</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../riscv/riscv.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">RISCV ISA</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../cc-os/cc-os.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">OS 操作系统原理</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../cc-coding/cc-coding.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Random Notes on Coding</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../cc-cli/cc-cli.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Basic Linux CLI</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../cc-fpga/cc-fpga.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">FPGA 原理速成</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../cc-cpu/cc-cpu.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">CPU 原理速成</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../cc-gpu/cc-gpu.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">GPU 原理速成</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Neural Network</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nn-essence/nn-essence.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">The Essence of NN 神经网络的本质</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nn-arch/nn-arch.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">NN Architectures 常见网络架构</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">ML Accelerators</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../coral-npu/coral-npu.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Google Coral NPU</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">CFU Playground</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../cfu-proj-struct/cfu-proj-struct.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">CFU-Playground 工程结构</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#some-c" id="toc-some-c" class="nav-link active" data-scroll-target="#some-c">Some C++</a>
  <ul class="collapse">
  <li><a href="#c-basics" id="toc-c-basics" class="nav-link" data-scroll-target="#c-basics">C++ Basics</a></li>
  <li><a href="#memory-management-内存管理" id="toc-memory-management-内存管理" class="nav-link" data-scroll-target="#memory-management-内存管理">Memory Management 内存管理</a></li>
  <li><a href="#class-类" id="toc-class-类" class="nav-link" data-scroll-target="#class-类">Class 类</a></li>
  <li><a href="#alias-别名" id="toc-alias-别名" class="nav-link" data-scroll-target="#alias-别名">Alias 别名</a></li>
  <li><a href="#polymorphism-多态" id="toc-polymorphism-多态" class="nav-link" data-scroll-target="#polymorphism-多态">Polymorphism 多态</a></li>
  <li><a href="#namespace-命名空间" id="toc-namespace-命名空间" class="nav-link" data-scroll-target="#namespace-命名空间">Namespace 命名空间</a></li>
  <li><a href="#常见库用法" id="toc-常见库用法" class="nav-link" data-scroll-target="#常见库用法">常见库用法</a></li>
  </ul></li>
  <li><a href="#some-python" id="toc-some-python" class="nav-link" data-scroll-target="#some-python">Some Python</a>
  <ul class="collapse">
  <li><a href="#python-basics" id="toc-python-basics" class="nav-link" data-scroll-target="#python-basics">Python Basics</a></li>
  <li><a href="#python-class-类" id="toc-python-class-类" class="nav-link" data-scroll-target="#python-class-类">Python Class 类</a></li>
  <li><a href="#python-下划线" id="toc-python-下划线" class="nav-link" data-scroll-target="#python-下划线">Python 下划线</a></li>
  <li><a href="#python-常用数据结构" id="toc-python-常用数据结构" class="nav-link" data-scroll-target="#python-常用数据结构">Python 常用数据结构</a></li>
  <li><a href="#可变参数" id="toc-可变参数" class="nav-link" data-scroll-target="#可变参数">可变参数</a></li>
  <li><a href="#first-class-objects" id="toc-first-class-objects" class="nav-link" data-scroll-target="#first-class-objects">First-class Objects</a></li>
  <li><a href="#链式调用" id="toc-链式调用" class="nav-link" data-scroll-target="#链式调用">链式调用</a></li>
  <li><a href="#cocotb-库" id="toc-cocotb-库" class="nav-link" data-scroll-target="#cocotb-库"><code>cocotb</code> 库</a></li>
  </ul></li>
  <li><a href="#sec-pybind11" id="toc-sec-pybind11" class="nav-link" data-scroll-target="#sec-pybind11">Pybind11</a>
  <ul class="collapse">
  <li><a href="#python-调用-c-函数" id="toc-python-调用-c-函数" class="nav-link" data-scroll-target="#python-调用-c-函数">Python 调用 C++ 函数</a></li>
  <li><a href="#python-调用-c-类" id="toc-python-调用-c-类" class="nav-link" data-scroll-target="#python-调用-c-类">Python 调用 C++ 类</a></li>
  </ul></li>
  <li><a href="#build-tools-构建工具" id="toc-build-tools-构建工具" class="nav-link" data-scroll-target="#build-tools-构建工具">Build Tools 构建工具</a>
  <ul class="collapse">
  <li><a href="#cmakelists" id="toc-cmakelists" class="nav-link" data-scroll-target="#cmakelists">CMakeLists</a></li>
  <li><a href="#makefile" id="toc-makefile" class="nav-link" data-scroll-target="#makefile">Makefile</a></li>
  <li><a href="#bazel" id="toc-bazel" class="nav-link" data-scroll-target="#bazel">Bazel</a></li>
  </ul></li>
  <li><a href="#project-management-项目管理" id="toc-project-management-项目管理" class="nav-link" data-scroll-target="#project-management-项目管理">Project Management 项目管理</a>
  <ul class="collapse">
  <li><a href="#python" id="toc-python" class="nav-link" data-scroll-target="#python">Python</a></li>
  </ul></li>
  <li><a href="#sec-coding-habits" id="toc-sec-coding-habits" class="nav-link" data-scroll-target="#sec-coding-habits">Coding Habits</a>
  <ul class="collapse">
  <li><a href="#general" id="toc-general" class="nav-link" data-scroll-target="#general">General</a></li>
  <li><a href="#检查相等" id="toc-检查相等" class="nav-link" data-scroll-target="#检查相等">检查相等</a></li>
  <li><a href="#正负无穷" id="toc-正负无穷" class="nav-link" data-scroll-target="#正负无穷">正负无穷</a></li>
  <li><a href="#向上取整" id="toc-向上取整" class="nav-link" data-scroll-target="#向上取整">向上取整</a></li>
  <li><a href="#遍历数组和张量" id="toc-遍历数组和张量" class="nav-link" data-scroll-target="#遍历数组和张量">遍历数组和张量</a></li>
  <li><a href="#全局索引与局部索引的转换" id="toc-全局索引与局部索引的转换" class="nav-link" data-scroll-target="#全局索引与局部索引的转换">全局索引与局部索引的转换</a></li>
  <li><a href="#命名习惯" id="toc-命名习惯" class="nav-link" data-scroll-target="#命名习惯">命名习惯</a></li>
  <li><a href="#getters-和-setters" id="toc-getters-和-setters" class="nav-link" data-scroll-target="#getters-和-setters">getters 和 Setters</a></li>
  <li><a href="#常写-const" id="toc-常写-const" class="nav-link" data-scroll-target="#常写-const">常写 <code>const</code></a></li>
  </ul></li>
  <li><a href="#code-reading-techniques" id="toc-code-reading-techniques" class="nav-link" data-scroll-target="#code-reading-techniques">Code Reading &amp; Techniques</a>
  <ul class="collapse">
  <li><a href="#first-encounter" id="toc-first-encounter" class="nav-link" data-scroll-target="#first-encounter">First Encounter</a></li>
  <li><a href="#rtl-代码阅读" id="toc-rtl-代码阅读" class="nav-link" data-scroll-target="#rtl-代码阅读">RTL 代码阅读</a></li>
  </ul></li>
  <li><a href="#verilog" id="toc-verilog" class="nav-link" data-scroll-target="#verilog">Verilog</a>
  <ul class="collapse">
  <li><a href="#verilog-basics" id="toc-verilog-basics" class="nav-link" data-scroll-target="#verilog-basics">Verilog Basics</a></li>
  <li><a href="#verilog-向量" id="toc-verilog-向量" class="nav-link" data-scroll-target="#verilog-向量">Verilog 向量</a></li>
  <li><a href="#硬件代码生成" id="toc-硬件代码生成" class="nav-link" data-scroll-target="#硬件代码生成">硬件代码生成</a></li>
  <li><a href="#systemverilog-函数" id="toc-systemverilog-函数" class="nav-link" data-scroll-target="#systemverilog-函数">Systemverilog 函数</a></li>
  <li><a href="#verilog-testbench" id="toc-verilog-testbench" class="nav-link" data-scroll-target="#verilog-testbench">Verilog Testbench</a></li>
  </ul></li>
  <li><a href="#chisel" id="toc-chisel" class="nav-link" data-scroll-target="#chisel">Chisel</a>
  <ul class="collapse">
  <li><a href="#area-optimization-面积优化方法" id="toc-area-optimization-面积优化方法" class="nav-link" data-scroll-target="#area-optimization-面积优化方法">Area Optimization 面积优化方法</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../c-riscv-asm/c-riscv-asm.html">Crash Courses</a></li><li class="breadcrumb-item"><a href="../cc-coding/cc-coding.html"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Random Notes on Coding</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Random Notes on Coding</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="some-c" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="some-c">Some C++</h2>
<section id="c-basics" class="level3">
<h3 class="anchored" data-anchor-id="c-basics">C++ Basics</h3>
<section id="inline-关键字" class="level4">
<h4 class="anchored" data-anchor-id="inline-关键字"><code>inline</code> 关键字</h4>
<ul>
<li><p>允许重复定义 (如果你要在头文件里<strong>定义</strong> (而不是声明) 函数最好加上 <code>inline</code>):</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>add.cpp</strong></pre>
</div>
<div class="sourceCode" id="lst-addcpp" data-filename="add.cpp"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-addcpp-1"><a href="#lst-addcpp-1" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="dt">int</span> add<span class="op">(</span><span class="dt">int</span> a<span class="op">,</span> <span class="dt">int</span> b<span class="op">)</span> <span class="op">{</span><span class="cf">return</span> a <span class="op">+</span> b<span class="op">;}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p>避免函数调用开销, 如果 <code>add()</code> 用 <a href="#lst-addcpp" class="quarto-xref">Listing&nbsp;<span class="quarto-unresolved-ref">lst-addcpp</span></a> 来定义, 则:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> x <span class="op">=</span> add<span class="op">(</span><span class="dv">3</span><span class="op">,</span> <span class="dv">5</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>会被编译器展开成:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> x <span class="op">=</span> <span class="dv">3</span> <span class="op">+</span> <span class="dv">5</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(当然这个函数由于过于简单, 如果不用 <code>inline</code>, 编译器也会自动优化掉函数调用开销).</p></li>
</ul>
</section>
<section id="extern-关键字" class="level4">
<h4 class="anchored" data-anchor-id="extern-关键字"><code>extern</code> 关键字</h4>
<ul>
<li><p>告诉编译器这变量存在, 先不要急着报错, 链接的时候会找到它.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// var.cpp</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> var <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">// main.cpp</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="at">extern</span> <span class="dt">int</span> var<span class="op">;</span>  <span class="co">// Tell compiler var exists somewhere</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">"var = "</span> <span class="op">&lt;&lt;</span> var <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">g++</span> main.cpp var.cpp <span class="at">-o</span> main</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">./main</span> <span class="co"># Outputs: var = 2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><code>extern "C"</code>: 当用 Cpp 写的函数名<strong>要被 C 代码 (或汇编) 调用时</strong>需要加上 <code>extern "C"</code> 来告诉编译器不要对函数名进行 Name mangling (名字修饰).</p>
<ul>
<li><strong>Name mangling</strong>: 在 Cpp 中编译出来的 <code>.o</code> 文件中的函数名并不是源代码中写的名字 (但是 C 语言中是一样的)! 比如下面的例子:</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>a.c</strong></pre>
</div>
<div class="sourceCode" id="lst-ac" data-filename="a.c"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="lst-ac-1"><a href="#lst-ac-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="lst-ac-2"><a href="#lst-ac-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> my_add<span class="op">(</span><span class="dt">int</span><span class="op">,</span> <span class="dt">int</span><span class="op">);</span></span>
<span id="lst-ac-3"><a href="#lst-ac-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="lst-ac-4"><a href="#lst-ac-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> result <span class="op">=</span> my_add<span class="op">(</span><span class="dv">3</span><span class="op">,</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="lst-ac-5"><a href="#lst-ac-5" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Result: </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> result<span class="op">);</span></span>
<span id="lst-ac-6"><a href="#lst-ac-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="lst-ac-7"><a href="#lst-ac-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="columns">
<div class="column" style="width:52%;">
<p>不用 <code>extern "C"</code> 时:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>b.cc</strong></pre>
</div>
<div class="sourceCode" id="lst-bcc" data-filename="b.cc"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-bcc-1"><a href="#lst-bcc-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> my_add<span class="op">(</span><span class="dt">int</span> x<span class="op">,</span> <span class="dt">int</span> y<span class="op">)</span> <span class="op">{</span><span class="cf">return</span> x <span class="op">+</span> y<span class="op">;}</span></span>
<span id="lst-bcc-2"><a href="#lst-bcc-2" aria-hidden="true" tabindex="-1"></a> </span>
<span id="lst-bcc-3"><a href="#lst-bcc-3" aria-hidden="true" tabindex="-1"></a> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gcc</span> <span class="at">-c</span> a.c <span class="at">-o</span> a.o</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">g++</span> <span class="at">-c</span> b.cc <span class="at">-o</span> b.o</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">nm</span> a.o  <span class="co"># 查看符号表</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">nm</span> b.o</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="ex">g++</span> a.o b.o <span class="at">-o</span> program <span class="co"># Linking error!</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>输出:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># C 语言的函数名没有变化</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ex">0000000000000000</span> T main         </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">U</span> my_add</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">U</span> printf</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># b.o 里的函数名被改成了 _Z6my_addii</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="ex">0000000000000000</span> T _Z6my_addii </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># linking error</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="ex">/bin/ld:</span> a.o: in function <span class="kw">`</span><span class="ex">main</span><span class="st">':</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="st">a.c:(.text+0x15): undefined reference to `my_add'</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="ex">collect2:</span> error: ld returned 1 exit status</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div><div class="column" style="width:2%;">

</div><div class="column" style="width:46%;">
<p>使用 <code>extern "C"</code> 时:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>b.cc</strong></pre>
</div>
<div class="sourceCode" id="lst-bcc" data-filename="b.cc"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-bcc-1"><a href="#lst-bcc-1" aria-hidden="true" tabindex="-1"></a><span class="at">extern</span> <span class="st">"C"</span> <span class="op">{</span></span>
<span id="lst-bcc-2"><a href="#lst-bcc-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> my_add<span class="op">(</span><span class="dt">int</span> x<span class="op">,</span> <span class="dt">int</span> y<span class="op">)</span> <span class="op">{</span><span class="cf">return</span> x <span class="op">+</span> y<span class="op">;}</span></span>
<span id="lst-bcc-3"><a href="#lst-bcc-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gcc</span> <span class="at">-c</span> a.c <span class="at">-o</span> a.o</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">g++</span> <span class="at">-c</span> b.cc <span class="at">-o</span> b.o</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">nm</span> a.o  <span class="co"># 查看符号表</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">nm</span> b.o</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="ex">g++</span> a.o b.o <span class="at">-o</span> program</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="ex">./program</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>输出:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># C 语言的函数名没有变化</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">0000000000000000</span> T main         </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">U</span> my_add</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">U</span> printf</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># b.o 里的函数名也没有变化</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="ex">0000000000000000</span> my_add         </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># ./program 执行结果</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="ex">Result:</span> 8</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="命令行参数" class="level4">
<h4 class="anchored" data-anchor-id="命令行参数">命令行参数</h4>
<ul>
<li><code>argc</code>: Argument Count, 参数个数</li>
<li><code>argv</code>: Argument Vector, 参数列表 (字符串数组)</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span><span class="op">*</span> argv<span class="op">[])</span> <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>编译运行:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">g++</span> main.cpp <span class="at">-o</span> main</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ex">./main</span> abc 999 test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>会有:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>argc <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>argv<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="st">"./main"</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>argv<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> <span class="st">"abc"</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>argv<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> <span class="st">"999"</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>argv<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> <span class="st">"test"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="类型转换" class="level4">
<h4 class="anchored" data-anchor-id="类型转换">类型转换</h4>
<p>TODO</p>
</section>
</section>
<section id="memory-management-内存管理" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="memory-management-内存管理">Memory Management 内存管理</h3>
<section id="type-数据类型" class="level4">
<h4 class="anchored" data-anchor-id="type-数据类型">Type 数据类型</h4>
<ul>
<li><code>size_t</code>: 就是 <code>unsigned int</code> (RV32 就是 <span class="math inline">\(32\)</span> bit). 一般用来表示内存大小或数组索引.</li>
</ul>
</section>
<section id="new-关键字" class="level4">
<h4 class="anchored" data-anchor-id="new-关键字"><code>new</code> 关键字</h4>
<p><code>new</code> 用来在堆上分配内存:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span><span class="op">*</span> p <span class="op">=</span> <span class="kw">new</span> <span class="dt">int</span><span class="op">[</span><span class="dv">10</span><span class="op">];</span> <span class="co">// Allocate 10 integers on heap</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    p<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> i <span class="op">*</span> i<span class="op">;</span> <span class="co">// Assign values</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="kw">delete</span><span class="op">[]</span> p<span class="op">;</span> <span class="co">// Don't forget to free the memory!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>分配单个对象. 注意下面两行代码的唯一区别是 <code>malloc</code> <strong>没有调用 Constructor</strong>!</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>MyClass<span class="op">*</span> obj <span class="op">=</span> <span class="kw">new</span> MyClass<span class="op">();</span> <span class="co">// Allocate single object</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>MyClass<span class="op">*</span> obj2 <span class="op">=</span> <span class="op">(</span>MyClass<span class="op">*)</span>malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span>MyClass<span class="op">));</span> <span class="co">// C-style allocation</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="kw">delete</span> obj<span class="op">;</span> <span class="co">// Free the memory!</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>free<span class="op">(</span>obj2<span class="op">);</span> <span class="co">// Free C-style allocated memory</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="smart-pointers-智能指针" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="smart-pointers-智能指针">Smart Pointers 智能指针</h4>
<p>Smart Pointers = <code>new</code> without <code>delete</code>. 即不需要担心内存泄漏问题.</p>
<ul>
<li><p><code>std::unique_ptr&lt;T&gt;</code>: 不能被复制:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>unique_ptr<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> p1 <span class="op">=</span> <span class="bu">std::</span>make_unique<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;(</span><span class="dv">42</span><span class="op">);</span> <span class="co">// Create unique_ptr</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co">// std::unique_ptr&lt;int&gt; p2 = p1; // Error: cannot copy unique_ptr</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><code>std::shared_ptr&lt;T&gt;</code>: 可以被复制 (用过引用计数来管理内存).</p></li>
<li><p><code>std::weak_ptr&lt;T&gt;</code>: 不会增加引用计数, 用于解决 <code>shared_ptr</code> 循环引用问题 (<a href="#fig-cirref" class="quarto-xref">Figure&nbsp;<span class="quarto-unresolved-ref">fig-cirref</span></a>, <code>a1</code> 表示 <code>a</code> 的引用计数为 1 (<code>a.use_count() == 1</code>)):</p></li>
</ul>

<div class="no-row-height column-margin column-container"><div class="">
<div id="fig-cirref" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cirref-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="cirref.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cirref-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: 循环引用问题
</figcaption>
</figure>
</div>
</div></div><div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>sharedptr.cpp</strong></pre>
</div>
<div class="sourceCode" id="lst-sharedptrcpp" data-filename="sharedptr.cpp"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-sharedptrcpp-1"><a href="#lst-sharedptrcpp-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;memory&gt;</span></span>
<span id="lst-sharedptrcpp-2"><a href="#lst-sharedptrcpp-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="lst-sharedptrcpp-3"><a href="#lst-sharedptrcpp-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-sharedptrcpp-4"><a href="#lst-sharedptrcpp-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> B<span class="op">;</span> <span class="co">// Let A know B</span></span>
<span id="lst-sharedptrcpp-5"><a href="#lst-sharedptrcpp-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-sharedptrcpp-6"><a href="#lst-sharedptrcpp-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> A <span class="op">{</span></span>
<span id="lst-sharedptrcpp-7"><a href="#lst-sharedptrcpp-7" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="lst-sharedptrcpp-8"><a href="#lst-sharedptrcpp-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>shared_ptr<span class="op">&lt;</span>B<span class="op">&gt;</span> bptr<span class="op">;</span></span>
<span id="lst-sharedptrcpp-9"><a href="#lst-sharedptrcpp-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">~</span>A<span class="op">()</span> <span class="op">{</span></span>
<span id="lst-sharedptrcpp-10"><a href="#lst-sharedptrcpp-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">"A destroyed</span><span class="sc">\n</span><span class="st">"</span><span class="op">;</span> </span>
<span id="lst-sharedptrcpp-11"><a href="#lst-sharedptrcpp-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-sharedptrcpp-12"><a href="#lst-sharedptrcpp-12" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-sharedptrcpp-13"><a href="#lst-sharedptrcpp-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-sharedptrcpp-14"><a href="#lst-sharedptrcpp-14" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> B <span class="op">{</span></span>
<span id="lst-sharedptrcpp-15"><a href="#lst-sharedptrcpp-15" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="lst-sharedptrcpp-16"><a href="#lst-sharedptrcpp-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>shared_ptr<span class="op">&lt;</span>A<span class="op">&gt;</span> aptr<span class="op">;</span></span>
<span id="lst-sharedptrcpp-17"><a href="#lst-sharedptrcpp-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">~</span>B<span class="op">()</span> <span class="op">{</span></span>
<span id="lst-sharedptrcpp-18"><a href="#lst-sharedptrcpp-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">"B destroyed</span><span class="sc">\n</span><span class="st">"</span><span class="op">;</span></span>
<span id="lst-sharedptrcpp-19"><a href="#lst-sharedptrcpp-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-sharedptrcpp-20"><a href="#lst-sharedptrcpp-20" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-sharedptrcpp-21"><a href="#lst-sharedptrcpp-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-sharedptrcpp-22"><a href="#lst-sharedptrcpp-22" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="lst-sharedptrcpp-23"><a href="#lst-sharedptrcpp-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> a <span class="op">=</span> <span class="bu">std::</span>make_shared<span class="op">&lt;</span>A<span class="op">&gt;();</span> <span class="co">// a1</span></span>
<span id="lst-sharedptrcpp-24"><a href="#lst-sharedptrcpp-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> b <span class="op">=</span> <span class="bu">std::</span>make_shared<span class="op">&lt;</span>B<span class="op">&gt;();</span> <span class="co">// b1</span></span>
<span id="lst-sharedptrcpp-25"><a href="#lst-sharedptrcpp-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-sharedptrcpp-26"><a href="#lst-sharedptrcpp-26" aria-hidden="true" tabindex="-1"></a>    a<span class="op">-&gt;</span>bptr <span class="op">=</span> b<span class="op">;</span> <span class="co">// b2</span></span>
<span id="lst-sharedptrcpp-27"><a href="#lst-sharedptrcpp-27" aria-hidden="true" tabindex="-1"></a>    b<span class="op">-&gt;</span>aptr <span class="op">=</span> a<span class="op">;</span> <span class="co">// a2</span></span>
<span id="lst-sharedptrcpp-28"><a href="#lst-sharedptrcpp-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-sharedptrcpp-29"><a href="#lst-sharedptrcpp-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// No destroy messages! (Memory leak)</span></span>
<span id="lst-sharedptrcpp-30"><a href="#lst-sharedptrcpp-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="co">// b1 a1 (not 0!)</span></span>
<span id="lst-sharedptrcpp-31"><a href="#lst-sharedptrcpp-31" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>weakptr.cpp</strong></pre>
</div>
<div class="sourceCode" id="lst-weakptr" data-filename="weakptr.cpp"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-weakptr-1"><a href="#lst-weakptr-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;memory&gt;</span></span>
<span id="lst-weakptr-2"><a href="#lst-weakptr-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="lst-weakptr-3"><a href="#lst-weakptr-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-weakptr-4"><a href="#lst-weakptr-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> B<span class="op">;</span> <span class="co">// Let A know B</span></span>
<span id="lst-weakptr-5"><a href="#lst-weakptr-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-weakptr-6"><a href="#lst-weakptr-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> A <span class="op">{</span></span>
<span id="lst-weakptr-7"><a href="#lst-weakptr-7" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="lst-weakptr-8"><a href="#lst-weakptr-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>weak_ptr<span class="op">&lt;</span>B<span class="op">&gt;</span> bptr<span class="op">;</span></span>
<span id="lst-weakptr-9"><a href="#lst-weakptr-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">~</span>A<span class="op">()</span> <span class="op">{</span></span>
<span id="lst-weakptr-10"><a href="#lst-weakptr-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">"A destroyed</span><span class="sc">\n</span><span class="st">"</span><span class="op">;</span></span>
<span id="lst-weakptr-11"><a href="#lst-weakptr-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-weakptr-12"><a href="#lst-weakptr-12" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-weakptr-13"><a href="#lst-weakptr-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-weakptr-14"><a href="#lst-weakptr-14" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> B <span class="op">{</span></span>
<span id="lst-weakptr-15"><a href="#lst-weakptr-15" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="lst-weakptr-16"><a href="#lst-weakptr-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>weak_ptr<span class="op">&lt;</span>A<span class="op">&gt;</span> aptr<span class="op">;</span></span>
<span id="lst-weakptr-17"><a href="#lst-weakptr-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">~</span>B<span class="op">()</span> <span class="op">{</span></span>
<span id="lst-weakptr-18"><a href="#lst-weakptr-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">"B destroyed</span><span class="sc">\n</span><span class="st">"</span><span class="op">;</span></span>
<span id="lst-weakptr-19"><a href="#lst-weakptr-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-weakptr-20"><a href="#lst-weakptr-20" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-weakptr-21"><a href="#lst-weakptr-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-weakptr-22"><a href="#lst-weakptr-22" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="lst-weakptr-23"><a href="#lst-weakptr-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> a <span class="op">=</span> <span class="bu">std::</span>make_shared<span class="op">&lt;</span>A<span class="op">&gt;();</span> <span class="co">// a1</span></span>
<span id="lst-weakptr-24"><a href="#lst-weakptr-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> b <span class="op">=</span> <span class="bu">std::</span>make_shared<span class="op">&lt;</span>B<span class="op">&gt;();</span> <span class="co">// b1</span></span>
<span id="lst-weakptr-25"><a href="#lst-weakptr-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-weakptr-26"><a href="#lst-weakptr-26" aria-hidden="true" tabindex="-1"></a>    a<span class="op">-&gt;</span>bptr <span class="op">=</span> b<span class="op">;</span> <span class="co">// b1 still</span></span>
<span id="lst-weakptr-27"><a href="#lst-weakptr-27" aria-hidden="true" tabindex="-1"></a>    b<span class="op">-&gt;</span>aptr <span class="op">=</span> a<span class="op">;</span> <span class="co">// a1 still</span></span>
<span id="lst-weakptr-28"><a href="#lst-weakptr-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-weakptr-29"><a href="#lst-weakptr-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Destroy properly</span></span>
<span id="lst-weakptr-30"><a href="#lst-weakptr-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="co">// a0 b0</span></span>
<span id="lst-weakptr-31"><a href="#lst-weakptr-31" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="arena-分配器" class="level4">
<h4 class="anchored" data-anchor-id="arena-分配器">Arena 分配器</h4>
<p>TODO</p>
</section>
</section>
<section id="class-类" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="class-类">Class 类</h3>
<section id="constructor-init-list-构造函数与初始化列表" class="level4">
<h4 class="anchored" data-anchor-id="constructor-init-list-构造函数与初始化列表">Constructor, Init List 构造函数与初始化列表</h4>
<ul>
<li><p><strong>Constructor 构造函数</strong>: 相当于 <code>Python</code> 里的 <code>__init__</code> 方法. 每次创建对象时会被调用.</p>
<ul>
<li><p>可以有多个 Constructor (根据初始化时所带参数数量和类型自动调用, 也是<strong>多态</strong>的一种体现). 名字必须直接用类名: <code>ClassName()</code>.</p>
<ul>
<li>也支持 <strong>Default Arguments 默认参数</strong>: <code>ClassName(int w = 1)</code> 意思是如果创建对象时没传参数 <code>w</code> 就等于 <code>1</code>.</li>
</ul></li>
<li><p>如果没写则编译器默认会生成一个效果跟下面一样的构造函数:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>ClassName<span class="op">()</span> <span class="op">{}</span> <span class="co">// Default constructor</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Or</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>ClassName<span class="op">()</span> <span class="op">=</span> <span class="cf">default</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>建议显式写出默认构造函数, 以防止别人以为你忘了写.</p></li>
</ul></li>
<li><p><strong>Destructor 析构函数</strong>: 相当于 <code>Python</code> 里的 <code>__del__</code> 方法. 每次对象被销毁时会被调用. 名字是 <code>~ClassName()</code>.</p></li>
<li><p><strong>Constructor member initializer list</strong>: 用于在 Constructor 体<strong>执行前</strong>初始化成员变量 (用 <code>:</code> 引出). 那跟放在 Constructor 体里初始化有什么区别呢?</p>
<ul>
<li><code>C++</code> 规定: <strong>所有成员对象, 必须在进入构造函数体之前完成构造</strong>, 比如 #lst-constructorcpp 中进入 <code>Big(int in) {...}</code> 之前就必须构造出 <code>small</code>, 那只能调用 <code>Small</code> 的默认构造方法 <code>Small()</code>. 所以 <code>1</code> 先被打印.</li>
</ul></li>
</ul>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>constructor.cpp</strong></pre>
</div>
<div class="sourceCode" id="lst-constructorcpp" data-filename="constructor.cpp"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-constructorcpp-1"><a href="#lst-constructorcpp-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="lst-constructorcpp-2"><a href="#lst-constructorcpp-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> std<span class="op">;</span></span>
<span id="lst-constructorcpp-3"><a href="#lst-constructorcpp-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-constructorcpp-4"><a href="#lst-constructorcpp-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Small </span>
<span id="lst-constructorcpp-5"><a href="#lst-constructorcpp-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="lst-constructorcpp-6"><a href="#lst-constructorcpp-6" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="lst-constructorcpp-7"><a href="#lst-constructorcpp-7" aria-hidden="true" tabindex="-1"></a>    Small<span class="op">()</span></span>
<span id="lst-constructorcpp-8"><a href="#lst-constructorcpp-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="lst-constructorcpp-9"><a href="#lst-constructorcpp-9" aria-hidden="true" tabindex="-1"></a>        cout <span class="op">&lt;&lt;</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> endl<span class="op">;</span></span>
<span id="lst-constructorcpp-10"><a href="#lst-constructorcpp-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-constructorcpp-11"><a href="#lst-constructorcpp-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-constructorcpp-12"><a href="#lst-constructorcpp-12" aria-hidden="true" tabindex="-1"></a>    Small<span class="op">(</span><span class="dt">int</span> in<span class="op">)</span></span>
<span id="lst-constructorcpp-13"><a href="#lst-constructorcpp-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="lst-constructorcpp-14"><a href="#lst-constructorcpp-14" aria-hidden="true" tabindex="-1"></a>        cout <span class="op">&lt;&lt;</span> <span class="dv">2</span> <span class="op">&lt;&lt;</span> endl<span class="op">;</span></span>
<span id="lst-constructorcpp-15"><a href="#lst-constructorcpp-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-constructorcpp-16"><a href="#lst-constructorcpp-16" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-constructorcpp-17"><a href="#lst-constructorcpp-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-constructorcpp-18"><a href="#lst-constructorcpp-18" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Big</span>
<span id="lst-constructorcpp-19"><a href="#lst-constructorcpp-19" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="lst-constructorcpp-20"><a href="#lst-constructorcpp-20" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="lst-constructorcpp-21"><a href="#lst-constructorcpp-21" aria-hidden="true" tabindex="-1"></a>    Small small<span class="op">;</span></span>
<span id="lst-constructorcpp-22"><a href="#lst-constructorcpp-22" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="lst-constructorcpp-23"><a href="#lst-constructorcpp-23" aria-hidden="true" tabindex="-1"></a>    Big<span class="op">(</span><span class="dt">int</span> in<span class="op">)</span></span>
<span id="lst-constructorcpp-24"><a href="#lst-constructorcpp-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="lst-constructorcpp-25"><a href="#lst-constructorcpp-25" aria-hidden="true" tabindex="-1"></a>        small <span class="op">=</span> Small<span class="op">(</span>in<span class="op">);</span></span>
<span id="lst-constructorcpp-26"><a href="#lst-constructorcpp-26" aria-hidden="true" tabindex="-1"></a>        cout <span class="op">&lt;&lt;</span> <span class="dv">3</span> <span class="op">&lt;&lt;</span> endl<span class="op">;</span> </span>
<span id="lst-constructorcpp-27"><a href="#lst-constructorcpp-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-constructorcpp-28"><a href="#lst-constructorcpp-28" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-constructorcpp-29"><a href="#lst-constructorcpp-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-constructorcpp-30"><a href="#lst-constructorcpp-30" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="lst-constructorcpp-31"><a href="#lst-constructorcpp-31" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="lst-constructorcpp-32"><a href="#lst-constructorcpp-32" aria-hidden="true" tabindex="-1"></a>    Big big<span class="op">(</span><span class="dv">7</span><span class="op">);</span> <span class="co">// Output: 1 2 3</span></span>
<span id="lst-constructorcpp-33"><a href="#lst-constructorcpp-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="lst-constructorcpp-34"><a href="#lst-constructorcpp-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-constructorcpp-35"><a href="#lst-constructorcpp-35" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>constructor_init.cpp</strong></pre>
</div>
<div class="sourceCode" id="lst-constructorinitcpp" data-filename="constructor_init.cpp"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-constructorinitcpp-1"><a href="#lst-constructorinitcpp-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="lst-constructorinitcpp-2"><a href="#lst-constructorinitcpp-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> std<span class="op">;</span></span>
<span id="lst-constructorinitcpp-3"><a href="#lst-constructorinitcpp-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-constructorinitcpp-4"><a href="#lst-constructorinitcpp-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Small </span>
<span id="lst-constructorinitcpp-5"><a href="#lst-constructorinitcpp-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="lst-constructorinitcpp-6"><a href="#lst-constructorinitcpp-6" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="lst-constructorinitcpp-7"><a href="#lst-constructorinitcpp-7" aria-hidden="true" tabindex="-1"></a>    Small<span class="op">()</span></span>
<span id="lst-constructorinitcpp-8"><a href="#lst-constructorinitcpp-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="lst-constructorinitcpp-9"><a href="#lst-constructorinitcpp-9" aria-hidden="true" tabindex="-1"></a>        cout <span class="op">&lt;&lt;</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> endl<span class="op">;</span></span>
<span id="lst-constructorinitcpp-10"><a href="#lst-constructorinitcpp-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-constructorinitcpp-11"><a href="#lst-constructorinitcpp-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-constructorinitcpp-12"><a href="#lst-constructorinitcpp-12" aria-hidden="true" tabindex="-1"></a>    Small<span class="op">(</span><span class="dt">int</span> in<span class="op">)</span></span>
<span id="lst-constructorinitcpp-13"><a href="#lst-constructorinitcpp-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="lst-constructorinitcpp-14"><a href="#lst-constructorinitcpp-14" aria-hidden="true" tabindex="-1"></a>        cout <span class="op">&lt;&lt;</span> <span class="dv">2</span> <span class="op">&lt;&lt;</span> endl<span class="op">;</span></span>
<span id="lst-constructorinitcpp-15"><a href="#lst-constructorinitcpp-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-constructorinitcpp-16"><a href="#lst-constructorinitcpp-16" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-constructorinitcpp-17"><a href="#lst-constructorinitcpp-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-constructorinitcpp-18"><a href="#lst-constructorinitcpp-18" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Big</span>
<span id="lst-constructorinitcpp-19"><a href="#lst-constructorinitcpp-19" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="lst-constructorinitcpp-20"><a href="#lst-constructorinitcpp-20" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="lst-constructorinitcpp-21"><a href="#lst-constructorinitcpp-21" aria-hidden="true" tabindex="-1"></a>    Small small<span class="op">;</span></span>
<span id="lst-constructorinitcpp-22"><a href="#lst-constructorinitcpp-22" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="lst-constructorinitcpp-23"><a href="#lst-constructorinitcpp-23" aria-hidden="true" tabindex="-1"></a>    Big<span class="op">(</span><span class="dt">int</span> in<span class="op">)</span> </span>
<span id="lst-constructorinitcpp-24"><a href="#lst-constructorinitcpp-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span> small<span class="op">(</span>in<span class="op">)</span></span>
<span id="lst-constructorinitcpp-25"><a href="#lst-constructorinitcpp-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="lst-constructorinitcpp-26"><a href="#lst-constructorinitcpp-26" aria-hidden="true" tabindex="-1"></a>        cout <span class="op">&lt;&lt;</span> <span class="dv">3</span> <span class="op">&lt;&lt;</span> endl<span class="op">;</span> </span>
<span id="lst-constructorinitcpp-27"><a href="#lst-constructorinitcpp-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-constructorinitcpp-28"><a href="#lst-constructorinitcpp-28" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-constructorinitcpp-29"><a href="#lst-constructorinitcpp-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-constructorinitcpp-30"><a href="#lst-constructorinitcpp-30" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="lst-constructorinitcpp-31"><a href="#lst-constructorinitcpp-31" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="lst-constructorinitcpp-32"><a href="#lst-constructorinitcpp-32" aria-hidden="true" tabindex="-1"></a>    Big big<span class="op">(</span><span class="dv">7</span><span class="op">);</span> <span class="co">// Output: 2 3</span></span>
<span id="lst-constructorinitcpp-33"><a href="#lst-constructorinitcpp-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="lst-constructorinitcpp-34"><a href="#lst-constructorinitcpp-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-constructorinitcpp-35"><a href="#lst-constructorinitcpp-35" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="this-指针" class="level4">
<h4 class="anchored" data-anchor-id="this-指针"><code>this</code> 指针</h4>
<p>就是 <code>Python</code> 里的 <code>self</code> (当前对象的地址):</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> A <span class="op">{</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> x<span class="op">;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> setX<span class="op">(</span><span class="dt">int</span> x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">-&gt;</span>x <span class="op">=</span> x<span class="op">;</span>   <span class="co">// Left: member variable; Right: parameter</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="类继承" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="类继承">类继承</h4>
<ul>
<li>下面代码表示 <code>class A</code> 继承 <code>class B</code> (记作 “A is-a B”).
<ul>
<li><code>public</code> 表示<strong>公开继承</strong>, 即 <code>B</code> 的 <code>public</code> 和 <code>protected</code> 成员在 <code>A</code> 里依然是 <code>public</code> 和 <code>protected</code><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> A <span class="op">:</span> <span class="kw">public</span> B</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;<code>protected</code> 和 <code>private</code> 区别: 前者代表本类和子类可以访问, 后者只能本类访问 (子类不行).</p></div></div></section>
<section id="friend-关键字" class="level4">
<h4 class="anchored" data-anchor-id="friend-关键字"><code>friend</code> 关键字</h4>
<p>在一个类里面声明另一个类 (或函数) 为 <code>friend</code>, 表示同意它访问自己的 <code>private</code> 和 <code>protected</code> 成员 (注意是谁访问谁的私有成员!):</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>friend.cpp</strong></pre>
</div>
<div class="sourceCode" id="lst-friendcpp" data-filename="friend.cpp"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-friendcpp-1"><a href="#lst-friendcpp-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="lst-friendcpp-2"><a href="#lst-friendcpp-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-friendcpp-3"><a href="#lst-friendcpp-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> B<span class="op">;</span>  <span class="co">// Tell compiler that B exists</span></span>
<span id="lst-friendcpp-4"><a href="#lst-friendcpp-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-friendcpp-5"><a href="#lst-friendcpp-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> A <span class="op">{</span></span>
<span id="lst-friendcpp-6"><a href="#lst-friendcpp-6" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="lst-friendcpp-7"><a href="#lst-friendcpp-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> secret <span class="op">=</span> <span class="dv">7</span><span class="op">;</span></span>
<span id="lst-friendcpp-8"><a href="#lst-friendcpp-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-friendcpp-9"><a href="#lst-friendcpp-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">friend</span> <span class="kw">class</span> B<span class="op">;</span> <span class="co">// B is an intimate friend of A</span></span>
<span id="lst-friendcpp-10"><a href="#lst-friendcpp-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// friend B;    // Alternative</span></span>
<span id="lst-friendcpp-11"><a href="#lst-friendcpp-11" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-friendcpp-12"><a href="#lst-friendcpp-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-friendcpp-13"><a href="#lst-friendcpp-13" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> B <span class="op">{</span></span>
<span id="lst-friendcpp-14"><a href="#lst-friendcpp-14" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="lst-friendcpp-15"><a href="#lst-friendcpp-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> reveal<span class="op">(</span>A<span class="op">&amp;</span> a<span class="op">)</span> <span class="op">{</span></span>
<span id="lst-friendcpp-16"><a href="#lst-friendcpp-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> a<span class="op">.</span>secret <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="lst-friendcpp-17"><a href="#lst-friendcpp-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-friendcpp-18"><a href="#lst-friendcpp-18" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-friendcpp-19"><a href="#lst-friendcpp-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-friendcpp-20"><a href="#lst-friendcpp-20" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="lst-friendcpp-21"><a href="#lst-friendcpp-21" aria-hidden="true" tabindex="-1"></a>    A a<span class="op">;</span></span>
<span id="lst-friendcpp-22"><a href="#lst-friendcpp-22" aria-hidden="true" tabindex="-1"></a>    B b<span class="op">;</span></span>
<span id="lst-friendcpp-23"><a href="#lst-friendcpp-23" aria-hidden="true" tabindex="-1"></a>    b<span class="op">.</span>reveal<span class="op">(</span>a<span class="op">);</span> <span class="co">// Outputs: 7</span></span>
<span id="lst-friendcpp-24"><a href="#lst-friendcpp-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="lst-friendcpp-25"><a href="#lst-friendcpp-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-friendcpp-26"><a href="#lst-friendcpp-26" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="alias-别名" class="level3">
<h3 class="anchored" data-anchor-id="alias-别名">Alias 别名</h3>
<section id="reference-引用" class="level4">
<h4 class="anchored" data-anchor-id="reference-引用">Reference 引用</h4>
<ul>
<li>Reference 仅仅是 Syntax sugar!</li>
<li>必须初始化. <code>int&amp; ref;</code> 是错误的.</li>
<li><code>int&amp; ref = a;</code> 在编译时不会出现 <code>ref</code> 这个变量, 它只是 <code>a</code> 的别名 (alias).</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>change_val_ref.cpp</strong></pre>
</div>
<div class="sourceCode" id="lst-changevalrefcpp" data-filename="change_val_ref.cpp"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-changevalrefcpp-1"><a href="#lst-changevalrefcpp-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="lst-changevalrefcpp-2"><a href="#lst-changevalrefcpp-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="lst-changevalrefcpp-3"><a href="#lst-changevalrefcpp-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="lst-changevalrefcpp-4"><a href="#lst-changevalrefcpp-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> a <span class="op">=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="lst-changevalrefcpp-5"><a href="#lst-changevalrefcpp-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span><span class="op">&amp;</span> ref <span class="op">=</span> a<span class="op">;</span> <span class="co">// ref is an alias to a</span></span>
<span id="lst-changevalrefcpp-6"><a href="#lst-changevalrefcpp-6" aria-hidden="true" tabindex="-1"></a>    ref <span class="op">=</span> <span class="dv">10</span><span class="op">;</span>     <span class="co">// Actually modifies a</span></span>
<span id="lst-changevalrefcpp-7"><a href="#lst-changevalrefcpp-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">"a = "</span> <span class="op">&lt;&lt;</span> a <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span> <span class="co">// Outputs: a = 10</span></span>
<span id="lst-changevalrefcpp-8"><a href="#lst-changevalrefcpp-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="lst-changevalrefcpp-9"><a href="#lst-changevalrefcpp-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-changevalrefcpp-10"><a href="#lst-changevalrefcpp-10" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>increment_val_ref.cpp</strong></pre>
</div>
<div class="sourceCode" id="lst-incrementvalrefcpp" data-filename="increment_val_ref.cpp"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-incrementvalrefcpp-1"><a href="#lst-incrementvalrefcpp-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="lst-incrementvalrefcpp-2"><a href="#lst-incrementvalrefcpp-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> increment<span class="op">(</span><span class="dt">int</span><span class="op">&amp;</span> num<span class="op">)</span> <span class="op">{</span>num<span class="op">++;}</span></span>
<span id="lst-incrementvalrefcpp-3"><a href="#lst-incrementvalrefcpp-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="lst-incrementvalrefcpp-4"><a href="#lst-incrementvalrefcpp-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="lst-incrementvalrefcpp-5"><a href="#lst-incrementvalrefcpp-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> value <span class="op">=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="lst-incrementvalrefcpp-6"><a href="#lst-incrementvalrefcpp-6" aria-hidden="true" tabindex="-1"></a>    increment<span class="op">(</span>value<span class="op">);</span> <span class="co">// Pass by reference</span></span>
<span id="lst-incrementvalrefcpp-7"><a href="#lst-incrementvalrefcpp-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">"value = "</span> <span class="op">&lt;&lt;</span> value <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span> <span class="co">// Outputs: value = 6</span></span>
<span id="lst-incrementvalrefcpp-8"><a href="#lst-incrementvalrefcpp-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="lst-incrementvalrefcpp-9"><a href="#lst-incrementvalrefcpp-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-incrementvalrefcpp-10"><a href="#lst-incrementvalrefcpp-10" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="typedef-和-using-关键字" class="level4">
<h4 class="anchored" data-anchor-id="typedef-和-using-关键字"><code>typedef</code> 和 <code>using</code> 关键字</h4>
<p>下面两个都是给复杂类型 <code>std::vector&lt;int&gt;</code> 起好听一点的名字 <code>IntList</code>, 效果一样:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> IntList <span class="op">=</span> <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> IntList<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="polymorphism-多态" class="level3">
<h3 class="anchored" data-anchor-id="polymorphism-多态">Polymorphism 多态</h3>
<blockquote class="blockquote">
<p>多态: 同一个接口用于不同的数据类型. 这是 OOP 的重要特性之一. 分为:</p>
</blockquote>
<ul>
<li>编译时多态: <strong>函数重载</strong>、<strong>运算符重载</strong>.</li>
<li>运行时多态: <strong>虚函数</strong>、<strong>纯虚函数</strong>.</li>
</ul>
<section id="函数重载" class="level4">
<h4 class="anchored" data-anchor-id="函数重载">函数重载</h4>
<ul>
<li>如果你需要让很多同名的函数支持不同类型或数量的参数, 可以把他们放进一个 class 里面, 因为 class 支持<strong>函数重载</strong>:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>overload_function.cpp</strong></pre>
</div>
<div class="sourceCode" id="lst-overloadfunctioncpp" data-filename="overload_function.cpp"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-overloadfunctioncpp-1"><a href="#lst-overloadfunctioncpp-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="lst-overloadfunctioncpp-2"><a href="#lst-overloadfunctioncpp-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-overloadfunctioncpp-3"><a href="#lst-overloadfunctioncpp-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Print <span class="op">{</span></span>
<span id="lst-overloadfunctioncpp-4"><a href="#lst-overloadfunctioncpp-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="lst-overloadfunctioncpp-5"><a href="#lst-overloadfunctioncpp-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> show<span class="op">(</span><span class="dt">int</span> i<span class="op">)</span> <span class="op">{</span></span>
<span id="lst-overloadfunctioncpp-6"><a href="#lst-overloadfunctioncpp-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">"Integer: "</span> <span class="op">&lt;&lt;</span> i <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="lst-overloadfunctioncpp-7"><a href="#lst-overloadfunctioncpp-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-overloadfunctioncpp-8"><a href="#lst-overloadfunctioncpp-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-overloadfunctioncpp-9"><a href="#lst-overloadfunctioncpp-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> show<span class="op">(</span><span class="dt">double</span> d<span class="op">)</span> <span class="op">{</span></span>
<span id="lst-overloadfunctioncpp-10"><a href="#lst-overloadfunctioncpp-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">"Double: "</span> <span class="op">&lt;&lt;</span> d <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="lst-overloadfunctioncpp-11"><a href="#lst-overloadfunctioncpp-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-overloadfunctioncpp-12"><a href="#lst-overloadfunctioncpp-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-overloadfunctioncpp-13"><a href="#lst-overloadfunctioncpp-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> show<span class="op">(</span><span class="at">const</span> <span class="bu">std::</span>string<span class="op">&amp;</span> s<span class="op">)</span> <span class="op">{</span></span>
<span id="lst-overloadfunctioncpp-14"><a href="#lst-overloadfunctioncpp-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">"String: "</span> <span class="op">&lt;&lt;</span> s <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="lst-overloadfunctioncpp-15"><a href="#lst-overloadfunctioncpp-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-overloadfunctioncpp-16"><a href="#lst-overloadfunctioncpp-16" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-overloadfunctioncpp-17"><a href="#lst-overloadfunctioncpp-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-overloadfunctioncpp-18"><a href="#lst-overloadfunctioncpp-18" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="lst-overloadfunctioncpp-19"><a href="#lst-overloadfunctioncpp-19" aria-hidden="true" tabindex="-1"></a>    Print p<span class="op">;</span></span>
<span id="lst-overloadfunctioncpp-20"><a href="#lst-overloadfunctioncpp-20" aria-hidden="true" tabindex="-1"></a>    p<span class="op">.</span>show<span class="op">(</span><span class="dv">5</span><span class="op">);</span>          <span class="co">// 输出: Integer: 5</span></span>
<span id="lst-overloadfunctioncpp-21"><a href="#lst-overloadfunctioncpp-21" aria-hidden="true" tabindex="-1"></a>    p<span class="op">.</span>show<span class="op">(</span><span class="fl">3.14</span><span class="op">);</span>       <span class="co">// 输出: Double: 3.14</span></span>
<span id="lst-overloadfunctioncpp-22"><a href="#lst-overloadfunctioncpp-22" aria-hidden="true" tabindex="-1"></a>    p<span class="op">.</span>show<span class="op">(</span><span class="st">"Hello"</span><span class="op">);</span>    <span class="co">// 输出: String: Hello</span></span>
<span id="lst-overloadfunctioncpp-23"><a href="#lst-overloadfunctioncpp-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-overloadfunctioncpp-24"><a href="#lst-overloadfunctioncpp-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="lst-overloadfunctioncpp-25"><a href="#lst-overloadfunctioncpp-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-overloadfunctioncpp-26"><a href="#lst-overloadfunctioncpp-26" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="运算符重载" class="level4">
<h4 class="anchored" data-anchor-id="运算符重载">运算符重载</h4>
<ul>
<li>运算符重载使得 <code>+</code>, <code>*</code> 这些运算符可以用于自定义 class 之间的运算 (而不仅限于 <code>int</code>, <code>float</code> 等).</li>
<li><code>Python</code> 里面也有 <code>__add__</code> 这种魔法方法实现重载.</li>
<li>重载是不好的编程习惯! 但在写 API 的时候要提供重载和非重载两种接口供开发者使用 (比如下面的 <code>Add()</code> 和 <code>operator+()</code> 方法), 定义的时候可以用重载定义非重载, 也可以反过来:</li>
</ul>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>overload_op_calls_method.cpp</strong></pre>
</div>
<div class="sourceCode" id="lst-overload_op_calls_methodcpp" data-filename="overload_op_calls_method.cpp"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-overload_op_calls_methodcpp-1"><a href="#lst-overload_op_calls_methodcpp-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Point</span>
<span id="lst-overload_op_calls_methodcpp-2"><a href="#lst-overload_op_calls_methodcpp-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="lst-overload_op_calls_methodcpp-3"><a href="#lst-overload_op_calls_methodcpp-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="lst-overload_op_calls_methodcpp-4"><a href="#lst-overload_op_calls_methodcpp-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> x<span class="op">,</span> y<span class="op">;</span></span>
<span id="lst-overload_op_calls_methodcpp-5"><a href="#lst-overload_op_calls_methodcpp-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-overload_op_calls_methodcpp-6"><a href="#lst-overload_op_calls_methodcpp-6" aria-hidden="true" tabindex="-1"></a>    Point<span class="op">(</span><span class="dt">double</span> x_coor<span class="op">,</span> <span class="dt">double</span> y_coor<span class="op">)</span></span>
<span id="lst-overload_op_calls_methodcpp-7"><a href="#lst-overload_op_calls_methodcpp-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span> x<span class="op">(</span>x_coor<span class="op">),</span> y<span class="op">(</span>y_coor<span class="op">)</span> <span class="op">{}</span></span>
<span id="lst-overload_op_calls_methodcpp-8"><a href="#lst-overload_op_calls_methodcpp-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-overload_op_calls_methodcpp-9"><a href="#lst-overload_op_calls_methodcpp-9" aria-hidden="true" tabindex="-1"></a>    Point Add<span class="op">(</span><span class="at">const</span> Point<span class="op">&amp;</span> other<span class="op">)</span> <span class="at">const</span></span>
<span id="lst-overload_op_calls_methodcpp-10"><a href="#lst-overload_op_calls_methodcpp-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="lst-overload_op_calls_methodcpp-11"><a href="#lst-overload_op_calls_methodcpp-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Point<span class="op">(</span>x <span class="op">+</span> other<span class="op">.</span>x<span class="op">,</span> y <span class="op">+</span> other<span class="op">.</span>y<span class="op">);</span></span>
<span id="lst-overload_op_calls_methodcpp-12"><a href="#lst-overload_op_calls_methodcpp-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-overload_op_calls_methodcpp-13"><a href="#lst-overload_op_calls_methodcpp-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-overload_op_calls_methodcpp-14"><a href="#lst-overload_op_calls_methodcpp-14" aria-hidden="true" tabindex="-1"></a>    Point <span class="kw">operator</span><span class="op">+(</span><span class="at">const</span> Point<span class="op">&amp;</span> other<span class="op">)</span> <span class="at">const</span></span>
<span id="lst-overload_op_calls_methodcpp-15"><a href="#lst-overload_op_calls_methodcpp-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="lst-overload_op_calls_methodcpp-16"><a href="#lst-overload_op_calls_methodcpp-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Add<span class="op">(</span>other<span class="op">);</span></span>
<span id="lst-overload_op_calls_methodcpp-17"><a href="#lst-overload_op_calls_methodcpp-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-overload_op_calls_methodcpp-18"><a href="#lst-overload_op_calls_methodcpp-18" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-overload_op_calls_methodcpp-19"><a href="#lst-overload_op_calls_methodcpp-19" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>overload_method_calls_op.cpp</strong></pre>
</div>
<div class="sourceCode" id="lst-overload_method_calls_opcpp" data-filename="overload_method_calls_op.cpp"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-overload_method_calls_opcpp-1"><a href="#lst-overload_method_calls_opcpp-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Point</span>
<span id="lst-overload_method_calls_opcpp-2"><a href="#lst-overload_method_calls_opcpp-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="lst-overload_method_calls_opcpp-3"><a href="#lst-overload_method_calls_opcpp-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="lst-overload_method_calls_opcpp-4"><a href="#lst-overload_method_calls_opcpp-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> x<span class="op">,</span> y<span class="op">;</span></span>
<span id="lst-overload_method_calls_opcpp-5"><a href="#lst-overload_method_calls_opcpp-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-overload_method_calls_opcpp-6"><a href="#lst-overload_method_calls_opcpp-6" aria-hidden="true" tabindex="-1"></a>    Point<span class="op">(</span><span class="dt">double</span> x_coor<span class="op">,</span> <span class="dt">double</span> y_coor<span class="op">)</span></span>
<span id="lst-overload_method_calls_opcpp-7"><a href="#lst-overload_method_calls_opcpp-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span> x<span class="op">(</span>x_coor<span class="op">),</span> y<span class="op">(</span>y_coor<span class="op">)</span> <span class="op">{}</span></span>
<span id="lst-overload_method_calls_opcpp-8"><a href="#lst-overload_method_calls_opcpp-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-overload_method_calls_opcpp-9"><a href="#lst-overload_method_calls_opcpp-9" aria-hidden="true" tabindex="-1"></a>    Point Add<span class="op">(</span><span class="at">const</span> Point<span class="op">&amp;</span> other<span class="op">)</span> <span class="at">const</span></span>
<span id="lst-overload_method_calls_opcpp-10"><a href="#lst-overload_method_calls_opcpp-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="lst-overload_method_calls_opcpp-11"><a href="#lst-overload_method_calls_opcpp-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">*</span><span class="kw">this</span> <span class="op">+</span> other<span class="op">;</span></span>
<span id="lst-overload_method_calls_opcpp-12"><a href="#lst-overload_method_calls_opcpp-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-overload_method_calls_opcpp-13"><a href="#lst-overload_method_calls_opcpp-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-overload_method_calls_opcpp-14"><a href="#lst-overload_method_calls_opcpp-14" aria-hidden="true" tabindex="-1"></a>    Point <span class="kw">operator</span><span class="op">+(</span><span class="at">const</span> Point<span class="op">&amp;</span> other<span class="op">)</span> <span class="at">const</span></span>
<span id="lst-overload_method_calls_opcpp-15"><a href="#lst-overload_method_calls_opcpp-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="lst-overload_method_calls_opcpp-16"><a href="#lst-overload_method_calls_opcpp-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Point<span class="op">(</span>x <span class="op">+</span> other<span class="op">.</span>x<span class="op">,</span> y <span class="op">+</span> other<span class="op">.</span>y<span class="op">);</span></span>
<span id="lst-overload_method_calls_opcpp-17"><a href="#lst-overload_method_calls_opcpp-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-overload_method_calls_opcpp-18"><a href="#lst-overload_method_calls_opcpp-18" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-overload_method_calls_opcpp-19"><a href="#lst-overload_method_calls_opcpp-19" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>这样就可以直接这样来将两个 <code>Point</code> 对象相加:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>overload_main.cpp</strong></pre>
</div>
<div class="sourceCode" id="lst-overloadmaincpp" data-filename="overload_main.cpp"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-overloadmaincpp-1"><a href="#lst-overloadmaincpp-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="lst-overloadmaincpp-2"><a href="#lst-overloadmaincpp-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"overload_op_calls_method.cpp"</span></span>
<span id="lst-overloadmaincpp-3"><a href="#lst-overloadmaincpp-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-overloadmaincpp-4"><a href="#lst-overloadmaincpp-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="lst-overloadmaincpp-5"><a href="#lst-overloadmaincpp-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="lst-overloadmaincpp-6"><a href="#lst-overloadmaincpp-6" aria-hidden="true" tabindex="-1"></a>    Point p1<span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">2.0</span><span class="op">);</span></span>
<span id="lst-overloadmaincpp-7"><a href="#lst-overloadmaincpp-7" aria-hidden="true" tabindex="-1"></a>    Point p2<span class="op">(</span><span class="fl">3.0</span><span class="op">,</span> <span class="fl">4.0</span><span class="op">);</span></span>
<span id="lst-overloadmaincpp-8"><a href="#lst-overloadmaincpp-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-overloadmaincpp-9"><a href="#lst-overloadmaincpp-9" aria-hidden="true" tabindex="-1"></a>    Point p3 <span class="op">=</span> p1 <span class="op">+</span> p2<span class="op">;</span>  <span class="co">// i.e., p3 = p1.operator+(p2);</span></span>
<span id="lst-overloadmaincpp-10"><a href="#lst-overloadmaincpp-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">"p3: ("</span> <span class="op">&lt;&lt;</span> p3<span class="op">.</span>x <span class="op">&lt;&lt;</span> <span class="st">", "</span> <span class="op">&lt;&lt;</span> p3<span class="op">.</span>y <span class="op">&lt;&lt;</span> <span class="st">")</span><span class="sc">\n</span><span class="st">"</span><span class="op">;</span> <span class="co">// p3: (4, 6)</span></span>
<span id="lst-overloadmaincpp-11"><a href="#lst-overloadmaincpp-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-overloadmaincpp-12"><a href="#lst-overloadmaincpp-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="lst-overloadmaincpp-13"><a href="#lst-overloadmaincpp-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-overloadmaincpp-14"><a href="#lst-overloadmaincpp-14" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="虚函数" class="level4">
<h4 class="anchored" data-anchor-id="虚函数">虚函数</h4>
<ul>
<li>我们想用同一个函数 <code>print_res()</code> 来打印 <code>A</code> 类和 <code>B</code> 类 (derived from <code>A</code>) <strong>各自</strong>的 <code>forward()</code> 结果, 我们在 C++ 和 Python 里实现它们. 发现虽然两种语言 <code>print_res()</code> 定义时规定参数类型都是 <code>A*</code>, Python 就很聪明, 成功调用了各自的 <code>forward()</code> 方法; 而 C++ 却都用的是 <code>A</code> 类的 <code>forward()</code> 方法 (这不是我们所期望的).</li>
</ul>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>virtual.cc</strong></pre>
</div>
<div class="sourceCode" id="lst-virtualcc" data-filename="virtual.cc"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-virtualcc-1"><a href="#lst-virtualcc-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="lst-virtualcc-2"><a href="#lst-virtualcc-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> std<span class="op">;</span> <span class="co">// bad habits</span></span>
<span id="lst-virtualcc-3"><a href="#lst-virtualcc-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-virtualcc-4"><a href="#lst-virtualcc-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> A <span class="op">{</span></span>
<span id="lst-virtualcc-5"><a href="#lst-virtualcc-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="lst-virtualcc-6"><a href="#lst-virtualcc-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> forward<span class="op">(</span><span class="dt">int</span> x<span class="op">)</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="lst-virtualcc-7"><a href="#lst-virtualcc-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x<span class="op">;</span></span>
<span id="lst-virtualcc-8"><a href="#lst-virtualcc-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-virtualcc-9"><a href="#lst-virtualcc-9" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-virtualcc-10"><a href="#lst-virtualcc-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-virtualcc-11"><a href="#lst-virtualcc-11" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> B <span class="op">:</span> <span class="kw">public</span> A <span class="op">{</span></span>
<span id="lst-virtualcc-12"><a href="#lst-virtualcc-12" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="lst-virtualcc-13"><a href="#lst-virtualcc-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> forward<span class="op">(</span><span class="dt">int</span> x<span class="op">)</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="lst-virtualcc-14"><a href="#lst-virtualcc-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">2</span><span class="op">*</span>x<span class="op">;</span></span>
<span id="lst-virtualcc-15"><a href="#lst-virtualcc-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-virtualcc-16"><a href="#lst-virtualcc-16" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-virtualcc-17"><a href="#lst-virtualcc-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-virtualcc-18"><a href="#lst-virtualcc-18" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> print_res<span class="op">(</span><span class="at">const</span> A<span class="op">*</span> model<span class="op">,</span> <span class="dt">int</span> x<span class="op">)</span> <span class="op">{</span></span>
<span id="lst-virtualcc-19"><a href="#lst-virtualcc-19" aria-hidden="true" tabindex="-1"></a>    cout <span class="op">&lt;&lt;</span> model<span class="op">-&gt;</span>forward<span class="op">(</span>x<span class="op">)</span> <span class="op">&lt;&lt;</span> endl<span class="op">;</span></span>
<span id="lst-virtualcc-20"><a href="#lst-virtualcc-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-virtualcc-21"><a href="#lst-virtualcc-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-virtualcc-22"><a href="#lst-virtualcc-22" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="lst-virtualcc-23"><a href="#lst-virtualcc-23" aria-hidden="true" tabindex="-1"></a>    B<span class="op">*</span> m <span class="op">=</span> <span class="kw">new</span> B<span class="op">();</span></span>
<span id="lst-virtualcc-24"><a href="#lst-virtualcc-24" aria-hidden="true" tabindex="-1"></a>    print_res<span class="op">(</span>m<span class="op">,</span> <span class="dv">3</span><span class="op">);</span> <span class="co">// 3</span></span>
<span id="lst-virtualcc-25"><a href="#lst-virtualcc-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">delete</span> m<span class="op">;</span></span>
<span id="lst-virtualcc-26"><a href="#lst-virtualcc-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-virtualcc-27"><a href="#lst-virtualcc-27" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>virtual.py</strong></pre>
</div>
<div class="sourceCode" id="lst-virtualpy" data-filename="virtual.py"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-virtualpy-1"><a href="#lst-virtualpy-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> A<span class="op">:</span></span>
<span id="lst-virtualpy-2"><a href="#lst-virtualpy-2" aria-hidden="true" tabindex="-1"></a>    def forward<span class="op">(</span>self<span class="op">,</span> x<span class="op">):</span></span>
<span id="lst-virtualpy-3"><a href="#lst-virtualpy-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="lst-virtualpy-4"><a href="#lst-virtualpy-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-virtualpy-5"><a href="#lst-virtualpy-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> B<span class="op">(</span>A<span class="op">):</span></span>
<span id="lst-virtualpy-6"><a href="#lst-virtualpy-6" aria-hidden="true" tabindex="-1"></a>    def forward<span class="op">(</span>self<span class="op">,</span> x<span class="op">):</span></span>
<span id="lst-virtualpy-7"><a href="#lst-virtualpy-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">2</span> <span class="op">*</span> x</span>
<span id="lst-virtualpy-8"><a href="#lst-virtualpy-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-virtualpy-9"><a href="#lst-virtualpy-9" aria-hidden="true" tabindex="-1"></a>def print_res<span class="op">(</span>model<span class="op">:</span> A<span class="op">,</span> x<span class="op">:</span> <span class="dt">int</span><span class="op">):</span></span>
<span id="lst-virtualpy-10"><a href="#lst-virtualpy-10" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span>model<span class="op">.</span>forward<span class="op">(</span>x<span class="op">))</span></span>
<span id="lst-virtualpy-11"><a href="#lst-virtualpy-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-virtualpy-12"><a href="#lst-virtualpy-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> __name__ <span class="op">==</span> <span class="st">"__main__"</span><span class="op">:</span></span>
<span id="lst-virtualpy-13"><a href="#lst-virtualpy-13" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> B<span class="op">()</span></span>
<span id="lst-virtualpy-14"><a href="#lst-virtualpy-14" aria-hidden="true" tabindex="-1"></a>    print_res<span class="op">(</span>m<span class="op">,</span> <span class="dv">3</span><span class="op">)</span>  <span class="er"># 6</span></span>
<span id="lst-virtualpy-15"><a href="#lst-virtualpy-15" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<ul>
<li><p>为了使得子类的方法能够覆盖 (override) 父类的方法, 我们需要在<strong>父类</strong>的方法前加上 <code>virtual</code>, 子类的函数体前加上 <code>override</code> (也可以不加).</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> A <span class="op">{</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">virtual</span> <span class="dt">int</span> forward<span class="op">(</span><span class="dt">int</span> x<span class="op">)</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x<span class="op">;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> B <span class="op">:</span> <span class="kw">public</span> A <span class="op">{</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> forward<span class="op">(</span><span class="dt">int</span> x<span class="op">)</span> <span class="at">const</span> <span class="kw">override</span> <span class="op">{</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">2</span><span class="op">*</span>x<span class="op">;</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>虚函数通过 <strong>vtable</strong> 实现, 会增加一点点内存和时间开销, 但小到可以忽略.</p></li>
</ul>
</section>
<section id="纯虚函数-a.k.a.-接口-抽象类" class="level4">
<h4 class="anchored" data-anchor-id="纯虚函数-a.k.a.-接口-抽象类">纯虚函数 (a.k.a. 接口, 抽象类)</h4>
<ul>
<li><strong>动机</strong>: 有时候我们希望一个类<strong>没有</strong>一个具体的方法 (只有一个抽象的方法), 很多子类都去实现这个方法. 以 <a href="#lst-virtualcc" class="quarto-xref">Listing&nbsp;<span class="quarto-unresolved-ref">lst-virtualcc</span></a> 来说的话就是我们希望 <code>A</code> 类的 <code>forward()</code> 方法不要有具体实现, 让所有子类都去实现它. 这样的类叫做 <strong>Abstract Class 抽象类</strong>, 也叫做 <strong>Interface 接口</strong> (很形象吧).
<ul>
<li>比如 <a href="#lst-virtualpurecc" class="quarto-xref">Listing&nbsp;<span class="quarto-unresolved-ref">lst-virtualpurecc</span></a> 中的 <code>Speaker</code> 很抽象吧嘿嘿.</li>
</ul></li>
<li>实现: 在父类的方法后面前加上 <code>= 0</code>, 称为一个 <strong>Pure Virtual Function 纯虚函数</strong>.
<ul>
<li>这样的抽象类不能被实例化, 只有子类可以被实例化.</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>virtual_pure.cc</strong></pre>
</div>
<div class="sourceCode" id="lst-virtualpurecc" data-filename="virtual_pure.cc"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-virtualpurecc-1"><a href="#lst-virtualpurecc-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="lst-virtualpurecc-2"><a href="#lst-virtualpurecc-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-virtualpurecc-3"><a href="#lst-virtualpurecc-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Speaker <span class="op">{</span></span>
<span id="lst-virtualpurecc-4"><a href="#lst-virtualpurecc-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="lst-virtualpurecc-5"><a href="#lst-virtualpurecc-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">virtual</span> <span class="dt">void</span> speak<span class="op">()</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// pure virtual</span></span>
<span id="lst-virtualpurecc-6"><a href="#lst-virtualpurecc-6" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-virtualpurecc-7"><a href="#lst-virtualpurecc-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-virtualpurecc-8"><a href="#lst-virtualpurecc-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Dog <span class="op">:</span> <span class="kw">public</span> Speaker <span class="op">{</span></span>
<span id="lst-virtualpurecc-9"><a href="#lst-virtualpurecc-9" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="lst-virtualpurecc-10"><a href="#lst-virtualpurecc-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> speak<span class="op">()</span> <span class="kw">override</span> <span class="op">{</span></span>
<span id="lst-virtualpurecc-11"><a href="#lst-virtualpurecc-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">"Woof</span><span class="sc">\n</span><span class="st">"</span><span class="op">;</span></span>
<span id="lst-virtualpurecc-12"><a href="#lst-virtualpurecc-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-virtualpurecc-13"><a href="#lst-virtualpurecc-13" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-virtualpurecc-14"><a href="#lst-virtualpurecc-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-virtualpurecc-15"><a href="#lst-virtualpurecc-15" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Cat <span class="op">:</span> <span class="kw">public</span> Speaker <span class="op">{</span></span>
<span id="lst-virtualpurecc-16"><a href="#lst-virtualpurecc-16" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="lst-virtualpurecc-17"><a href="#lst-virtualpurecc-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> speak<span class="op">()</span> <span class="kw">override</span> <span class="op">{</span></span>
<span id="lst-virtualpurecc-18"><a href="#lst-virtualpurecc-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">"Nya</span><span class="sc">\n</span><span class="st">"</span><span class="op">;</span></span>
<span id="lst-virtualpurecc-19"><a href="#lst-virtualpurecc-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-virtualpurecc-20"><a href="#lst-virtualpurecc-20" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-virtualpurecc-21"><a href="#lst-virtualpurecc-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-virtualpurecc-22"><a href="#lst-virtualpurecc-22" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="lst-virtualpurecc-23"><a href="#lst-virtualpurecc-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 不能实例化抽象类</span></span>
<span id="lst-virtualpurecc-24"><a href="#lst-virtualpurecc-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Speaker* sp = new Speaker(); // error!</span></span>
<span id="lst-virtualpurecc-25"><a href="#lst-virtualpurecc-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 用子类声明</span></span>
<span id="lst-virtualpurecc-26"><a href="#lst-virtualpurecc-26" aria-hidden="true" tabindex="-1"></a>    Dog<span class="op">*</span> dog <span class="op">=</span> <span class="kw">new</span> Dog<span class="op">();</span></span>
<span id="lst-virtualpurecc-27"><a href="#lst-virtualpurecc-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 用 Speaker 声明</span></span>
<span id="lst-virtualpurecc-28"><a href="#lst-virtualpurecc-28" aria-hidden="true" tabindex="-1"></a>    Speaker<span class="op">*</span> cat <span class="op">=</span> <span class="kw">new</span> Cat<span class="op">();</span></span>
<span id="lst-virtualpurecc-29"><a href="#lst-virtualpurecc-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-virtualpurecc-30"><a href="#lst-virtualpurecc-30" aria-hidden="true" tabindex="-1"></a>    dog<span class="op">-&gt;</span>speak<span class="op">();</span> <span class="co">// Woof</span></span>
<span id="lst-virtualpurecc-31"><a href="#lst-virtualpurecc-31" aria-hidden="true" tabindex="-1"></a>    cat<span class="op">-&gt;</span>speak<span class="op">();</span> <span class="co">// Nya</span></span>
<span id="lst-virtualpurecc-32"><a href="#lst-virtualpurecc-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-virtualpurecc-33"><a href="#lst-virtualpurecc-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">delete</span> dog<span class="op">;</span></span>
<span id="lst-virtualpurecc-34"><a href="#lst-virtualpurecc-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">delete</span> cat<span class="op">;</span> <span class="co">// Warning!</span></span>
<span id="lst-virtualpurecc-35"><a href="#lst-virtualpurecc-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-virtualpurecc-36"><a href="#lst-virtualpurecc-36" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p>但是 <a href="#lst-virtualpurecc" class="quarto-xref">Listing&nbsp;<span class="quarto-unresolved-ref">lst-virtualpurecc</span></a> 会有个 warning:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">virtual_pure.cc:34:5:</span> warning: delete called on <span class="st">'Speaker'</span> that is abstract but has non-virtual destructor <span class="pp">[-</span><span class="ss">Wdelete</span><span class="pp">-</span><span class="ss">abstract</span><span class="pp">-</span><span class="ss">non</span><span class="pp">-</span><span class="ss">virtual</span><span class="pp">-</span><span class="ss">dtor</span><span class="pp">]</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="ex">34</span> <span class="kw">|</span>     <span class="ex">delete</span> cat<span class="kw">;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>   <span class="kw">|</span>     <span class="ex">^</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>这是因为 <code>delete</code> 一个 <code>Speaker</code> 类型的指针时, 会去调用 <code>Speaker</code> 抽象类的析构函数 (注意这个析构函数是被隐式创建过的), 这时候编译器非常贴心的提醒我们: <strong>你应该想调用的是子类的析构函数吧</strong>, 你最好把父类的析构函数也声明为 <code>virtual</code>:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Speaker <span class="op">{</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">virtual</span> <span class="op">~</span>Speaker<span class="op">()</span> <span class="op">=</span> <span class="cf">default</span><span class="op">;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">virtual</span> <span class="dt">void</span> speak<span class="op">()</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// pure virtual</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
</section>
<section id="namespace-命名空间" class="level3">
<h3 class="anchored" data-anchor-id="namespace-命名空间">Namespace 命名空间</h3>
<ul>
<li>我们希望在不同的场景中给功能类似的函数起<strong>完全相同的名字</strong> (比如下面例子的 <code>print()</code> 函数), 为了<strong>避免命名冲突</strong>, 我们可以使用 <code>namespace</code>:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>namespace.cpp</strong></pre>
</div>
<div class="sourceCode" id="lst-namespacecpp" data-filename="namespace.cpp"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-namespacecpp-1"><a href="#lst-namespacecpp-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="lst-namespacecpp-2"><a href="#lst-namespacecpp-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-namespacecpp-3"><a href="#lst-namespacecpp-3" aria-hidden="true" tabindex="-1"></a><span class="kw">namespace</span> AppleSpace <span class="op">{</span> <span class="kw">namespace</span> GoodApple <span class="op">{</span></span>
<span id="lst-namespacecpp-4"><a href="#lst-namespacecpp-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> print<span class="op">(</span><span class="at">const</span> <span class="dt">char</span><span class="op">*</span> msg<span class="op">)</span></span>
<span id="lst-namespacecpp-5"><a href="#lst-namespacecpp-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="lst-namespacecpp-6"><a href="#lst-namespacecpp-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">"Goodapple "</span> <span class="op">&lt;&lt;</span> msg <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="lst-namespacecpp-7"><a href="#lst-namespacecpp-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-namespacecpp-8"><a href="#lst-namespacecpp-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>   <span class="kw">namespace</span> BadApple <span class="op">{</span></span>
<span id="lst-namespacecpp-9"><a href="#lst-namespacecpp-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> print<span class="op">(</span><span class="at">const</span> <span class="dt">char</span><span class="op">*</span> msg<span class="op">)</span></span>
<span id="lst-namespacecpp-10"><a href="#lst-namespacecpp-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="lst-namespacecpp-11"><a href="#lst-namespacecpp-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">"Badapple "</span> <span class="op">&lt;&lt;</span> msg <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="lst-namespacecpp-12"><a href="#lst-namespacecpp-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-namespacecpp-13"><a href="#lst-namespacecpp-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="op">}</span></span>
<span id="lst-namespacecpp-14"><a href="#lst-namespacecpp-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-namespacecpp-15"><a href="#lst-namespacecpp-15" aria-hidden="true" tabindex="-1"></a><span class="kw">namespace</span> OrangeSpace <span class="op">{</span></span>
<span id="lst-namespacecpp-16"><a href="#lst-namespacecpp-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> print<span class="op">(</span><span class="at">const</span> <span class="dt">char</span><span class="op">*</span> msg<span class="op">)</span></span>
<span id="lst-namespacecpp-17"><a href="#lst-namespacecpp-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="lst-namespacecpp-18"><a href="#lst-namespacecpp-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">"Orange "</span> <span class="op">&lt;&lt;</span> msg <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="lst-namespacecpp-19"><a href="#lst-namespacecpp-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-namespacecpp-20"><a href="#lst-namespacecpp-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-namespacecpp-21"><a href="#lst-namespacecpp-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-namespacecpp-22"><a href="#lst-namespacecpp-22" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="lst-namespacecpp-23"><a href="#lst-namespacecpp-23" aria-hidden="true" tabindex="-1"></a>    AppleSpace<span class="op">::</span>GoodApple<span class="op">::</span>print<span class="op">(</span><span class="st">"Hello"</span><span class="op">);</span></span>
<span id="lst-namespacecpp-24"><a href="#lst-namespacecpp-24" aria-hidden="true" tabindex="-1"></a>    AppleSpace<span class="op">::</span>BadApple<span class="op">::</span>print<span class="op">(</span><span class="st">"Hello"</span><span class="op">);</span></span>
<span id="lst-namespacecpp-25"><a href="#lst-namespacecpp-25" aria-hidden="true" tabindex="-1"></a>    OrangeSpace<span class="op">::</span>print<span class="op">(</span><span class="st">"Hello"</span><span class="op">);</span></span>
<span id="lst-namespacecpp-26"><a href="#lst-namespacecpp-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="lst-namespacecpp-27"><a href="#lst-namespacecpp-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-namespacecpp-28"><a href="#lst-namespacecpp-28" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>输出:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>Goodapple Hello</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>Badapple Hello</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>Orange Hello</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>不要到处拉 <code>using namespace xxx;</code> 的 shit!</p></li>
<li><p>全局作用域运算符:</p></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>globalnamespace.cpp</strong></pre>
</div>
<div class="sourceCode" id="lst-globalnamespacecpp" data-filename="globalnamespace.cpp"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-globalnamespacecpp-1"><a href="#lst-globalnamespacecpp-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="lst-globalnamespacecpp-2"><a href="#lst-globalnamespacecpp-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-globalnamespacecpp-3"><a href="#lst-globalnamespacecpp-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> value <span class="op">=</span> <span class="dv">10</span><span class="op">;</span>  <span class="co">// Global namespace value</span></span>
<span id="lst-globalnamespacecpp-4"><a href="#lst-globalnamespacecpp-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-globalnamespacecpp-5"><a href="#lst-globalnamespacecpp-5" aria-hidden="true" tabindex="-1"></a><span class="kw">namespace</span> A <span class="op">{</span></span>
<span id="lst-globalnamespacecpp-6"><a href="#lst-globalnamespacecpp-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> value <span class="op">=</span> <span class="dv">20</span><span class="op">;</span>  <span class="co">// A::value</span></span>
<span id="lst-globalnamespacecpp-7"><a href="#lst-globalnamespacecpp-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-globalnamespacecpp-8"><a href="#lst-globalnamespacecpp-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> print<span class="op">()</span> <span class="op">{</span></span>
<span id="lst-globalnamespacecpp-9"><a href="#lst-globalnamespacecpp-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> value <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span>      <span class="co">// Output 20</span></span>
<span id="lst-globalnamespacecpp-10"><a href="#lst-globalnamespacecpp-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="op">::</span>value <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span>    <span class="co">// Output 10</span></span>
<span id="lst-globalnamespacecpp-11"><a href="#lst-globalnamespacecpp-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-globalnamespacecpp-12"><a href="#lst-globalnamespacecpp-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-globalnamespacecpp-13"><a href="#lst-globalnamespacecpp-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-globalnamespacecpp-14"><a href="#lst-globalnamespacecpp-14" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="lst-globalnamespacecpp-15"><a href="#lst-globalnamespacecpp-15" aria-hidden="true" tabindex="-1"></a>    A<span class="op">::</span>print<span class="op">();</span></span>
<span id="lst-globalnamespacecpp-16"><a href="#lst-globalnamespacecpp-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-globalnamespacecpp-17"><a href="#lst-globalnamespacecpp-17" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><code>::</code> 可用于<strong>调用</strong> namespace 里的函数 或 class 里的 <code>static</code> 变量或方法. 在外部<strong>定义</strong>类的方法实现时必须用 <code>::</code> (调用时用 <code>.</code>).</li>
</ul>
<!-- ### Anonymous Functions (Lambda Expressions) -->
</section>
<section id="常见库用法" class="level3">
<h3 class="anchored" data-anchor-id="常见库用法">常见库用法</h3>
<section id="stdcopy" class="level4">
<h4 class="anchored" data-anchor-id="stdcopy"><code>std::copy()</code></h4>
<div class="sourceCode" id="cb23"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;vector&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;algorithm&gt;</span><span class="pp">  </span><span class="co">// std::copy</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> src <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">};</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> dst<span class="op">(</span><span class="dv">5</span><span class="op">);</span>   <span class="co">// Must arrange space in advance</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>copy<span class="op">(</span>src<span class="op">.</span>begin<span class="op">(),</span> src<span class="op">.</span>end<span class="op">(),</span> dst<span class="op">.</span>begin<span class="op">());</span> <span class="co">// Copy src to dst</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
</section>
<section id="some-python" class="level2">
<h2 class="anchored" data-anchor-id="some-python">Some Python</h2>
<section id="python-basics" class="level3">
<h3 class="anchored" data-anchor-id="python-basics">Python Basics</h3>
<section id="python-变量" class="level4">
<h4 class="anchored" data-anchor-id="python-变量">Python 变量</h4>
<ul>
<li><p><strong>Mutable 可变类型</strong></p></li>
<li><p><strong>Immutable 不可变类型</strong></p></li>
<li><p>函数传参时不可变类型按值传递, 可变类型按引用传递 (是这样吗, TODO).</p></li>
</ul>
</section>
<section id="import-libraries" class="level4">
<h4 class="anchored" data-anchor-id="import-libraries">Import Libraries</h4>
<ul>
<li><p>导入库就是让定义在别的文件中<strong>所有 object</strong> (<strong>函数、类、实例、变量等</strong>) 在本文件中可以被使用, 一般有下面几种使用方法:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cocotb 是文件夹!</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 导入虚拟环境的 /site-packages/cocotb 文件夹下的所有 object (好像不是所有?? </span><span class="al">TODO</span><span class="co">)</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 之后要用的 object 必须用 cocotb.xxx 引出</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cocotb</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 这样做可以简化引出方式: np.xxx</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 只导入 cocotb 文件夹下 triggers.py 的 RisingEdge() 函数</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 这样就可以直接用 RisingEdge() 而不用 cocotb.triggers.RisingEdge()</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cocotb.triggers <span class="im">import</span> RisingEdge</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 导入当前目录 ./helpers/xxx.py 中的一些 object</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .helpers.memory <span class="im">import</span> Memory          <span class="co"># class</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .helpers.<span class="bu">format</span> <span class="im">import</span> format_cycle    <span class="co"># function</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .helpers.logger <span class="im">import</span> logger          <span class="co"># instance</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
<section id="async-def-和-await" class="level4">
<h4 class="anchored" data-anchor-id="async-def-和-await"><code>async def</code> 和 <code>await</code></h4>
<ul>
<li><code>async def</code> 表示这个函数的执行过程中如果碰到 <code>await</code> 关键字, 会暂时跳出这个函数, 先去处理其它的函数, 比如:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>async-demo.py</strong></pre>
</div>
<div class="sourceCode" id="lst-async-demopy" data-filename="async-demo.py"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="lst-async-demopy-1"><a href="#lst-async-demopy-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="lst-async-demopy-2"><a href="#lst-async-demopy-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="lst-async-demopy-3"><a href="#lst-async-demopy-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-async-demopy-4"><a href="#lst-async-demopy-4" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> task1():</span>
<span id="lst-async-demopy-5"><a href="#lst-async-demopy-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Task 1: Starting"</span>)</span>
<span id="lst-async-demopy-6"><a href="#lst-async-demopy-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> asyncio.sleep(<span class="dv">10</span>)</span>
<span id="lst-async-demopy-7"><a href="#lst-async-demopy-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Task 1: Completed"</span>)</span>
<span id="lst-async-demopy-8"><a href="#lst-async-demopy-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="lst-async-demopy-9"><a href="#lst-async-demopy-9" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> task2():</span>
<span id="lst-async-demopy-10"><a href="#lst-async-demopy-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Task 2: Starting"</span>)</span>
<span id="lst-async-demopy-11"><a href="#lst-async-demopy-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> asyncio.sleep(<span class="dv">5</span>)</span>
<span id="lst-async-demopy-12"><a href="#lst-async-demopy-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Task 2: Completed"</span>)</span>
<span id="lst-async-demopy-13"><a href="#lst-async-demopy-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="lst-async-demopy-14"><a href="#lst-async-demopy-14" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> do_tasks_async():</span>
<span id="lst-async-demopy-15"><a href="#lst-async-demopy-15" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> time.time()</span>
<span id="lst-async-demopy-16"><a href="#lst-async-demopy-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="lst-async-demopy-17"><a href="#lst-async-demopy-17" aria-hidden="true" tabindex="-1"></a>    task1_start <span class="op">=</span> asyncio.create_task(task1())</span>
<span id="lst-async-demopy-18"><a href="#lst-async-demopy-18" aria-hidden="true" tabindex="-1"></a>    task2_start <span class="op">=</span> asyncio.create_task(task2())</span>
<span id="lst-async-demopy-19"><a href="#lst-async-demopy-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="lst-async-demopy-20"><a href="#lst-async-demopy-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Arranged two tasks, waiting for complete ..."</span>)</span>
<span id="lst-async-demopy-21"><a href="#lst-async-demopy-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> task1_start</span>
<span id="lst-async-demopy-22"><a href="#lst-async-demopy-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> task2_start</span>
<span id="lst-async-demopy-23"><a href="#lst-async-demopy-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="lst-async-demopy-24"><a href="#lst-async-demopy-24" aria-hidden="true" tabindex="-1"></a>    end <span class="op">=</span> time.time()</span>
<span id="lst-async-demopy-25"><a href="#lst-async-demopy-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"All tasks completed in </span><span class="sc">{</span>end <span class="op">-</span> start<span class="sc">:.1f}</span><span class="ss"> seconds"</span>)</span>
<span id="lst-async-demopy-26"><a href="#lst-async-demopy-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="lst-async-demopy-27"><a href="#lst-async-demopy-27" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="lst-async-demopy-28"><a href="#lst-async-demopy-28" aria-hidden="true" tabindex="-1"></a>    asyncio.run(do_tasks_async())</span>
<span id="lst-async-demopy-29"><a href="#lst-async-demopy-29" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>输出:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>Arranged two tasks, waiting for complete ...</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>Task 1: Starting</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>Task 2: Starting</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>Task 2: Completed</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>Task 1: Completed</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>All tasks completed in 10.0 seconds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="assert" class="level4">
<h4 class="anchored" data-anchor-id="assert"><code>assert</code></h4>
<ul>
<li><p><code>assert</code> 用来 debug 很有用, 比如你要检查程序中间 <code>a</code> 是否等于 <code>1</code>:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> a <span class="op">==</span> <span class="dv">1</span> <span class="co"># 如果 a 不等于 1, 程序会报错退出</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test passed!"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p><code>assert</code> 后面接的就是一个布尔值, 所以:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="va">True</span>  <span class="co"># No error</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="va">False</span> <span class="co"># Raises an AssertionError</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>也可以加上错误信息:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> a <span class="op">==</span> <span class="dv">1</span>, <span class="st">"a is not equal to 1!"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
</ul>
</section>
</section>
<section id="python-class-类" class="level3">
<h3 class="anchored" data-anchor-id="python-class-类">Python Class 类</h3>
<section id="类属性和实例属性" class="level4">
<h4 class="anchored" data-anchor-id="类属性和实例属性">类属性和实例属性</h4>
<ul>
<li><strong>Class attribute 类属性</strong>: 只不过是定义在类里面的常量而已, <strong>所有实例共享</strong>, 比如可用于 track 某个 class 的实例个数.
<ul>
<li>在类的内部和外部都可以用 <code>Car.wheels</code> 来访问和修改.</li>
</ul></li>
<li><strong>Instance attribute 实例属性</strong>: 放在 <code>__init__</code> 里面的属性, <strong>只有创建了实例后才能访问, 不同的实例可以有不同的值 (独有)</strong>!
<ul>
<li>在类的内部用 <code>self.color</code>、外部用 <code>car1.color</code> 来访问和修改.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Car:</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Class attributes</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    wheels <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, color, model):</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Instance attributes</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.color <span class="op">=</span> color</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>        Car.count <span class="op">+=</span> <span class="dv">1</span> <span class="co"># 每创建这样的类时, 计数加 1</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(Car.wheels)  <span class="co"># Accessing class attribute</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="co"># print(Car.color) # Cannot access instance attribute without creating instances</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>car1 <span class="op">=</span> Car(<span class="st">"red"</span>, <span class="st">"Toyota"</span>)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>car2 <span class="op">=</span> Car(<span class="st">"blue"</span>, <span class="st">"Honda"</span>)</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(car1.color)</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(Car.count)  <span class="co"># Output: 2</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="特殊方法-classmethodstaticmethod" class="level4">
<h4 class="anchored" data-anchor-id="特殊方法-classmethodstaticmethod">特殊方法 <code>@classmethod</code>、<code>@staticmethod</code></h4>
<ul>
<li><code>@classmethod</code> 仅仅是允许我们<strong>不创建实例</strong>就能调用该方法. 用途:
<ul>
<li>如果非要用 <code>car1.change_wheels(6)</code> 而不是 <code>Car.wheels = 6</code> 来修改类属性, 这个时候就可以用 <code>@classmethod</code>.
<ul>
<li>用 <code>Car.change_wheels(6)</code> 也行.<br>
</li>
</ul></li>
<li>由于该方法可以在创建实例前调用, 所以从某种角度看可以当作<strong>替代构造函数</strong>的方法 (比如下面从字典和 JSON 创建实例).</li>
</ul></li>
<li><code>@staticmethod</code> 仅仅是定义一个与类完全无关的函数, 函数里面不能访问任何类属性和实例属性, 写在类里面仅仅是因为<strong>逻辑上与该类相关</strong>, 一般就是 print 一些信息.
<ul>
<li>用实例名也可以调用该方法.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Car:</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 常规初始化方法</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, color, model):</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.color <span class="op">=</span> color</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 两个可选的初始化方法</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> init_from_dict(cls, init_dict): <span class="co"># cls 代表一个类名, 只是约定俗成叫 cls, 可以叫别的名字</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cls(init_dict[<span class="st">'color'</span>], init_dict[<span class="st">'model'</span>])</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> init_from_json(cls, json_str):</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> json</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>        init_dict <span class="op">=</span> json.loads(json_str) <span class="co"># 将 json 字符串转换为字典</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cls(init_dict[<span class="st">'color'</span>], init_dict[<span class="st">'model'</span>])</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 一个sb降智方法</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> car_add_print_numbers(num1, num2):</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>num1 <span class="op">+</span> num2<span class="sc">}</span><span class="ss"> cars in total"</span>)</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>car1 <span class="op">=</span> Car(<span class="st">"red"</span>, <span class="st">"Toyota"</span>) <span class="co"># 使用常规初始化方法</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>car2 <span class="op">=</span> Car.init_from_dict({<span class="st">'color'</span>: <span class="st">'blue'</span>, <span class="st">'model'</span>: <span class="st">'Honda'</span>}) <span class="co"># 使用字典初始化方法</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>car3 <span class="op">=</span> Car.init_from_json(<span class="st">'{"color": "green", "model": "Ford"}'</span>) <span class="co"># 使用 json 字符串初始化方法</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>Car.car_add_print_numbers(<span class="dv">3</span>, <span class="dv">5</span>)  <span class="co"># Output: 8 cars in total</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>car1.car_add_print_numbers(<span class="dv">10</span>, <span class="dv">20</span>)  <span class="co"># 用实例访问也行, Output: 30 cars in total</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<!-- ----------------------------------------- -->
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
他俩其实就是 decorator!
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>它们其实本质上是一个函数, 可以思考下可能是怎么实现的.</p>
</div>
</div>
</div>
<!-- ----------------------------------------- -->
</section>
<section id="动态访问实例属性-getattr" class="level4">
<h4 class="anchored" data-anchor-id="动态访问实例属性-getattr">动态访问实例属性 <code>getattr()</code></h4>
<ul>
<li><p>如果你想访问的属性名在运行时才能决定, 比如:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Order:</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.price <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.qty <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>order <span class="op">=</span> Order()</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>attr_name <span class="op">=</span> <span class="st">"price"</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(order.attr_name)              <span class="co"># 这样是不行的!</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">getattr</span>(order, attr_name))    <span class="co"># 这样才行!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
</section>
<section id="python-下划线" class="level3">
<h3 class="anchored" data-anchor-id="python-下划线">Python 下划线</h3>
<section id="下划线的基本用法" class="level4">
<h4 class="anchored" data-anchor-id="下划线的基本用法">下划线的基本用法</h4>
<ul>
<li><p>作为大数字的分隔符 (只是看起来更舒服):</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>num <span class="op">=</span> <span class="dv">1_000_000</span> <span class="co"># 相当于 num = 1000000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>作为不重要的变量, 常见的有:</p>
<ul>
<li>循环变量</li>
</ul>
<div class="sourceCode" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):  <span class="co"># 表示循环变量不重要, 不会在循环体内使用</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Hello"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>解包变量</li>
</ul>
<div class="sourceCode" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>a, _, b <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)  <span class="co"># 表示中间的变量不重要</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(a, b)          <span class="co"># 输出: 1 3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>用来避免保留关键字 (仅仅是约定, 众所周知程序员很不擅长取名字, 不用 <code>foo</code> 就很好了, 理解一下):</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>class_ <span class="op">=</span> <span class="st">"MyClass"</span>  <span class="co"># 避免和关键字 class 冲突</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
<section id="python-下划线命名的可见性" class="level4">
<h4 class="anchored" data-anchor-id="python-下划线命名的可见性">Python 下划线命名的可见性</h4>
<blockquote class="blockquote">
<p>我们研究单下划线、双下划线的 <strong>变量、函数、类属性、实例属性、类方法、实例方法、类名</strong> 在 <strong>类内部、子类、类外同文件、不同文件</strong> 中的可见性.</p>
</blockquote>
<blockquote class="blockquote">
<p>总体来说, 单下划线开头 <span class="math inline">\(\approx\)</span> “protected”, 双下划线开头 <span class="math inline">\(=\)</span> “private”.</p>
</blockquote>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>myModule.py</strong></pre>
</div>
<div class="sourceCode" id="lst-myModulepy" data-filename="myModule.py"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="lst-myModulepy-1"><a href="#lst-myModulepy-1" aria-hidden="true" tabindex="-1"></a>_var <span class="op">=</span> <span class="dv">5</span>                <span class="co"># module variable</span></span>
<span id="lst-myModulepy-2"><a href="#lst-myModulepy-2" aria-hidden="true" tabindex="-1"></a>__var <span class="op">=</span> <span class="dv">6</span>               <span class="co"># module variable</span></span>
<span id="lst-myModulepy-3"><a href="#lst-myModulepy-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-myModulepy-4"><a href="#lst-myModulepy-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _g():               <span class="co"># module function</span></span>
<span id="lst-myModulepy-5"><a href="#lst-myModulepy-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"_g called"</span>)</span>
<span id="lst-myModulepy-6"><a href="#lst-myModulepy-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-myModulepy-7"><a href="#lst-myModulepy-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> __g():              <span class="co"># module function</span></span>
<span id="lst-myModulepy-8"><a href="#lst-myModulepy-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"__g called"</span>)</span>
<span id="lst-myModulepy-9"><a href="#lst-myModulepy-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-myModulepy-10"><a href="#lst-myModulepy-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> A:</span>
<span id="lst-myModulepy-11"><a href="#lst-myModulepy-11" aria-hidden="true" tabindex="-1"></a>    _ca <span class="op">=</span> <span class="dv">1</span>             <span class="co"># Class attribute</span></span>
<span id="lst-myModulepy-12"><a href="#lst-myModulepy-12" aria-hidden="true" tabindex="-1"></a>    __ca <span class="op">=</span> <span class="dv">2</span>            <span class="co"># Class attribute</span></span>
<span id="lst-myModulepy-13"><a href="#lst-myModulepy-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="lst-myModulepy-14"><a href="#lst-myModulepy-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._ia <span class="op">=</span> <span class="dv">3</span>    <span class="co"># Instance attribute</span></span>
<span id="lst-myModulepy-15"><a href="#lst-myModulepy-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.__ia <span class="op">=</span> <span class="dv">4</span>   <span class="co"># Instance attribute</span></span>
<span id="lst-myModulepy-16"><a href="#lst-myModulepy-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _f(<span class="va">self</span>):</span>
<span id="lst-myModulepy-17"><a href="#lst-myModulepy-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"_f called"</span>)</span>
<span id="lst-myModulepy-18"><a href="#lst-myModulepy-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> __f(<span class="va">self</span>):</span>
<span id="lst-myModulepy-19"><a href="#lst-myModulepy-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"__f called"</span>)</span>
<span id="lst-myModulepy-20"><a href="#lst-myModulepy-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="lst-myModulepy-21"><a href="#lst-myModulepy-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _cf(cls):</span>
<span id="lst-myModulepy-22"><a href="#lst-myModulepy-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"_cf called"</span>)</span>
<span id="lst-myModulepy-23"><a href="#lst-myModulepy-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="lst-myModulepy-24"><a href="#lst-myModulepy-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> __cf(cls):</span>
<span id="lst-myModulepy-25"><a href="#lst-myModulepy-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"__cf called"</span>)</span>
<span id="lst-myModulepy-26"><a href="#lst-myModulepy-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-myModulepy-27"><a href="#lst-myModulepy-27" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> _A:               <span class="co"># module class</span></span>
<span id="lst-myModulepy-28"><a href="#lst-myModulepy-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="lst-myModulepy-29"><a href="#lst-myModulepy-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-myModulepy-30"><a href="#lst-myModulepy-30" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> __A:              <span class="co"># module class</span></span>
<span id="lst-myModulepy-31"><a href="#lst-myModulepy-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p>单下划线: 在<strong>所有地方</strong>都能访问 (相当于没有下划线, 但除了子类访问父类的所有单下划线开头的东西没有警告, 其它都会有警告), 除了不同文件的这种访问方法:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> myModule <span class="im">import</span> <span class="op">*</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(_var)    <span class="co"># Error: _var is not defined</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(_A)      <span class="co"># Error: _A is not defined</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>_g()           <span class="co"># Error: _g is not defined</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>但这样是可以的:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> myModule</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(myModule._var)  <span class="co"># 输出: 5</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(myModule._A)    <span class="co"># 输出: &lt;class 'myModule._A'&gt;</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>myModule._g()         <span class="co"># 输出: _g called</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>这样可以:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> myModule <span class="im">import</span> _var, _A, _g</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>双下划线:</p>
<ul>
<li><p>类中所有双下划线的 (<code>__ca</code>, <code>__ia</code>, <code>__f</code>, <code>__cf</code>) 都<strong>只能</strong>在类的内部使用 (即 “private”, 子类和类外同文件都不行).</p>
<ul>
<li>其实是 <strong>Name Mangling</strong>, 比如 <code>__ca</code> 在 runtime 会变成 <code>_A__ca</code> (类名 + 变量名), 用这种方法可以访问 (在 Python 中没有什么是绝对 private 的!):</li>
</ul>
<div class="sourceCode" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> myModule</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(myModule.A._A__ca)  <span class="co"># 输出: 2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>类外的双下划线 (<code>__var</code>, <code>__g</code>, <code>__A</code>) 必须用:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> myModule</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> myModule <span class="im">import</span> __var, __g, __A    <span class="co"># 也可以</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>这种方法导出其它文件.</p></li>
</ul></li>
</ul>
</section>
<section id="dunder-method-魔法方法" class="level4">
<h4 class="anchored" data-anchor-id="dunder-method-魔法方法">Dunder Method 魔法方法</h4>
<blockquote class="blockquote">
<p>以双下划线开头和结尾的方法, 表示对某个类进行某种特定操作 (比如创建、销毁、加法、当作函数调用等) 时自动调用的方法 (如同 C++ 的运算符重载).</p>
</blockquote>
<ul>
<li>注意所有的魔法方法都是 Python 提供的, 自己不能定义!</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>dunder-method.py</strong></pre>
</div>
<div class="sourceCode" id="lst-dunder-methodpy" data-filename="dunder-method.py"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="lst-dunder-methodpy-1"><a href="#lst-dunder-methodpy-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> addone(x):</span>
<span id="lst-dunder-methodpy-2"><a href="#lst-dunder-methodpy-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> <span class="dv">1</span></span>
<span id="lst-dunder-methodpy-3"><a href="#lst-dunder-methodpy-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-dunder-methodpy-4"><a href="#lst-dunder-methodpy-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Book:</span>
<span id="lst-dunder-methodpy-5"><a href="#lst-dunder-methodpy-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, title, author, pages):</span>
<span id="lst-dunder-methodpy-6"><a href="#lst-dunder-methodpy-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.title <span class="op">=</span> title</span>
<span id="lst-dunder-methodpy-7"><a href="#lst-dunder-methodpy-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.author <span class="op">=</span> author</span>
<span id="lst-dunder-methodpy-8"><a href="#lst-dunder-methodpy-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pages <span class="op">=</span> pages</span>
<span id="lst-dunder-methodpy-9"><a href="#lst-dunder-methodpy-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-dunder-methodpy-10"><a href="#lst-dunder-methodpy-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):  <span class="co"># 决定了当你使用 print() 或 str() 时的输出内容</span></span>
<span id="lst-dunder-methodpy-11"><a href="#lst-dunder-methodpy-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"The book is '</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>title<span class="sc">}</span><span class="ss">' by </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>author<span class="sc">}</span><span class="ss">"</span></span>
<span id="lst-dunder-methodpy-12"><a href="#lst-dunder-methodpy-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-dunder-methodpy-13"><a href="#lst-dunder-methodpy-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):  <span class="co"># 决定了当你使用 len() 时的返回值</span></span>
<span id="lst-dunder-methodpy-14"><a href="#lst-dunder-methodpy-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.pages</span>
<span id="lst-dunder-methodpy-15"><a href="#lst-dunder-methodpy-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="lst-dunder-methodpy-16"><a href="#lst-dunder-methodpy-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__eq__</span>(<span class="va">self</span>, other):    <span class="co"># 决定了当你使用 == 时的比较行为</span></span>
<span id="lst-dunder-methodpy-17"><a href="#lst-dunder-methodpy-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(other, Book):</span>
<span id="lst-dunder-methodpy-18"><a href="#lst-dunder-methodpy-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.title <span class="op">==</span> other.title <span class="kw">and</span> <span class="va">self</span>.author <span class="op">==</span> other.author</span>
<span id="lst-dunder-methodpy-19"><a href="#lst-dunder-methodpy-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="lst-dunder-methodpy-20"><a href="#lst-dunder-methodpy-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="lst-dunder-methodpy-21"><a href="#lst-dunder-methodpy-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>): <span class="co"># 允许实例像函数一样被调用</span></span>
<span id="lst-dunder-methodpy-22"><a href="#lst-dunder-methodpy-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"Reading '</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>title<span class="sc">}</span><span class="ss">'..."</span></span>
<span id="lst-dunder-methodpy-23"><a href="#lst-dunder-methodpy-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="lst-dunder-methodpy-24"><a href="#lst-dunder-methodpy-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> __addone__(<span class="va">self</span>):   <span class="co"># 不能自定义魔法方法</span></span>
<span id="lst-dunder-methodpy-25"><a href="#lst-dunder-methodpy-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.pages <span class="op">+</span> <span class="dv">1</span></span>
<span id="lst-dunder-methodpy-26"><a href="#lst-dunder-methodpy-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="lst-dunder-methodpy-27"><a href="#lst-dunder-methodpy-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage</span></span>
<span id="lst-dunder-methodpy-28"><a href="#lst-dunder-methodpy-28" aria-hidden="true" tabindex="-1"></a>book1 <span class="op">=</span> Book(<span class="st">"1984"</span>, <span class="st">"George Orwell"</span>, <span class="dv">328</span>)</span>
<span id="lst-dunder-methodpy-29"><a href="#lst-dunder-methodpy-29" aria-hidden="true" tabindex="-1"></a>book2 <span class="op">=</span> Book(<span class="st">"1984"</span>, <span class="st">"George Orwell"</span>, <span class="dv">328</span>)</span>
<span id="lst-dunder-methodpy-30"><a href="#lst-dunder-methodpy-30" aria-hidden="true" tabindex="-1"></a>book3 <span class="op">=</span> Book(<span class="st">"Brave New World"</span>, <span class="st">"Aldous Huxley"</span>, <span class="dv">288</span>)</span>
<span id="lst-dunder-methodpy-31"><a href="#lst-dunder-methodpy-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(book1)                  <span class="co"># Output: The book is '1984' by George Orwell</span></span>
<span id="lst-dunder-methodpy-32"><a href="#lst-dunder-methodpy-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(book1))             <span class="co"># Output: 328</span></span>
<span id="lst-dunder-methodpy-33"><a href="#lst-dunder-methodpy-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(book1 <span class="op">==</span> book2)         <span class="co"># Output: True</span></span>
<span id="lst-dunder-methodpy-34"><a href="#lst-dunder-methodpy-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(book1 <span class="op">==</span> book3)         <span class="co"># Output: False</span></span>
<span id="lst-dunder-methodpy-35"><a href="#lst-dunder-methodpy-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(book1())                <span class="co"># Output: Reading '1984'...</span></span>
<span id="lst-dunder-methodpy-36"><a href="#lst-dunder-methodpy-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(addone(book1))          <span class="co"># Error!</span></span>
<span id="lst-dunder-methodpy-37"><a href="#lst-dunder-methodpy-37" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="python-常用数据结构" class="level3">
<h3 class="anchored" data-anchor-id="python-常用数据结构">Python 常用数据结构</h3>
<section id="dictionary-字典" class="level4">
<h4 class="anchored" data-anchor-id="dictionary-字典">Dictionary 字典</h4>
<ul>
<li><p>访问 key, value 和 key-value 对:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> {<span class="st">'x'</span>: <span class="dv">1</span>, <span class="st">'y'</span>: <span class="dv">2</span>, <span class="st">'z'</span>: <span class="dv">3</span>}</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(a.keys())        <span class="co"># 输出 dict_keys(['x', 'y', 'z'])</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(a.values())      <span class="co"># 输出 dict_values([1, 2, 3])</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(a.items())       <span class="co"># 输出 dict_items([('x', 1), ('y', 2), ('z', 3)])</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>注意返回的不是 list 而是<strong>视图对象</strong> (原对象变化后可以跟着变):</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> {<span class="st">'x'</span>: <span class="dv">1</span>, <span class="st">'y'</span>: <span class="dv">2</span>, <span class="st">'z'</span>: <span class="dv">3</span>}</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>keys_view <span class="op">=</span> a.keys()</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(keys_view)       <span class="co"># 输出 dict_keys(['x', 'y', 'z'])</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>a[<span class="st">'w'</span>] <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(keys_view)       <span class="co"># keys_view 也变了,</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>                       <span class="co"># 输出 dict_keys(['x', 'y', 'z', 'w'])</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><p>用 <code>get()</code> 来访问 key, 返回对应的 value</p>
<ul>
<li>注意 key 不存在时不会报错, 而是返回 <code>None</code>!</li>
</ul>
<div class="sourceCode" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> {<span class="st">'x'</span>: <span class="dv">1</span>, <span class="st">'y'</span>: <span class="dv">2</span>}</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(a.get(<span class="st">'x'</span>))  <span class="co"># 输出 1</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(a.get(<span class="st">"x"</span>))  <span class="co"># 也可以</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(a.get(<span class="st">'z'</span>))  <span class="co"># 输出 None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
</section>
<section id="可变参数" class="level3">
<h3 class="anchored" data-anchor-id="可变参数">可变参数</h3>
<ul>
<li><code>*</code>: 表示任意数量的<strong>单个</strong>参数, 会自动打包成一个 tuple, 比如 <code>('a', 'b', 'c')</code>.
<ul>
<li>一般约定叫 <code>*args</code> (arguments), 但也可以随便取名, 比如 <code>*courses</code>.</li>
</ul></li>
<li><code>**</code>: 表示任意数量的 <strong>“xxx=yyy” 形式</strong>的参数, 会自动打包成一个 dict, 比如 <code>{'hobby': '篮球', 'score': 95}</code>.
<ul>
<li>一般约定叫 <code>**kwargs</code> (keyword arguments), 但也可以随便取名, 比如 <code>**extras</code>.</li>
<li>会配合 <code>for key, value in kwargs.items():</code> 解包使用!</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> student_info(name, age, <span class="op">*</span>courses, <span class="op">**</span>extras):</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co">    name: 必需参数</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co">    age: 必需参数  </span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="co">    *courses: 可变数量的课程</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co">    **extras: 可变数量的额外信息</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"姓名: </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"年龄: </span><span class="sc">{</span>age<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"课程: </span><span class="sc">{</span>courses<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"额外信息: </span><span class="sc">{</span>extras<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用, 从第一个格式为 "xxx=yyy" 的参数开始算 extras</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>student_info(<span class="st">"张三"</span>, <span class="dv">18</span>, <span class="st">"数学"</span>, <span class="st">"物理"</span>, <span class="st">"化学"</span>, hobby<span class="op">=</span><span class="st">"篮球"</span>, score<span class="op">=</span><span class="dv">95</span>)</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 可以没有 courses</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>student_info(<span class="st">"李四"</span>, <span class="dv">20</span>, hobby<span class="op">=</span><span class="st">"音乐"</span>)</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a><span class="co"># "历史" 不是 "xxx=yyy" 结构, 报错!</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a><span class="co"># student_info("王五", 22, "英语", hobby="阅读", "历史")  # SyntaxError</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="first-class-objects" class="level3">
<h3 class="anchored" data-anchor-id="first-class-objects">First-class Objects</h3>
<ul>
<li>一个对象若有以下特征, 则称其为 “first-class object”:
<ul>
<li>可以被赋值给变量</li>
<li>可以作为参数传递给函数</li>
<li>可以作为函数的返回值</li>
<li>可以在运行时动态创建</li>
<li>可以存储在数据结构中 (如列表、字典等)</li>
</ul></li>
</ul>
<!-- ----------------------------------------- -->
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
First-class Objects Examples
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li>Functions 函数</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>function-1stclass.py</strong></pre>
</div>
<div class="sourceCode" id="lst-function-1stclasspy" data-filename="function-1stclass.py"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="lst-function-1stclasspy-1"><a href="#lst-function-1stclasspy-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 赋值给变量</span></span>
<span id="lst-function-1stclasspy-2"><a href="#lst-function-1stclasspy-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> greet(name):</span>
<span id="lst-function-1stclasspy-3"><a href="#lst-function-1stclasspy-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"Hello, </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">!"</span></span>
<span id="lst-function-1stclasspy-4"><a href="#lst-function-1stclasspy-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-function-1stclasspy-5"><a href="#lst-function-1stclasspy-5" aria-hidden="true" tabindex="-1"></a>my_function <span class="op">=</span> greet  <span class="co"># 函数赋值给变量</span></span>
<span id="lst-function-1stclasspy-6"><a href="#lst-function-1stclasspy-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(my_function(<span class="st">"Alice"</span>))  <span class="co"># 输出: Hello, Alice!</span></span>
<span id="lst-function-1stclasspy-7"><a href="#lst-function-1stclasspy-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-function-1stclasspy-8"><a href="#lst-function-1stclasspy-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 作为参数传递</span></span>
<span id="lst-function-1stclasspy-9"><a href="#lst-function-1stclasspy-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> shout(func, name):</span>
<span id="lst-function-1stclasspy-10"><a href="#lst-function-1stclasspy-10" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> func(name)</span>
<span id="lst-function-1stclasspy-11"><a href="#lst-function-1stclasspy-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result.upper()</span>
<span id="lst-function-1stclasspy-12"><a href="#lst-function-1stclasspy-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-function-1stclasspy-13"><a href="#lst-function-1stclasspy-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(shout(greet, <span class="st">"Bob"</span>))  <span class="co"># 输出: HELLO, BOB!</span></span>
<span id="lst-function-1stclasspy-14"><a href="#lst-function-1stclasspy-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-function-1stclasspy-15"><a href="#lst-function-1stclasspy-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. 作为返回值, 这里也可以用装饰器!</span></span>
<span id="lst-function-1stclasspy-16"><a href="#lst-function-1stclasspy-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> simple_decorator(func):</span>
<span id="lst-function-1stclasspy-17"><a href="#lst-function-1stclasspy-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> wrapper():</span>
<span id="lst-function-1stclasspy-18"><a href="#lst-function-1stclasspy-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"函数执行前..."</span>)</span>
<span id="lst-function-1stclasspy-19"><a href="#lst-function-1stclasspy-19" aria-hidden="true" tabindex="-1"></a>        func()  <span class="co"># 调用原始函数</span></span>
<span id="lst-function-1stclasspy-20"><a href="#lst-function-1stclasspy-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"函数执行后..."</span>)</span>
<span id="lst-function-1stclasspy-21"><a href="#lst-function-1stclasspy-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> wrapper</span>
<span id="lst-function-1stclasspy-22"><a href="#lst-function-1stclasspy-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-function-1stclasspy-23"><a href="#lst-function-1stclasspy-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> say_hello():</span>
<span id="lst-function-1stclasspy-24"><a href="#lst-function-1stclasspy-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Hello!"</span>)</span>
<span id="lst-function-1stclasspy-25"><a href="#lst-function-1stclasspy-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-function-1stclasspy-26"><a href="#lst-function-1stclasspy-26" aria-hidden="true" tabindex="-1"></a>simple_decorator(say_hello)() <span class="co"># 输出:</span></span>
<span id="lst-function-1stclasspy-27"><a href="#lst-function-1stclasspy-27" aria-hidden="true" tabindex="-1"></a>                              <span class="co"># 函数执行前...</span></span>
<span id="lst-function-1stclasspy-28"><a href="#lst-function-1stclasspy-28" aria-hidden="true" tabindex="-1"></a>                              <span class="co"># Hello!</span></span>
<span id="lst-function-1stclasspy-29"><a href="#lst-function-1stclasspy-29" aria-hidden="true" tabindex="-1"></a>                              <span class="co"># 函数执行后...</span></span>
<span id="lst-function-1stclasspy-30"><a href="#lst-function-1stclasspy-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-function-1stclasspy-31"><a href="#lst-function-1stclasspy-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. 存储在数据结构中</span></span>
<span id="lst-function-1stclasspy-32"><a href="#lst-function-1stclasspy-32" aria-hidden="true" tabindex="-1"></a>operations <span class="op">=</span> {</span>
<span id="lst-function-1stclasspy-33"><a href="#lst-function-1stclasspy-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">'add'</span>: <span class="kw">lambda</span> x, y: x <span class="op">+</span> y,</span>
<span id="lst-function-1stclasspy-34"><a href="#lst-function-1stclasspy-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">'subtract'</span>: <span class="kw">lambda</span> x, y: x <span class="op">-</span> y,</span>
<span id="lst-function-1stclasspy-35"><a href="#lst-function-1stclasspy-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">'multiply'</span>: <span class="kw">lambda</span> x, y: x <span class="op">*</span> y</span>
<span id="lst-function-1stclasspy-36"><a href="#lst-function-1stclasspy-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="lst-function-1stclasspy-37"><a href="#lst-function-1stclasspy-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-function-1stclasspy-38"><a href="#lst-function-1stclasspy-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(operations[<span class="st">'add'</span>](<span class="dv">10</span>, <span class="dv">5</span>))      <span class="co"># 输出: 15</span></span>
<span id="lst-function-1stclasspy-39"><a href="#lst-function-1stclasspy-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(operations[<span class="st">'multiply'</span>](<span class="dv">3</span>, <span class="dv">4</span>))  <span class="co"># 输出: 12</span></span>
<span id="lst-function-1stclasspy-40"><a href="#lst-function-1stclasspy-40" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Classes 类</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>class-1stclass.py</strong></pre>
</div>
<div class="sourceCode" id="lst-class-1stclasspy" data-filename="class-1stclass.py"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="lst-class-1stclasspy-1"><a href="#lst-class-1stclasspy-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 类可以赋值给变量</span></span>
<span id="lst-class-1stclasspy-2"><a href="#lst-class-1stclasspy-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Dog:</span>
<span id="lst-class-1stclasspy-3"><a href="#lst-class-1stclasspy-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> bark(<span class="va">self</span>):</span>
<span id="lst-class-1stclasspy-4"><a href="#lst-class-1stclasspy-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"Woof!"</span></span>
<span id="lst-class-1stclasspy-5"><a href="#lst-class-1stclasspy-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-class-1stclasspy-6"><a href="#lst-class-1stclasspy-6" aria-hidden="true" tabindex="-1"></a>Pet <span class="op">=</span> Dog  <span class="co"># 类赋值给变量</span></span>
<span id="lst-class-1stclasspy-7"><a href="#lst-class-1stclasspy-7" aria-hidden="true" tabindex="-1"></a>my_dog <span class="op">=</span> Pet()</span>
<span id="lst-class-1stclasspy-8"><a href="#lst-class-1stclasspy-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(my_dog.bark())  <span class="co"># 输出: Woof!</span></span>
<span id="lst-class-1stclasspy-9"><a href="#lst-class-1stclasspy-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-class-1stclasspy-10"><a href="#lst-class-1stclasspy-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 类作为参数传递</span></span>
<span id="lst-class-1stclasspy-11"><a href="#lst-class-1stclasspy-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_animal(cls, name):</span>
<span id="lst-class-1stclasspy-12"><a href="#lst-class-1stclasspy-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cls(name)</span>
<span id="lst-class-1stclasspy-13"><a href="#lst-class-1stclasspy-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-class-1stclasspy-14"><a href="#lst-class-1stclasspy-14" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Cat:</span>
<span id="lst-class-1stclasspy-15"><a href="#lst-class-1stclasspy-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, name):</span>
<span id="lst-class-1stclasspy-16"><a href="#lst-class-1stclasspy-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.name <span class="op">=</span> name</span>
<span id="lst-class-1stclasspy-17"><a href="#lst-class-1stclasspy-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="lst-class-1stclasspy-18"><a href="#lst-class-1stclasspy-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> meow(<span class="va">self</span>):</span>
<span id="lst-class-1stclasspy-19"><a href="#lst-class-1stclasspy-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>name<span class="sc">}</span><span class="ss"> says Meow!"</span></span>
<span id="lst-class-1stclasspy-20"><a href="#lst-class-1stclasspy-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-class-1stclasspy-21"><a href="#lst-class-1stclasspy-21" aria-hidden="true" tabindex="-1"></a>cat <span class="op">=</span> create_animal(Cat, <span class="st">"Whiskers"</span>)  <span class="co"># 传递类作为参数</span></span>
<span id="lst-class-1stclasspy-22"><a href="#lst-class-1stclasspy-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cat.meow())  <span class="co"># 输出: Whiskers says Meow!</span></span>
<span id="lst-class-1stclasspy-23"><a href="#lst-class-1stclasspy-23" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<!-- ----------------------------------------- -->
<section id="python-decorator-装饰器" class="level4">
<h4 class="anchored" data-anchor-id="python-decorator-装饰器">Python Decorator 装饰器</h4>
<blockquote class="blockquote">
<p>广义来说, <strong>返回值和参数都是函数</strong>的函数都可以叫作装饰器.</p>
</blockquote>
<ul>
<li>装饰器就想<strong>每当一个函数执行的时候</strong>多输出一些日志等信息但又不想将日志 <code>print</code> 代码写在函数体内 (给函数穿衣服).
<ul>
<li>比如 <a href="#lst-function-1stclasspy" class="quarto-xref">Listing&nbsp;<span class="quarto-unresolved-ref">lst-function-1stclasspy</span></a> 中 <code>simple_decorator()</code> 装饰器也可以写成:</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>decorator.py</strong></pre>
</div>
<div class="sourceCode" id="lst-decoratorpy" data-filename="decorator.py"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="lst-decoratorpy-1"><a href="#lst-decoratorpy-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> simple_decorator(func):</span>
<span id="lst-decoratorpy-2"><a href="#lst-decoratorpy-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> wrapper():</span>
<span id="lst-decoratorpy-3"><a href="#lst-decoratorpy-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"函数执行前..."</span>)</span>
<span id="lst-decoratorpy-4"><a href="#lst-decoratorpy-4" aria-hidden="true" tabindex="-1"></a>        func()  <span class="co"># 调用原始函数</span></span>
<span id="lst-decoratorpy-5"><a href="#lst-decoratorpy-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"函数执行后..."</span>)</span>
<span id="lst-decoratorpy-6"><a href="#lst-decoratorpy-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> wrapper</span>
<span id="lst-decoratorpy-7"><a href="#lst-decoratorpy-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-decoratorpy-8"><a href="#lst-decoratorpy-8" aria-hidden="true" tabindex="-1"></a><span class="at">@simple_decorator</span></span>
<span id="lst-decoratorpy-9"><a href="#lst-decoratorpy-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> say_hello():</span>
<span id="lst-decoratorpy-10"><a href="#lst-decoratorpy-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Hello!"</span>)</span>
<span id="lst-decoratorpy-11"><a href="#lst-decoratorpy-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-decoratorpy-12"><a href="#lst-decoratorpy-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用装饰器</span></span>
<span id="lst-decoratorpy-13"><a href="#lst-decoratorpy-13" aria-hidden="true" tabindex="-1"></a>say_hello() <span class="co"># Output:</span></span>
<span id="lst-decoratorpy-14"><a href="#lst-decoratorpy-14" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 函数执行前...</span></span>
<span id="lst-decoratorpy-15"><a href="#lst-decoratorpy-15" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Hello!</span></span>
<span id="lst-decoratorpy-16"><a href="#lst-decoratorpy-16" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 函数执行后...</span></span>
<span id="lst-decoratorpy-17"><a href="#lst-decoratorpy-17" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="链式调用" class="level3">
<h3 class="anchored" data-anchor-id="链式调用">链式调用</h3>
<p>返回 <code>*this</code> 的引用可以实现链式调用:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chaining.cpp</strong></pre>
</div>
<div class="sourceCode" id="lst-chaining" data-filename="chaining.cpp"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-chaining-1"><a href="#lst-chaining-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="lst-chaining-2"><a href="#lst-chaining-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-chaining-3"><a href="#lst-chaining-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Point <span class="op">{</span></span>
<span id="lst-chaining-4"><a href="#lst-chaining-4" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="lst-chaining-5"><a href="#lst-chaining-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="va">x_</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="dt">int</span> <span class="va">y_</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="lst-chaining-6"><a href="#lst-chaining-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-chaining-7"><a href="#lst-chaining-7" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="lst-chaining-8"><a href="#lst-chaining-8" aria-hidden="true" tabindex="-1"></a>    Point<span class="op">&amp;</span> setX<span class="op">(</span><span class="dt">int</span> x<span class="op">)</span> <span class="op">{</span></span>
<span id="lst-chaining-9"><a href="#lst-chaining-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">x_</span> <span class="op">=</span> x<span class="op">;</span></span>
<span id="lst-chaining-10"><a href="#lst-chaining-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">*</span><span class="kw">this</span><span class="op">;</span> </span>
<span id="lst-chaining-11"><a href="#lst-chaining-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-chaining-12"><a href="#lst-chaining-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-chaining-13"><a href="#lst-chaining-13" aria-hidden="true" tabindex="-1"></a>    Point<span class="op">&amp;</span> setY<span class="op">(</span><span class="dt">int</span> y<span class="op">)</span> <span class="op">{</span></span>
<span id="lst-chaining-14"><a href="#lst-chaining-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">y_</span> <span class="op">=</span> y<span class="op">;</span></span>
<span id="lst-chaining-15"><a href="#lst-chaining-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">*</span><span class="kw">this</span><span class="op">;</span></span>
<span id="lst-chaining-16"><a href="#lst-chaining-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-chaining-17"><a href="#lst-chaining-17" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-chaining-18"><a href="#lst-chaining-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-chaining-19"><a href="#lst-chaining-19" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="lst-chaining-20"><a href="#lst-chaining-20" aria-hidden="true" tabindex="-1"></a>    Point p<span class="op">;</span></span>
<span id="lst-chaining-21"><a href="#lst-chaining-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set values by chaining</span></span>
<span id="lst-chaining-22"><a href="#lst-chaining-22" aria-hidden="true" tabindex="-1"></a>    p<span class="op">.</span>setX<span class="op">(</span><span class="dv">10</span><span class="op">).</span>setY<span class="op">(</span><span class="dv">20</span><span class="op">);</span></span>
<span id="lst-chaining-23"><a href="#lst-chaining-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-chaining-24"><a href="#lst-chaining-24" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="cocotb-库" class="level3">
<h3 class="anchored" data-anchor-id="cocotb-库"><code>cocotb</code> 库</h3>
<ul>
<li>常用操作:</li>
</ul>
<div class="sourceCode" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cocotb</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cocotb.clock <span class="im">import</span> Clock</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cocotb.triggers <span class="im">import</span> RisingEdge</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="sec-pybind11" class="level2">
<h2 class="anchored" data-anchor-id="sec-pybind11">Pybind11</h2>
<p><code>Pybind11</code> 是一个 <code>C++</code> 库, 使得我们可以在 <code>Python</code> 代码中调用 <code>C++</code> 函数和类.</p>
<section id="python-调用-c-函数" class="level3">
<h3 class="anchored" data-anchor-id="python-调用-c-函数">Python 调用 C++ 函数</h3>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>add_op.cpp</strong></pre>
</div>
<div class="sourceCode" id="lst-addopcpp" data-filename="add_op.cpp"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-addopcpp-1"><a href="#lst-addopcpp-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;pybind11/pybind11.h&gt;</span></span>
<span id="lst-addopcpp-2"><a href="#lst-addopcpp-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-addopcpp-3"><a href="#lst-addopcpp-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> add<span class="op">(</span><span class="dt">int</span> a<span class="op">,</span> <span class="dt">int</span> b<span class="op">)</span> <span class="op">{</span></span>
<span id="lst-addopcpp-4"><a href="#lst-addopcpp-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a <span class="op">+</span> b<span class="op">;</span></span>
<span id="lst-addopcpp-5"><a href="#lst-addopcpp-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-addopcpp-6"><a href="#lst-addopcpp-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-addopcpp-7"><a href="#lst-addopcpp-7" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="an">@param</span><span class="co"> </span><span class="cv">ops</span><span class="co"> library name</span></span>
<span id="lst-addopcpp-8"><a href="#lst-addopcpp-8" aria-hidden="true" tabindex="-1"></a>PYBIND11_MODULE<span class="op">(</span>ops<span class="op">,</span> m<span class="op">)</span> <span class="op">{</span></span>
<span id="lst-addopcpp-9"><a href="#lst-addopcpp-9" aria-hidden="true" tabindex="-1"></a>    m<span class="op">.</span>def<span class="op">(</span><span class="st">"add"</span><span class="op">,</span> <span class="op">&amp;</span>add<span class="op">);</span></span>
<span id="lst-addopcpp-10"><a href="#lst-addopcpp-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-addopcpp-11"><a href="#lst-addopcpp-11" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>main.py</strong></pre>
</div>
<div class="sourceCode" id="lst-mainpy" data-filename="main.py"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="lst-mainpy-1"><a href="#lst-mainpy-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ops</span>
<span id="lst-mainpy-2"><a href="#lst-mainpy-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mainpy-3"><a href="#lst-mainpy-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ops.add(<span class="dv">3</span>, <span class="dv">5</span>))</span>
<span id="lst-mainpy-4"><a href="#lst-mainpy-4" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<ul>
<li><a href="#lst-addopcpp" class="quarto-xref">Listing&nbsp;<span class="quarto-unresolved-ref">lst-addopcpp</span></a> 中第一个 <code>add</code> 是 Python 里调用用的函数名, 第二个是 C++ 里的函数名. <code>ops</code> 和 <code>m</code> 也可以换成任意别的名字. 运行类似下面的命令:</li>
</ul>
<div class="sourceCode" id="cb46"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="ex">c++</span> <span class="at">-O3</span> <span class="at">-Wall</span> <span class="at">-shared</span> <span class="at">-std</span><span class="op">=</span>c++11 <span class="at">-fPIC</span> <span class="at">-undefined</span> dynamic_lookup <span class="dt">\</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">-I</span>/opt/homebrew/anaconda3/lib/python3.12/site-packages/pybind11/include <span class="dt">\</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">-I</span>/opt/homebrew/anaconda3/include/python3.12 <span class="dt">\</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    add_op.cpp <span class="at">-o</span> ops.cpython-312-darwin.so</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> main.py <span class="co"># output 8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>第一个命令会在当前目录下产生一个 <code>.so</code> (shared object) 文件. 运行 <code>python main.py</code> 的时候在 <code>import ops</code> 的时候, <code>Python</code> 会在 <code>.so</code> 文件中找到 <code>add</code> 函数.</p>
</section>
<section id="python-调用-c-类" class="level3">
<h3 class="anchored" data-anchor-id="python-调用-c-类">Python 调用 C++ 类</h3>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>ml_bind.cc</strong></pre>
</div>
<div class="sourceCode" id="lst-mlbindcc" data-filename="ml_bind.cc"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-mlbindcc-1"><a href="#lst-mlbindcc-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;pybind11/pybind11.h&gt;</span></span>
<span id="lst-mlbindcc-2"><a href="#lst-mlbindcc-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mlbindcc-3"><a href="#lst-mlbindcc-3" aria-hidden="true" tabindex="-1"></a><span class="kw">namespace</span> ml <span class="op">{</span></span>
<span id="lst-mlbindcc-4"><a href="#lst-mlbindcc-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mlbindcc-5"><a href="#lst-mlbindcc-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model <span class="op">{</span></span>
<span id="lst-mlbindcc-6"><a href="#lst-mlbindcc-6" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="lst-mlbindcc-7"><a href="#lst-mlbindcc-7" aria-hidden="true" tabindex="-1"></a>    Model<span class="op">()</span> <span class="op">=</span> <span class="cf">default</span><span class="op">;</span></span>
<span id="lst-mlbindcc-8"><a href="#lst-mlbindcc-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">virtual</span> <span class="op">~</span>Model<span class="op">()</span> <span class="op">=</span> <span class="cf">default</span><span class="op">;</span> <span class="co">// 虚析构函数以确保派生类正确析构</span></span>
<span id="lst-mlbindcc-9"><a href="#lst-mlbindcc-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mlbindcc-10"><a href="#lst-mlbindcc-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">virtual</span> <span class="dt">double</span> forward<span class="op">(</span><span class="dt">double</span> x<span class="op">)</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="lst-mlbindcc-11"><a href="#lst-mlbindcc-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x<span class="op">;</span></span>
<span id="lst-mlbindcc-12"><a href="#lst-mlbindcc-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-mlbindcc-13"><a href="#lst-mlbindcc-13" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-mlbindcc-14"><a href="#lst-mlbindcc-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mlbindcc-15"><a href="#lst-mlbindcc-15" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LinearModel <span class="op">:</span> <span class="kw">public</span> Model <span class="op">{</span></span>
<span id="lst-mlbindcc-16"><a href="#lst-mlbindcc-16" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="lst-mlbindcc-17"><a href="#lst-mlbindcc-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> weight<span class="op">;</span></span>
<span id="lst-mlbindcc-18"><a href="#lst-mlbindcc-18" aria-hidden="true" tabindex="-1"></a>    LinearModel<span class="op">(</span><span class="dt">double</span> w <span class="op">=</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">:</span> weight<span class="op">(</span>w<span class="op">)</span> <span class="op">{}</span></span>
<span id="lst-mlbindcc-19"><a href="#lst-mlbindcc-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mlbindcc-20"><a href="#lst-mlbindcc-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> forward<span class="op">(</span><span class="dt">double</span> x<span class="op">)</span> <span class="at">const</span> <span class="kw">override</span> <span class="op">{</span></span>
<span id="lst-mlbindcc-21"><a href="#lst-mlbindcc-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> weight <span class="op">*</span> x<span class="op">;</span></span>
<span id="lst-mlbindcc-22"><a href="#lst-mlbindcc-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-mlbindcc-23"><a href="#lst-mlbindcc-23" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-mlbindcc-24"><a href="#lst-mlbindcc-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mlbindcc-25"><a href="#lst-mlbindcc-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="co">// namespace ml</span></span>
<span id="lst-mlbindcc-26"><a href="#lst-mlbindcc-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mlbindcc-27"><a href="#lst-mlbindcc-27" aria-hidden="true" tabindex="-1"></a>PYBIND11_MODULE<span class="op">(</span>ml_ops<span class="op">,</span> m<span class="op">)</span> <span class="op">{</span></span>
<span id="lst-mlbindcc-28"><a href="#lst-mlbindcc-28" aria-hidden="true" tabindex="-1"></a>    pybind11<span class="op">::</span><span class="va">class_</span><span class="op">&lt;</span>ml<span class="op">::</span>Model<span class="op">&gt;(</span>m<span class="op">,</span> <span class="st">"Model"</span><span class="op">)</span>     <span class="co">// ml::Model 映射到 Python 里的 Model</span></span>
<span id="lst-mlbindcc-29"><a href="#lst-mlbindcc-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>def<span class="op">(</span>pybind11<span class="op">::</span>init<span class="op">&lt;&gt;())</span>                <span class="co">// 绑定类的默认构造函数</span></span>
<span id="lst-mlbindcc-30"><a href="#lst-mlbindcc-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>def<span class="op">(</span><span class="st">"forward"</span><span class="op">,</span> <span class="op">&amp;</span>ml<span class="op">::</span>Model<span class="op">::</span>forward<span class="op">);</span>   <span class="co">// 绑定类的成员函数 `forward`.</span></span>
<span id="lst-mlbindcc-31"><a href="#lst-mlbindcc-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mlbindcc-32"><a href="#lst-mlbindcc-32" aria-hidden="true" tabindex="-1"></a>    pybind11<span class="op">::</span><span class="va">class_</span><span class="op">&lt;</span>ml<span class="op">::</span>LinearModel<span class="op">,</span> ml<span class="op">::</span>Model<span class="op">&gt;(</span>m<span class="op">,</span> <span class="st">"LinearModel"</span><span class="op">)</span></span>
<span id="lst-mlbindcc-33"><a href="#lst-mlbindcc-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>def<span class="op">(</span>pybind11<span class="op">::</span>init<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(),</span> pybind11<span class="op">::</span>arg<span class="op">(</span><span class="st">"weight"</span><span class="op">)</span> <span class="op">=</span> <span class="fl">1.0</span><span class="op">)</span></span>
<span id="lst-mlbindcc-34"><a href="#lst-mlbindcc-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>def<span class="op">(</span><span class="st">"forward"</span><span class="op">,</span> <span class="op">&amp;</span>ml<span class="op">::</span>LinearModel<span class="op">::</span>forward<span class="op">)</span> <span class="co">// 绑定类的成员函数 `forward`.</span></span>
<span id="lst-mlbindcc-35"><a href="#lst-mlbindcc-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>def_readwrite<span class="op">(</span><span class="st">"weight"</span><span class="op">,</span> <span class="op">&amp;</span>ml<span class="op">::</span>LinearModel<span class="op">::</span>weight<span class="op">);</span></span>
<span id="lst-mlbindcc-36"><a href="#lst-mlbindcc-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-mlbindcc-37"><a href="#lst-mlbindcc-37" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>上面的代码把 C++ 中的 <code>Model</code> 类和其子类 <code>LinearModel</code> 绑定到 Python 中. 下面对未注释的代码进行解释:
<ul>
<li><p><code>&lt;&gt;</code> 中表示告诉 Python 前者是要绑定的类, 后者是其父类; 并且在 Python 里这个类叫 <code>LinearModel</code> (同名).</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>pybind11<span class="op">::</span><span class="va">class_</span><span class="op">&lt;</span>ml<span class="op">::</span>LinearModel<span class="op">,</span> ml<span class="op">::</span>Model<span class="op">&gt;(</span>m<span class="op">,</span> <span class="st">"LinearModel"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>绑定类的构造函数: 这里表示 <code>LinearModel</code> 的构造函数接受一个 <code>double</code> 类型的参数 <code>weight</code>, 默认值是 <code>1.0</code>.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>def<span class="op">(</span>pybind11<span class="op">::</span>init<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(),</span> pybind11<span class="op">::</span>arg<span class="op">(</span><span class="st">"weight"</span><span class="op">)</span> <span class="op">=</span> <span class="fl">1.0</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>在 Python 里可以这样构造:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>LinearModel()           <span class="co"># weight 默认为 1.0</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>LinearModel(<span class="fl">2.5</span>)        <span class="co"># weight 设为 2.5</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>LinearModel(weight<span class="op">=</span><span class="fl">2.5</span>) <span class="co"># 同上</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>绑定类的成员变量 <code>weight</code>:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>def_readwrite<span class="op">(</span><span class="st">"weight"</span><span class="op">,</span> <span class="op">&amp;</span>ml<span class="op">::</span>LinearModel<span class="op">::</span>weight<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>在 Python 里可以直接读写:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>lm.weight</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>lm.weight <span class="op">=</span> <span class="fl">5.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>为什么 <code>Model</code> 要加下面的析构虚函数?</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">virtual</span> <span class="op">~</span>Model<span class="op">()</span> <span class="op">=</span> <span class="cf">default</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>是因为下面 Python 会使用 <code>std::shared_ptr</code> 创建对象 <code>Model</code>, 并在代码在结束时销毁它, 如果没有虚析构函数, 可能会导致派生类 <code>LinearModel</code> 的析构函数不被调用 (不加会有 warning).</p></li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>main.py</strong></pre>
</div>
<div class="sourceCode" id="lst-mainpyclass" data-filename="main.py"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="lst-mainpyclass-1"><a href="#lst-mainpyclass-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ml_ops <span class="im">import</span> Model, LinearModel</span>
<span id="lst-mainpyclass-2"><a href="#lst-mainpyclass-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mainpyclass-3"><a href="#lst-mainpyclass-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用基类</span></span>
<span id="lst-mainpyclass-4"><a href="#lst-mainpyclass-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model()</span>
<span id="lst-mainpyclass-5"><a href="#lst-mainpyclass-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(model.forward(<span class="fl">2.0</span>))               <span class="co"># 2.0</span></span>
<span id="lst-mainpyclass-6"><a href="#lst-mainpyclass-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mainpyclass-7"><a href="#lst-mainpyclass-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用派生类</span></span>
<span id="lst-mainpyclass-8"><a href="#lst-mainpyclass-8" aria-hidden="true" tabindex="-1"></a>linearModel <span class="op">=</span> LinearModel(weight<span class="op">=</span><span class="fl">3.0</span>)</span>
<span id="lst-mainpyclass-9"><a href="#lst-mainpyclass-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(linearModel.forward(<span class="fl">2.0</span>))         <span class="co"># 6.0</span></span>
<span id="lst-mainpyclass-10"><a href="#lst-mainpyclass-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mainpyclass-11"><a href="#lst-mainpyclass-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 验证继承关系</span></span>
<span id="lst-mainpyclass-12"><a href="#lst-mainpyclass-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">isinstance</span>(linearModel, Model))   <span class="co"># True</span></span>
<span id="lst-mainpyclass-13"><a href="#lst-mainpyclass-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mainpyclass-14"><a href="#lst-mainpyclass-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 访问 C++ 成员变量</span></span>
<span id="lst-mainpyclass-15"><a href="#lst-mainpyclass-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(linearModel.weight)               <span class="co"># 3.0</span></span>
<span id="lst-mainpyclass-16"><a href="#lst-mainpyclass-16" aria-hidden="true" tabindex="-1"></a>linearModel.weight <span class="op">=</span> <span class="fl">5.0</span></span>
<span id="lst-mainpyclass-17"><a href="#lst-mainpyclass-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(linearModel.forward(<span class="fl">2.0</span>))         <span class="co"># 10.0</span></span>
<span id="lst-mainpyclass-18"><a href="#lst-mainpyclass-18" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>再写一个 <code>setup.py</code> 来编译绑定代码:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>setup.py</strong></pre>
</div>
<div class="sourceCode" id="lst-setuppy" data-filename="setup.py"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="lst-setuppy-1"><a href="#lst-setuppy-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> setuptools <span class="im">import</span> setup, Extension</span>
<span id="lst-setuppy-2"><a href="#lst-setuppy-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pybind11</span>
<span id="lst-setuppy-3"><a href="#lst-setuppy-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-setuppy-4"><a href="#lst-setuppy-4" aria-hidden="true" tabindex="-1"></a>ext_modules <span class="op">=</span> [</span>
<span id="lst-setuppy-5"><a href="#lst-setuppy-5" aria-hidden="true" tabindex="-1"></a>    Extension(</span>
<span id="lst-setuppy-6"><a href="#lst-setuppy-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ml_ops"</span>,</span>
<span id="lst-setuppy-7"><a href="#lst-setuppy-7" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"ml_bind.cc"</span>],</span>
<span id="lst-setuppy-8"><a href="#lst-setuppy-8" aria-hidden="true" tabindex="-1"></a>        include_dirs<span class="op">=</span>[pybind11.get_include()],</span>
<span id="lst-setuppy-9"><a href="#lst-setuppy-9" aria-hidden="true" tabindex="-1"></a>        language<span class="op">=</span><span class="st">"c++"</span>,</span>
<span id="lst-setuppy-10"><a href="#lst-setuppy-10" aria-hidden="true" tabindex="-1"></a>        extra_compile_args<span class="op">=</span>[<span class="st">"-std=c++17"</span>],</span>
<span id="lst-setuppy-11"><a href="#lst-setuppy-11" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="lst-setuppy-12"><a href="#lst-setuppy-12" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="lst-setuppy-13"><a href="#lst-setuppy-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-setuppy-14"><a href="#lst-setuppy-14" aria-hidden="true" tabindex="-1"></a>setup(</span>
<span id="lst-setuppy-15"><a href="#lst-setuppy-15" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"ml_ops"</span>,</span>
<span id="lst-setuppy-16"><a href="#lst-setuppy-16" aria-hidden="true" tabindex="-1"></a>    ext_modules<span class="op">=</span>ext_modules,</span>
<span id="lst-setuppy-17"><a href="#lst-setuppy-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="lst-setuppy-18"><a href="#lst-setuppy-18" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p>运行:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate something like ml_ops.cpython-39-darwin.so</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> setup.py build_ext <span class="at">--inplace</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> main.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>运行结果:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="ex">2.0</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="ex">6.0</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="ex">True</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="ex">3.0</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="ex">10.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
</section>
<section id="build-tools-构建工具" class="level2">
<h2 class="anchored" data-anchor-id="build-tools-构建工具">Build Tools 构建工具</h2>
<section id="cmakelists" class="level3">
<h3 class="anchored" data-anchor-id="cmakelists">CMakeLists</h3>
<section id="一般工作流与设计哲学" class="level4">
<h4 class="anchored" data-anchor-id="一般工作流与设计哲学">一般工作流与设计哲学</h4>
<ul>
<li><p>典型工程结构 (<strong>Out-of-source build</strong>):</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode css code-with-copy"><code class="sourceCode css"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>myproj/</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>├── docs/           # 文档</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>├── CMakeLists<span class="fu">.txt</span>  # 所在文件绝对路径成为 CMAKE_SOURCE_DIR 的值</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>├── cmake/          # CMake 自身基础设施</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>│   └── FindXXX<span class="fu">.cmake</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>├── src/            # 核心源码</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>│   ├── module1/</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>│   │   ├── mod1<span class="fu">.cc</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>│   │   ├── mod1<span class="fu">.h</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>│   │   └── CMakeLists<span class="fu">.txt</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>│   ├── main<span class="fu">.cc</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>│   └── CMakeLists<span class="fu">.txt</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>├── include/        # 如果你写的是一个库的话就要这个</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>│   └── myproj/</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>│       └── api<span class="fu">.h</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>├── test/</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>│   ├── test_mod1<span class="fu">.cc</span></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>│   └── CMakeLists<span class="fu">.txt</span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>├── third_party/</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>├── tools/</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>└── build/</span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>    └── a<span class="fu">.out</span>       # You are here!</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>如果是 <strong>In-source build</strong>:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode css code-with-copy"><code class="sourceCode css"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>myproj/</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>├── main<span class="fu">.cpp</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>├── Makefile</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>└── a<span class="fu">.out</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>这样做会把编译生成的文件和源代码文件混在一起, 不推荐!</p></li>
</ul></li>
<li><p>典型工作流:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> <span class="at">-rf</span> build <span class="kw">&amp;&amp;</span> <span class="fu">mkdir</span> build</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> submodule init <span class="kw">&amp;&amp;</span> <span class="fu">git</span> submodule update</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> build</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cmake</span> ..</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> install</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><strong>配置阶段</strong>:
<ul>
<li>一般会在 <code>build/</code> 目录下运行: <code>cmake ..</code> 而不是在 CMAKE_SOURCE_DIR 目录下运行 <code>cmake .</code>!
<ul>
<li><code>build/</code> 的绝对路径会被 CMake 作为 CMAKE_BINARY_DIR.</li>
</ul></li>
<li>仅配置阶段生效的命令要格外注意! 配置完了改变文件不重新 <code>cmake ..</code> 的话是不会生效的!</li>
</ul></li>
<li><strong>构建阶段</strong></li>
</ul></li>
<li><p>一些 <strong>CMake built-in variables 内置变量</strong>:</p>
<ul>
<li><code>CMAKE_SOURCE_DIR</code>: <code>myproj/</code>.</li>
<li><code>CMAKE_BINARY_DIR</code>: <code>myproj/build/</code>.</li>
<li><code>CMAKE_CURRENT_SOURCE_DIR</code>: 非顶层 CMakeLists.txt 所在目录 (比如 <code>myproj/src/module1/</code>).</li>
<li><code>CMAKE_CURRENT_BINARY_DIR</code>: 非顶层 CMakeLists.txt 镜像到的 build 目录 (比如 <code>myproj/build/src/module1/</code>).</li>
</ul></li>
</ul>
</section>
<section id="cmakelists-作为计算机语言" class="level4">
<h4 class="anchored" data-anchor-id="cmakelists-作为计算机语言">CMakeLists 作为计算机语言</h4>
<blockquote class="blockquote">
<p>下面的命令都写在 <code>CMakeLists.txt</code> 里面, 并用: <code>cmake -P CMakeLists.txt</code> 运行.</p>
</blockquote>
<ul>
<li><p>基本操作:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode cmake code-with-copy"><code class="sourceCode cmake"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 赋值, 只有 string</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span>(A 123)          <span class="co"># A = "123"</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span>(MY_LIST a b c)  <span class="co"># 伪 List 类型, 不等价于 set(MY_LIST "abc")</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 打印</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="kw">message</span>(A)          <span class="co"># 输出: A (没有自动解引用! 同 message("A"))</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="kw">message</span>(<span class="dv">${A}</span>)       <span class="co"># 输出: 123</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="kw">message</span>(<span class="dv">${MY_LIST}</span>) <span class="co"># 输出: abc</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 追加字符</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="kw">list</span>(<span class="ot">APPEND</span> A 4)</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a><span class="kw">list</span>(<span class="ot">APPEND</span> MY_LIST de)</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a><span class="kw">message</span>(<span class="dv">${A}</span>)       <span class="co"># 输出: 1234</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="kw">message</span>(<span class="dv">${MY_LIST}</span>) <span class="co"># 输出: abcde</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>MACRO</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode cmake code-with-copy"><code class="sourceCode cmake"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># MACRO (纯文本展开!)</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="kw">macro</span>(my_macro x y)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">message</span>(<span class="st">"x=</span><span class="dv">${x}</span><span class="st">, y=</span><span class="dv">${y}</span><span class="st">"</span>)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span>(X 100)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="kw">endmacro</span>()</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span>(X 1)</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="kw">message</span>(<span class="dv">${X}</span>)       <span class="co"># 输出: 1</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="fu">my_macro</span>(<span class="dt">10 20</span>)     <span class="co"># 输出: x=10, y=20</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a><span class="kw">message</span>(<span class="dv">${X}</span>)       <span class="co"># 输出: 100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>FUNCTION</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode cmake code-with-copy"><code class="sourceCode cmake"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># FUNCTION</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span>(f a b)                 <span class="co"># f: 函数名. a,b: 形参</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">message</span>(<span class="st">"a=</span><span class="dv">${a}</span><span class="st">, b=</span><span class="dv">${b}</span><span class="st">"</span>)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">message</span>(<span class="dv">${ARGC}</span>)            <span class="co"># 参数个数, 是全局变量!</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">message</span>(<span class="dv">${ARGV}</span>)            <span class="co"># 所有参数列表, 是全局变量!</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">message</span>(<span class="dv">${ARGV0}</span>)           <span class="co"># 第0个参数, 是全局变量! 同理有 ARGV1, etc.</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">message</span>(<span class="dv">${ARGN}</span>)            <span class="co"># 额外参数列表, 是全局变量!</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span>(X 200)</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="kw">endfunction</span>()</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span>(X 2)</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>(q ww e r t)                   <span class="co"># 输出: a=q, b=ww</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>                                <span class="co">#       5</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>                                <span class="co">#       qwwert</span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>                                <span class="co">#       q</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>                                <span class="co">#       ert</span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a><span class="kw">message</span>(<span class="dv">${X}</span>)                   <span class="co"># 输出: 2 (函数内修改不影响外部变量)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>分支</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode cmake code-with-copy"><code class="sourceCode cmake"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 分支</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span>(MY_FLAG <span class="ot">ON</span>)         <span class="co"># 相当于 True, ON 也可以换成: 1, YES, TRUE, Y</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(MY_FLAG)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">message</span>(<span class="st">"true"</span>)     <span class="co"># 输出: true</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>()</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">message</span>(<span class="st">"false"</span>)    <span class="co"># 不会执行</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>在 <code>if()</code> 括号里面的还有很多常见判断 (遇到了知道什么意思就行), 比如:</li>
</ul>
<div class="sourceCode" id="cb62"><pre class="sourceCode cmake code-with-copy"><code class="sourceCode cmake"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(3 <span class="ot">GREATER</span> 2)         <span class="co"># 比较运算: GREATER, LESS, EQUAL, etc.</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="ot">DEFINED</span> VAR)         <span class="co"># 变量是否定义</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="ot">EXISTS</span> <span class="st">"</span><span class="dv">${CMAKE_SOURCE_DIR}</span><span class="st">/test.cc"</span>)    <span class="co"># CMAKE_SOURCE_DIR 是 CMakeLists.txt 所在目录</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
<section id="cmake-built-in-commands" class="level4">
<h4 class="anchored" data-anchor-id="cmake-built-in-commands">CMake Built-in Commands</h4>
<ul>
<li><p>命令的参数顺序: <strong>子命令 + 输入/变量 + 输入/变量</strong>. 以 <code>file()</code> 为例:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode cmake code-with-copy"><code class="sourceCode cmake"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">file</span>(<span class="ot">GLOB</span> MY_CSRCS *.c)     <span class="co"># GLOB (Global pattern matching): 子命令</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>                            <span class="co"># MY_CSRCS: 定义了一个变量</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>                            <span class="co"># *.c: 表示收集所有的 .c 文件</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><code>file()</code>: 文件操作</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode cmake code-with-copy"><code class="sourceCode cmake"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="kw">file</span>(<span class="ot">READ</span> version.txt VERSION)          <span class="co"># 读取 version.txt 并定义到变量 VERSION</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="kw">file</span>(<span class="ot">WRITE</span> output.txt <span class="st">"Hello World"</span>)    <span class="co"># 写入文件</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="kw">file</span>(<span class="ot">COPY</span>)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="kw">file</span>(<span class="ot">MAKE_DIRECTORY</span> <span class="dv">${CMAKE_BINARY_DIR}</span>/output) <span class="co"># 创建目录</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="kw">file</span>(<span class="ot">REMOVE</span> temp.txt)                   <span class="co"># 删除文件</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="kw">file</span>(<span class="ot">GLOB</span> MY_CSRCS *.c *.cpp *.cc)      <span class="co"># 收集当前目录所有符合模式的文件名到变量 MY_CSRCS</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="kw">file</span>(<span class="ot">GLOB_RECURSE</span> MY_SRCS src/*.c)      <span class="co"># src/ 的子目录中的 .c 也算 (仅配置阶段生效, 不建议使用)</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="kw">file</span>(<span class="ot">RELATIVE_PATH</span> MY_REL_PATH /a/b/c /a/b/e/f.json)   <span class="co"># MY_REL_PATH = ../e/f.json</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>其它常用命令:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode cmake code-with-copy"><code class="sourceCode cmake"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="kw">add_executable</span>(<span class="bn">myapp</span> main.cc utils.cc)  <span class="co"># 定义一个 target 可执行文件叫 myapp</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="kw">add_subdirectory</span>(ops)                   <span class="co"># 执行当前目录下的子目录 ops 中的 CMakeLists, 并把其中定义的 targets 加入当前构建图</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="kw">target_include_directories</span>(<span class="bn">mylib</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    <span class="ot">PUBLIC</span> include</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    <span class="ot">PRIVATE</span> src</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>) <span class="co"># target mylib 的头文件在 include/ 和 src/ 目录下. PRIVATE 表示只有 mylib 自己能用 src/ 目录下的头文件, PUBLIC 表示 mylib 的使用者也能用 include/ 目录下的头文件</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="kw">target_link_libraries</span>(<span class="bn">myapp</span> <span class="ot">PRIVATE</span> mylib)  <span class="co"># 定义 target myapp 依赖 mylib 库</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="kw">set_target_properties</span>(<span class="bn">myapp</span> <span class="ot">PROPERTIES</span> <span class="ot">RUNTIME_OUTPUT_DIRECTORY</span> <span class="dv">${CMAKE_BINARY_DIR}</span>/bin)    <span class="co"># 让 target myapp 的可执行文件输出到 build/bin/ 目录下</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a><span class="kw">install</span>(<span class="ot">TARGETS</span> <span class="bn">myapp</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>    <span class="ot">RUNTIME</span> <span class="ot">DESTINATION</span> bin</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>)   <span class="co"># 安装 target myapp 的可执行文件到系统的 bin/ 目录下 (一般是 /usr/local/bin/)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
</section>
<section id="makefile" class="level3">
<h3 class="anchored" data-anchor-id="makefile">Makefile</h3>
<ul>
<li><p>格式:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="dv">target:</span><span class="dt"> prerequisites</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="er">    </span>recipe</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>缺省规则</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="dt">.DEFAULT_GOAL</span> <span class="ch">:=</span><span class="st"> all</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="dv">all:</span><span class="dt"> ...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>伪规则</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="ot">.PHONY:</span><span class="dt"> all clean</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Append:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CFLAGS</span> <span class="ch">+=</span><span class="st"> -Wall -O2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>改后缀名:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="dt">SRCS_ASM</span> <span class="ch">=</span><span class="st"> start.S</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="dt">OBJS</span> <span class="ch">=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">SRCS_ASM</span><span class="kw">:</span><span class="ss">.S</span><span class="kw">=</span><span class="ss">.o</span><span class="ch">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>冒号前面和后面:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="dv">%.o :</span><span class="dt"> %.c</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="er">    </span><span class="ch">$(</span><span class="dt">CC</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">CFLAGS</span><span class="ch">)</span> -c <span class="ch">$&lt;</span> -o <span class="ch">$@</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>%</code> 为通配符, 意思是每当你需要一个 <code>.o</code> 文件, 并且当前目录下有对应的 <code>.c</code> 文件时, 就用下面的命令来生成它</li>
<li><code>$&lt;</code>: 第一个依赖文件</li>
<li><code>$@</code>: 目标文件</li>
<li><code>$^</code>: 所有依赖文件</li>
<li><code>$?</code>: 所有比目标文件新的依赖文件</li>
</ul></li>
<li><p>在 Makefile 里面调用 <code>make</code>: 建议用 <code>$(MAKE)</code> (不需要定义直接有).</p></li>
</ul>
</section>
<section id="bazel" class="level3">
<h3 class="anchored" data-anchor-id="bazel">Bazel</h3>
<section id="advantages" class="level4">
<h4 class="anchored" data-anchor-id="advantages">Advantages</h4>
<ul>
<li><strong>安装依赖方便</strong>
<ul>
<li>Bazel 有很多第三方库. 比如硬件开发要用的 <code>verilator</code>, 引用库后 <code>bazel build</code> 会自动下载这个工具链的可执行文件到当前目录下的比如 <code>./bazel-bin/external/verilator</code> 位置! 极其方便!</li>
</ul></li>
</ul>
</section>
<section id="usage" class="level4">
<h4 class="anchored" data-anchor-id="usage">Usage</h4>
<ul>
<li><strong>规则复用</strong>:
<ul>
<li><p><code>rules/</code> 下面放很多类似 Python 语言的 <code>.bzl</code> 规则函数库, 定义了如何从指定的输入生成目标文件, 可以在 <code>BUILD</code> 文件中引用 (<code>load()</code>) 这些函数, 然后调用它们.</p></li>
<li><p>用比如 <code>load("@rules_hdl//verilator:defs.bzl", "verilator_cc_library")</code> 来引用第三方规则库 (rules_hdl github 仓库位置需要先声明).</p></li>
<li><p><code>genrule</code>: 如果要在 <code>BUILD</code> 里面直接用命令行生成文件 (而不是引用 <code>rules/</code> 中的规则), 可以用 <code>genrule</code>:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>genrule(</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> <span class="st">"generate_file"</span>,</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>    srcs <span class="op">=</span> [<span class="st">"input.txt"</span>],</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    outs <span class="op">=</span> [<span class="st">"output.txt"</span>],</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    cmd <span class="op">=</span> <span class="st">"cp $(SRCS) $(OUTS)"</span>,</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
</ul>
</section>
</section>
</section>
<section id="project-management-项目管理" class="level2">
<h2 class="anchored" data-anchor-id="project-management-项目管理">Project Management 项目管理</h2>
<section id="python" class="level3">
<h3 class="anchored" data-anchor-id="python">Python</h3>
<section id="virtual-environments" class="level4">
<h4 class="anchored" data-anchor-id="virtual-environments">Virtual Environments</h4>
<ul>
<li><strong>Dependencies 依赖</strong></li>
</ul>
</section>
</section>
</section>
<section id="sec-coding-habits" class="level2">
<h2 class="anchored" data-anchor-id="sec-coding-habits">Coding Habits</h2>
<blockquote class="blockquote">
<p>下面是一些常见的编程习惯和技巧, 注意反过来的脑回路: 读到类似的这些代码的时候也要立即条件反射出来他们在干什么!</p>
</blockquote>
<section id="general" class="level3">
<h3 class="anchored" data-anchor-id="general">General</h3>
<ul>
<li>能引用尽量引用不要用指针!</li>
<li>函数的参数尽量少.</li>
<li>写程序的时候先关注主逻辑, 函数的实现放到最后写.</li>
<li><code>C++</code> 中 <code>namespace</code> 中的内容不要缩进.</li>
</ul>
</section>
<section id="检查相等" class="level3">
<h3 class="anchored" data-anchor-id="检查相等">检查相等</h3>
<ul>
<li>浮点数不能直接用 <code>==</code> 检查相等!
<ul>
<li>CPU 上一般用 <code>std::numeric_limits&lt;float&gt;::epsilon()</code> 作为误差.</li>
<li>CPU 和 GPU 运算结果比较时一般用绝对误差比如 <code>1e-8f</code> (库函数提供的可能会太严格).</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>is_equal_float.cc</strong></pre>
</div>
<div class="sourceCode" id="lst-is-equal-float" data-filename="is_equal_float.cc"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-is-equal-float-1"><a href="#lst-is-equal-float-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="lst-is-equal-float-2"><a href="#lst-is-equal-float-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-is-equal-float-3"><a href="#lst-is-equal-float-3" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> is_equal_float<span class="op">(</span></span>
<span id="lst-is-equal-float-4"><a href="#lst-is-equal-float-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">float</span> <span class="op">*</span>a<span class="op">,</span> </span>
<span id="lst-is-equal-float-5"><a href="#lst-is-equal-float-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">float</span> <span class="op">*</span>b</span>
<span id="lst-is-equal-float-6"><a href="#lst-is-equal-float-6" aria-hidden="true" tabindex="-1"></a><span class="op">)</span> <span class="op">{</span></span>
<span id="lst-is-equal-float-7"><a href="#lst-is-equal-float-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">float</span> eps_f <span class="op">=</span> <span class="bu">std::</span>numeric_limits<span class="op">&lt;</span><span class="dt">float</span><span class="op">&gt;::</span>epsilon<span class="op">();</span></span>
<span id="lst-is-equal-float-8"><a href="#lst-is-equal-float-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// const float eps_f = 1e-8f; // 比较 CPU 和 GPU 的计算结果.</span></span>
<span id="lst-is-equal-float-9"><a href="#lst-is-equal-float-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> diff <span class="op">=</span> <span class="bu">std::</span>fabs<span class="op">(*</span>a <span class="op">-</span> <span class="op">*</span>b<span class="op">);</span></span>
<span id="lst-is-equal-float-10"><a href="#lst-is-equal-float-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>diff <span class="op">&gt;</span> eps_f<span class="op">)</span> <span class="op">{</span></span>
<span id="lst-is-equal-float-11"><a href="#lst-is-equal-float-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">"Not Equal"</span> <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="lst-is-equal-float-12"><a href="#lst-is-equal-float-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="lst-is-equal-float-13"><a href="#lst-is-equal-float-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="lst-is-equal-float-14"><a href="#lst-is-equal-float-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">"Equal"</span> <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="lst-is-equal-float-15"><a href="#lst-is-equal-float-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="lst-is-equal-float-16"><a href="#lst-is-equal-float-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-is-equal-float-17"><a href="#lst-is-equal-float-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-is-equal-float-18"><a href="#lst-is-equal-float-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-is-equal-float-19"><a href="#lst-is-equal-float-19" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="lst-is-equal-float-20"><a href="#lst-is-equal-float-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> a <span class="op">=</span> <span class="fl">0.1</span><span class="bu">f</span> <span class="op">+</span> <span class="fl">0.3</span><span class="bu">f</span><span class="op">;</span></span>
<span id="lst-is-equal-float-21"><a href="#lst-is-equal-float-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> b <span class="op">=</span> <span class="fl">0.4</span><span class="bu">f</span><span class="op">;</span></span>
<span id="lst-is-equal-float-22"><a href="#lst-is-equal-float-22" aria-hidden="true" tabindex="-1"></a>    is_equal_float<span class="op">(&amp;</span>a<span class="op">,</span> <span class="op">&amp;</span>b<span class="op">);</span></span>
<span id="lst-is-equal-float-23"><a href="#lst-is-equal-float-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-is-equal-float-24"><a href="#lst-is-equal-float-24" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="正负无穷" class="level3">
<h3 class="anchored" data-anchor-id="正负无穷">正负无穷</h3>
<ul>
<li><p>涉及最小/最大值初始化. 例如我们要找 <code>arr</code> 中的最大值:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;float.h&gt;</span><span class="pp">   </span><span class="co">// for FLT_MAX</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> arr<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="fl">3.2</span><span class="op">,</span> <span class="op">-</span><span class="fl">1.5</span><span class="op">,</span> <span class="fl">7.8</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">4.4</span><span class="op">};</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> n <span class="op">=</span> <span class="kw">sizeof</span><span class="op">(</span>arr<span class="op">)</span> <span class="op">/</span> <span class="kw">sizeof</span><span class="op">(</span>arr<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> max_val <span class="op">=</span> <span class="op">-</span>FLT_MAX<span class="op">;</span>    <span class="co">// Initialize to -inf</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>arr<span class="op">[</span>i<span class="op">]</span> <span class="op">&gt;</span> max_val<span class="op">)</span>   max_val <span class="op">=</span> arr<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">"Max value: "</span> <span class="op">&lt;&lt;</span> max_val <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
<section id="向上取整" class="level3">
<h3 class="anchored" data-anchor-id="向上取整">向上取整</h3>
<ul>
<li>向上取整的操作非常常见, 比如 HPC 里面分配多少个 block 等. 可通过 <span class="math display">\[\left\lceil \frac{x}{y} \right\rceil = \left\lfloor \frac{x + y - 1}{y} \right\rfloor\]</span> 实现 (由于整数除法默认向下取整):</li>
</ul>
<div class="sourceCode" id="cb74"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> ceil_div<span class="op">(</span><span class="at">const</span> <span class="dt">int</span> x<span class="op">,</span> <span class="at">const</span> <span class="dt">int</span> y<span class="op">)</span> <span class="op">{</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">(</span>x <span class="op">+</span> y <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">/</span> y<span class="op">;</span> <span class="co">// Automatically does floor division</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="遍历数组和张量" class="level3">
<h3 class="anchored" data-anchor-id="遍历数组和张量">遍历数组和张量</h3>
<ul>
<li><p>看见下面的代码时要立刻意识到这不仅是一个循环, 而且是一个<strong>遍历</strong>!!!</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> N<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> M<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Process element at (i, j)</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="co">// for (int i = 1; i &lt;= N; i++) {} // 不推荐</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>for</code> 循环的边界: 从 <code>0</code> 开始计数而不是 <code>1</code>, 用 <code>&lt;</code> 而不是 <code>&lt;=</code>, 因为下标往往是从 <code>0</code> 开始的 (Matlab 除外), 如果用从 <code>1</code> 开始, 循环体里面还要减 <code>1</code>, 很麻烦.</li>
<li>TODO: 如何思考高阶张量的处理? 不要用 global 的 mental picture?</li>
</ul></li>
</ul>
</section>
<section id="全局索引与局部索引的转换" class="level3">
<h3 class="anchored" data-anchor-id="全局索引与局部索引的转换">全局索引与局部索引的转换</h3>
<ul>
<li>遇到下面这种形式的代码时, 要瞬间意识到这是在进行<strong>二维数组</strong>的 flatten/unflatten 操作!
<ul>
<li><p>Flattening:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode verilog code-with-copy"><code class="sourceCode verilog"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>lsu_index <span class="op">=</span> i * THREADS_PER_BLOCK <span class="op">+</span> j<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb77"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> idx <span class="op">=</span> blockIdx<span class="op">.</span>x <span class="op">*</span> blockDim<span class="op">.</span>x <span class="op">+</span> threadIdx<span class="op">.</span>x<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Unflattening:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> block_id <span class="op">=</span> idx <span class="op">/</span> block_dim<span class="op">;</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> thread_id <span class="op">=</span> idx <span class="op">%</span> block_dim<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
</ul>
</section>
<section id="命名习惯" class="level3">
<h3 class="anchored" data-anchor-id="命名习惯">命名习惯</h3>
<ul>
<li><p><code>k</code>: 用于常量变量 (constant variable), 例如 <code>const int kBufferSize = 1024;</code>.</p></li>
<li><p><code>foo(), bar()</code>: 表示程序员不想起名字 (就像 Alice 和 Bob).</p>
<ul>
<li>来源于 FUBAR (Fucked up beyond all recognition).</li>
</ul></li>
<li><p><strong>功能相似的函数和文件用前缀匹配</strong>: 比如用 <code>add_float()</code>, <code>add_float_vec()</code>, <code>add_int()</code> 而不是: <code>float_add()</code>, <code>vec_float_add()</code>, <code>int_add()</code>. 因为如果它们作为文件名的话, <strong>前缀 match</strong> 的文件会放在一起, 方便查找!</p></li>
</ul>
</section>
<section id="getters-和-setters" class="level3">
<h3 class="anchored" data-anchor-id="getters-和-setters">getters 和 Setters</h3>
<p>为了让外部代码访问和修改类的成员变量, 一种办法是将成员变量声明为 <code>public</code>, 但一旦外部代码写入了不合法的值, 就会导致类的状态变得不可预测. 因此我们用 <code>private</code> + getter/setter 的方式来控制对成员变量的访问和修改.</p>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>account_public.cpp</strong></pre>
</div>
<div class="sourceCode" id="lst-account_public" data-filename="account_public.cpp"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-account_public-1"><a href="#lst-account_public-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Account <span class="op">{</span></span>
<span id="lst-account_public-2"><a href="#lst-account_public-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="lst-account_public-3"><a href="#lst-account_public-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> balance<span class="op">;</span></span>
<span id="lst-account_public-4"><a href="#lst-account_public-4" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-account_public-5"><a href="#lst-account_public-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-account_public-6"><a href="#lst-account_public-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="lst-account_public-7"><a href="#lst-account_public-7" aria-hidden="true" tabindex="-1"></a>    Account acc<span class="op">;</span></span>
<span id="lst-account_public-8"><a href="#lst-account_public-8" aria-hidden="true" tabindex="-1"></a>    acc<span class="op">.</span>balance <span class="op">=</span> <span class="op">-</span><span class="dv">999999</span><span class="op">;</span> <span class="co">// Not recommended</span></span>
<span id="lst-account_public-9"><a href="#lst-account_public-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-account_public-10"><a href="#lst-account_public-10" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>account_private.cpp</strong></pre>
</div>
<div class="sourceCode" id="lst-account_private" data-filename="account_private.cpp"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="lst-account_private-1"><a href="#lst-account_private-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Account <span class="op">{</span></span>
<span id="lst-account_private-2"><a href="#lst-account_private-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="lst-account_private-3"><a href="#lst-account_private-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> balance<span class="op">;</span></span>
<span id="lst-account_private-4"><a href="#lst-account_private-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-account_private-5"><a href="#lst-account_private-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="lst-account_private-6"><a href="#lst-account_private-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// const: no modification to member variables</span></span>
<span id="lst-account_private-7"><a href="#lst-account_private-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> getBalance<span class="op">()</span> <span class="at">const</span> <span class="op">{</span> <span class="cf">return</span> balance<span class="op">;</span> <span class="op">}</span></span>
<span id="lst-account_private-8"><a href="#lst-account_private-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-account_private-9"><a href="#lst-account_private-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> deposit<span class="op">(</span><span class="dt">double</span> amount<span class="op">)</span> <span class="op">{</span></span>
<span id="lst-account_private-10"><a href="#lst-account_private-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>amount <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="lst-account_private-11"><a href="#lst-account_private-11" aria-hidden="true" tabindex="-1"></a>            balance <span class="op">+=</span> amount<span class="op">;</span></span>
<span id="lst-account_private-12"><a href="#lst-account_private-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="lst-account_private-13"><a href="#lst-account_private-13" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="lst-account_private-14"><a href="#lst-account_private-14" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="常写-const" class="level3">
<h3 class="anchored" data-anchor-id="常写-const">常写 <code>const</code></h3>
<ul>
<li><p>能加上 <code>const</code> 尽量加上 (比如 <a href="#lst-account_private" class="quarto-xref">Listing&nbsp;<span class="quarto-unresolved-ref">lst-account_private</span></a>), 比如<strong>函数声明时的参数列表、返回值和函数体</strong>, 这样尤其是参数有指针的函数可以一眼看出来哪些是可读、可写的.</p></li>
<li><p><code>const</code> 用法:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">int</span> <span class="op">*</span>p1<span class="op">;</span> <span class="co">// p1 本身可以修改, 但指向的内容不可以修改</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> <span class="op">*</span> <span class="at">const</span> p2<span class="op">;</span> <span class="co">// p2 本身不可以修改, 但指向的内容可以修改</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">int</span> <span class="op">*</span> <span class="at">const</span> p3<span class="op">;</span> <span class="co">// 都不能修改</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> <span class="at">const</span><span class="op">&amp;</span> my_int<span class="op">;</span> <span class="co">// 引用的内容不可以修改, 同 const int&amp;</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a><span class="co">// int &amp;const // 不合法</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><code>Pytorch C++ API</code> 中提供 <code>TORCH_ARG</code> 宏, 用于自动生成类成员变量的 getter 和 setter 方法:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;torch/torch.h&gt;</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>TORCH_ARG<span class="op">(</span><span class="dt">double</span><span class="op">,</span> balance<span class="op">)</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>自动展开为:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> <span class="va">balance_</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// getter</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span><span class="op">&amp;</span> balance<span class="op">()</span> <span class="at">const</span> <span class="op">{</span> <span class="cf">return</span> <span class="va">balance_</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// setter</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span><span class="op">&amp;</span> balance<span class="op">()</span> <span class="op">{</span> <span class="cf">return</span> <span class="va">balance_</span><span class="op">;</span> <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>这种写法类似 <a href="#lst-account_private" class="quarto-xref">Listing&nbsp;<span class="quarto-unresolved-ref">lst-account_private</span></a>, <code>const double&amp;</code> 意思是返回一个不可修改的引用 (若用值拷贝的话速度较慢). 第二个 <code>const</code> 表示 getter 方法本身不会修改这个类的<strong>所有</strong>成员变量 (<code>balance_</code> in this case). 用户可以通过 <code>obj.balance()</code> 来获取余额, 也可以通过 <code>obj.balance() = 100.0;</code> 来修改余额.</p></li>
<li><p><code>const</code> 和 <code>constexpr</code> 区别:</p>
<ul>
<li><code>constexpr</code> 变量在编译时就算出来了, 且不可修改. 一般用于<strong>性能优化</strong>或用作<strong>编译时才能决定声明的数组大小</strong>.</li>
</ul>
<div class="sourceCode" id="cb82"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">int</span> x <span class="op">=</span> some_runtime_function<span class="op">();</span> <span class="co">// 合法</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">int</span> y <span class="op">=</span> some_runtime_function<span class="op">();</span> <span class="co">// 不合法, 因为 some_runtime_function() 不是常量表达式</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">int</span> kTensorSize <span class="op">=</span> <span class="dv">256</span> <span class="op">*</span> <span class="dv">1024</span><span class="op">;</span> <span class="co">// 合法</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="dt">uint8_t</span> tensor<span class="op">[</span>kTensorSize<span class="op">];</span> <span class="co">// 编译时决定的数组大小</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
</section>
<section id="code-reading-techniques" class="level2">
<h2 class="anchored" data-anchor-id="code-reading-techniques">Code Reading &amp; Techniques</h2>
<blockquote class="blockquote">
<p>本人看代码的速度极慢, 为了优化这一点, 我打算建立本章来积累一些阅读代码的经验和技巧, 主要是消除阅读代码时的心理负担. 本章也与 <a href="../cc-coding/cc-coding.html#sec-coding-habits">Coding Habits</a> 有很多的重合之处, 以后可能会把两章合并 (TODO).</p>
</blockquote>
<section id="first-encounter" class="level3">
<h3 class="anchored" data-anchor-id="first-encounter">First Encounter</h3>
<ul>
<li><p>心理建设:</p>
<ul>
<li><strong>Take it Easy</strong>: 一个 <code>C++</code> project 不过是一堆 class 和一个 main.</li>
<li>大段代码其实逻辑不会很复杂, 要关注有没有类型检查、边界检查等等冗余代码. 还有 <code>if else</code> 语句只有一个会被执行, 另一半都是没用的.</li>
</ul></li>
<li><p>如果是 OOP, 关注类会<strong>改变</strong>哪些外部变量 (通常是引用传递) 而不是某个方法的具体实现.</p></li>
<li><p>先阅读接口函数 (一般会在 <code>.h</code> 文件中!). 如果直接看 <code>.cc</code> 文件, 会看到一些接口实现调用的函数, 而且这些函数会放在接口函数上面, 这样丢掉了重点.</p></li>
<li><p>关注参数列表的 <code>const</code>, 这意味着这些是只读的不会改变!</p></li>
<li><p>读懂参数的含义是一件费时的事情, 但很多时候费时的地方在弄懂信息的<strong>存储格式</strong>. 比如你看到:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> DepthwiseConvPerChannel<span class="op">(</span><span class="at">const</span> DepthwiseParam<span class="op">&amp;</span> params<span class="op">,</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>                             <span class="at">const</span> <span class="dt">int32_t</span><span class="op">*</span> output_multiplier<span class="op">,</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">const</span> <span class="dt">int32_t</span><span class="op">*</span> output_shift<span class="op">,</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">const</span> RuntimeShape<span class="op">&amp;</span> in_shape<span class="op">,</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>                             <span class="op">...)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>就会很想知道 <code>params</code>, <code>output_multiplier</code> 等里面到底是怎样的结构. 但请克制自己不要知道, 或者自己随便构思一个结构让自己相信它是对的! 因为这些数据结构的实现非常 ad hoc 而且不重要.</p></li>
<li><p>不要一行一行读代码, 要<strong>功能性</strong>地读代码. 比如:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> relu_f32 <span class="op">(</span>torch<span class="op">::</span>Tensor input<span class="op">,</span> torch<span class="op">::</span>Tensor output<span class="op">)</span> <span class="op">{</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>x<span class="op">.</span>options<span class="op">().</span>dtype<span class="op">()</span> <span class="op">!=</span> torch<span class="op">::</span>kFloat32<span class="op">)</span> <span class="op">{</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">"Tensor info: "</span> <span class="op">&lt;&lt;</span> x<span class="op">.</span>options<span class="op">()</span> <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"Input tensor must be torch::kFloat32"</span><span class="op">);</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>y<span class="op">.</span>options<span class="op">().</span>dtype<span class="op">()</span> <span class="op">!=</span> torch<span class="op">::</span>kFloat32<span class="op">)</span> <span class="op">{</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">"Tensor info: "</span> <span class="op">&lt;&lt;</span> y<span class="op">.</span>options<span class="op">()</span> <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"Output tensor must be torch::kFloat32"</span><span class="op">);</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>这个代码是在检查数据类型, 当你知道这一点时就别在纠结 <code>options()</code> 是什么了.</p></li>
<li><p>当一个 <code>cpp</code> 文件有多个函数定义时, 一般最下面的函数才是对外暴露的接口 (因为它调用了上面的函数), 先看最下面的函数.</p>
<ul>
<li>如果有很多个名字差不多的函数, 最短的那个将是对其它的封装, 比如:</li>
</ul>
<div class="sourceCode" id="cb85"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> _relu_f32_kernel<span class="op">(...)</span> <span class="op">{</span> <span class="op">...</span> <span class="op">}</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>__global__ <span class="dt">void</span> relu_f32_kernel<span class="op">(...)</span> <span class="op">{</span> <span class="op">...</span> <span class="op">}</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> relu_f32_util<span class="op">(...)</span> <span class="op">{</span> <span class="op">...</span> <span class="op">}</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> relu_f32<span class="op">(...)</span> <span class="op">{</span> <span class="op">...</span> <span class="op">}</span> <span class="co">// True API</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>单从名字上来看, <code>_relu_f32_kernel()</code> 仅给 <code>relu_f32_kernel()</code> 使用 (因为有下划线而且重名); 而 <code>relu_f32</code> 封装了 <code>relu_f32_kernel</code> 和 <code>relu_f32_util</code> (因为名字 match 前缀且更短).</p></li>
<li><p><strong>对象作为元数据</strong>: 比如 <code>torch::Tensor</code> 这个对象里并不是 tensor 数据本身, 而是:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>Tensor</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>├─ sizes</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>├─ strides</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>├─ dtype</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>├─ device</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>└─ data_ptr  ---&gt; 实际数据的指针</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>所以你会看到很多 <code>tensor.data_ptr()</code> 这样看上去取了两次数据的感觉, 其实第一层的 <code>tensor</code> 只是元数据, 第二层才是实际数据.</li>
</ul></li>
</ul>
</section>
<section id="rtl-代码阅读" class="level3">
<h3 class="anchored" data-anchor-id="rtl-代码阅读">RTL 代码阅读</h3>
<ul>
<li>下面的 Verilog 代码片段说明这个模块有<strong>两个功能</strong>, 功能的启用由 <code>&lt;func&gt;_enable</code> 决定; 每个功能是一个 <strong>3 个状态的 FSM</strong>.
<ul>
<li>如果 <code>...</code> 的部分没有什么 operation, 只有将<strong>输入赋值给输出</strong>的操作, 那么这个模块其实就是一个<strong>有条件的连接器</strong>而已!! 如果有 splitter 之类的就有 decoder 的功能.</li>
</ul>
<div class="sourceCode" id="cb87"><pre class="sourceCode verilog code-with-copy"><code class="sourceCode verilog"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> <span class="op">(</span>xxx_enable<span class="op">)</span> <span class="kw">begin</span> </span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> <span class="op">(</span>state<span class="op">)</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>        <span class="dv">A:</span> <span class="kw">begin</span> ... lsu_state <span class="op">&lt;=</span> B<span class="op">;</span> <span class="kw">end</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>        <span class="dv">B:</span> <span class="kw">begin</span> ... lsu_state <span class="op">&lt;=</span> C<span class="op">;</span> <span class="kw">end</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>        <span class="dv">C:</span> <span class="kw">begin</span> ... lsu_state <span class="op">&lt;=</span> A<span class="op">;</span> <span class="kw">end</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">endcase</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> <span class="op">(</span>yyy_enable<span class="op">)</span> <span class="kw">begin</span> </span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> <span class="op">(</span>state<span class="op">)</span></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>        <span class="dv">A:</span> <span class="kw">begin</span> ... lsu_state <span class="op">&lt;=</span> B<span class="op">;</span> <span class="kw">end</span></span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>        <span class="dv">B:</span> <span class="kw">begin</span> ... lsu_state <span class="op">&lt;=</span> C<span class="op">;</span> <span class="kw">end</span></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>        <span class="dv">C:</span> <span class="kw">begin</span> ... lsu_state <span class="op">&lt;=</span> A<span class="op">;</span> <span class="kw">end</span></span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">endcase</span></span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
</section>
<section id="verilog" class="level2">
<h2 class="anchored" data-anchor-id="verilog">Verilog</h2>
<blockquote class="blockquote">
<p><strong><em>Change of Mind:</em></strong> Hardware does not “execute” the lines of code in sequence.</p>
</blockquote>
<blockquote class="blockquote">
<p>下文不严格区分 Verilog 和 SystemVerilog (你可以当作都是 SystemVerilog).</p>
</blockquote>
<section id="verilog-basics" class="level3">
<h3 class="anchored" data-anchor-id="verilog-basics">Verilog Basics</h3>
<ul>
<li><p><code>assign</code></p>
<ul>
<li>多个 <code>assign</code> 执行<strong>没有顺序</strong>, 同时进行.</li>
<li><code>assign</code> 是 “continuous assignment”, 右值变化时, 左值跟着变化.</li>
</ul></li>
<li><p><strong>Operation 运算符</strong>: <code>~</code>, <code>!</code> (logical), <code>&amp;</code>, <code>&amp;&amp;</code> (logical), <code>|</code>, <code>||</code> (logical), <code>^</code> (XOR).</p></li>
<li><p><code>if, else if</code> 是有顺序的!!!</p></li>
<li><p>(procedure 一定要放在 always 块中吗?)</p></li>
<li><p>(为什么 wire 类型不能在 always 里面被赋值?)</p></li>
<li><p><code>always</code> 块中的代码是<strong>顺序执行</strong>的 (但在 <code>always</code> 块外的代码是<strong>并行执行</strong>的).</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode verilog code-with-copy"><code class="sourceCode verilog"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> top <span class="op">(</span><span class="dt">input</span> my_in<span class="op">,</span> <span class="dt">output</span> <span class="dt">reg</span> my_out<span class="op">);</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">always</span> <span class="op">@(</span>*<span class="op">)</span> <span class="kw">begin</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>        my_out <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>        my_out <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// This is valid! (Always block 按顺序执行)</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="kw">endmodule</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p><strong>Latch 推断</strong>: 下面如果 <code>cpu_overheated = 0</code> 则默认会让 <code>shut_off_computer</code> 保持上一个值, 这就是 latch 推断.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode verilog code-with-copy"><code class="sourceCode verilog"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="kw">always</span> <span class="op">@(</span>*<span class="op">)</span> <span class="kw">begin</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>cpu_overheated<span class="op">)</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>        shut_off_computer <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>有时我们就是需要这种推断, 但为了避免, 可以利用always 的顺序性先提前赋值:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode verilog code-with-copy"><code class="sourceCode verilog"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="kw">always</span> <span class="op">@(</span>*<span class="op">)</span> <span class="kw">begin</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>    shut_off_computer <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// 先提前赋值</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>cpu_overheated<span class="op">)</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>        shut_off_computer <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><p><code>input a</code> 默认为 <code>wire</code>.</p></li>
<li><p><code>begin end</code> 在只有一行代码时可以省略 (相当于 C 中的 <code>{}</code>).</p></li>
<li><p><code>wire</code> 不能在 <code>always</code> 块中被赋值. <code>reg</code> 才能在 <code>always</code> 中被赋值.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode verilog code-with-copy"><code class="sourceCode verilog"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="dt">wire</span> a<span class="op">;</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="kw">always</span> <span class="op">@(</span>*<span class="op">)</span> <span class="kw">begin</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">assign</span> a <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// Error!</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb92"><pre class="sourceCode verilog code-with-copy"><code class="sourceCode verilog"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="dt">wire</span> a<span class="op">;</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="kw">always</span> <span class="op">@(</span>*<span class="op">)</span> <span class="kw">begin</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>    a <span class="op">&lt;=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// Not an error, `a` is viewed as a reg.</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Synchronous and Asynchronous Reset</strong>:</p>
<ul>
<li><p>synchronous reset:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode verilog code-with-copy"><code class="sourceCode verilog"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="kw">always</span> <span class="op">@(</span><span class="kw">posedge</span> clk<span class="op">)</span> <span class="kw">begin</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>reset<span class="op">)</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>asynchronous reset:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode verilog code-with-copy"><code class="sourceCode verilog"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="kw">always</span> <span class="op">@(</span><span class="kw">posedge</span> clk <span class="dt">or</span> <span class="kw">posedge</span> reset<span class="op">)</span> <span class="kw">begin</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>reset<span class="op">)</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><p><code>or</code> <strong>只能</strong>在 <code>always</code> 块中使用, <code>if ()</code> 中要用 <code>||</code>.</p></li>
<li><p><strong>Inference</strong> 和 <strong>Instantiation</strong>:</p>
<ul>
<li><p><strong>Inference</strong>: 通过 <code>always</code> 块的内容推断出一个模块的功能.</p></li>
<li><p><strong>Instantiation</strong>: 显式地实例化一个模块, 通过 <code>module_name instance_name (port_map)</code> 的方式:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode verilog code-with-copy"><code class="sourceCode verilog"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>fetcher #<span class="op">(</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>    .PROGRAM_MEM_ADDR_BITS<span class="op">(</span>PROGRAM_MEM_ADDR_BITS<span class="op">),</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>    .PROGRAM_MEM_DATA_BITS<span class="op">(</span>PROGRAM_MEM_DATA_BITS<span class="op">)</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="op">)</span> fetcher_instance <span class="op">(</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>    .clk<span class="op">(</span>clk<span class="op">),</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>    .reset<span class="op">(</span>reset<span class="op">),</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>    .core_state<span class="op">(</span>core_state<span class="op">),</span></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>    .current_pc<span class="op">(</span>current_pc<span class="op">),</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>注意 <code>port_map</code> 左侧是模块内的端口名, 右侧是当前作用域内的信号名 (不一定要一样).</li>
<li><code>#(...)</code> 是 <code>systemverilog</code> 的语法, 用来<strong>传递参数</strong>. 同样, 右侧是当前作用域内的参数名.
<ul>
<li>所以也可以写成: <code>.PROGRAM_MEM_ADDR_BITS(8)</code>.</li>
</ul></li>
</ul></li>
</ul></li>
<li><p>循环群结构 (Torus, etc) 如果用 <code>%</code> 运算符来处理会消耗大量资源, <strong>尽量用 <code>if</code> 语句</strong>:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode verilog code-with-copy"><code class="sourceCode verilog"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> <span class="op">(</span>mm <span class="op">==</span> <span class="bn">8'd59</span><span class="op">)</span> <span class="kw">begin</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>    mm <span class="op">&lt;=</span> <span class="bn">8'd0</span><span class="op">;</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>如果用 <code>%</code> 运算符来处理:
<ul>
<li><code>-1 % 16</code> 的结果是 <code>-1</code>, 而不是 <code>15</code> (所以 <code>(a-1)%16</code> 应该写成 <code>(a+15)%16</code>).</li>
<li>1~12 的循环先转换为 0~11 的循环, 再换元.</li>
</ul></li>
</ul></li>
<li><p><strong>BCD (Binary-Coded Decimal)</strong>: 一种从 0 到 9 的计数器, 输出是四位二进制编码的十进制数.</p></li>
<li><p><strong>Blocking 和 Non-blocking assignments</strong>:</p>
<ul>
<li><code>=</code>: Blocking assignment, 若在 <code>always</code> 块中使用, 则必须按照顺序执行!</li>
<li><code>&lt;=</code>: Non-blocking assignment, 在 <code>always</code> 块中使用时, 会同时执行所有赋值. (一般 <code>always</code> 里面都用这个!)</li>
</ul></li>
</ul>
</section>
<section id="verilog-向量" class="level3">
<h3 class="anchored" data-anchor-id="verilog-向量">Verilog 向量</h3>
<ul>
<li><p>一个易错点</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode verilog code-with-copy"><code class="sourceCode verilog"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="dt">reg</span> <span class="op">[</span><span class="dv">7</span><span class="op">:</span><span class="dv">0</span><span class="op">]</span> foo<span class="op">;</span>      <span class="co">// foo[i] 是 1 bit</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="dt">reg</span> <span class="op">[</span><span class="dv">7</span><span class="op">:</span><span class="dv">0</span><span class="op">]</span> foo<span class="op">[</span><span class="dv">3</span><span class="op">:</span><span class="dv">0</span><span class="op">];</span> <span class="co">// foo[i] 是 8 bit</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>index 可以是负数:</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode verilog code-with-copy"><code class="sourceCode verilog"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="dt">reg</span> <span class="op">[</span><span class="dv">5</span><span class="op">:-</span><span class="dv">1</span><span class="op">]</span> my_reg<span class="op">;</span> <span class="co">// index 可以是负数.</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="dt">wire</span> <span class="op">[</span><span class="dv">0</span><span class="op">:</span><span class="dv">3</span><span class="op">]</span> my_wire<span class="op">;</span> <span class="co">// Big-endian, mywire[0] is MSB, use my_wire[3:0] later is illegal!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Concatenation</strong>:</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode verilog code-with-copy"><code class="sourceCode verilog"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="kw">assign</span> out <span class="op">=</span> <span class="op">{</span>tmp<span class="op">,</span> <span class="op">{</span><span class="dv">3</span><span class="op">{</span><span class="bn">3'b100</span><span class="op">}}};</span> <span class="co">// Concatenation, out = 0000011 100 100 100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
<section id="硬件代码生成" class="level3">
<h3 class="anchored" data-anchor-id="硬件代码生成">硬件代码生成</h3>
<ul>
<li><code>generate for</code> 块: 用于生成重复的硬件结构 (只是偷懒, 不用写重复的相似代码). (下文两个代码块是等价的, 其中 <code>gen_regs</code> 只是一个 label, 可以随便取名)</li>
</ul>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="sourceCode" id="cb100"><pre class="sourceCode verilog code-with-copy"><code class="sourceCode verilog"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="dt">genvar</span> i<span class="op">;</span> <span class="co">// 只用于生成硬件结构的循环变量</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="kw">generate</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">4</span><span class="op">;</span> i <span class="op">=</span> i <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="kw">begin :</span><span class="dt"> gen_regs</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">always</span> <span class="op">@(</span><span class="kw">posedge</span> clk<span class="op">)</span> <span class="kw">begin</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>            q<span class="op">[</span>i<span class="op">]</span> <span class="op">&lt;=</span> d<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">end</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a><span class="kw">endgenerate</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="sourceCode" id="cb101"><pre class="sourceCode verilog code-with-copy"><code class="sourceCode verilog"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="kw">always</span> <span class="op">@(</span><span class="kw">posedge</span> clk<span class="op">)</span> q<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">&lt;=</span> d<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="kw">always</span> <span class="op">@(</span><span class="kw">posedge</span> clk<span class="op">)</span> q<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">&lt;=</span> d<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="kw">always</span> <span class="op">@(</span><span class="kw">posedge</span> clk<span class="op">)</span> q<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">&lt;=</span> d<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="kw">always</span> <span class="op">@(</span><span class="kw">posedge</span> clk<span class="op">)</span> q<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">&lt;=</span> d<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<ul>
<li><code>generate if</code> 块: 用于根据参数生成不同的硬件结构.</li>
</ul>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="sourceCode" id="cb102"><pre class="sourceCode verilog code-with-copy"><code class="sourceCode verilog"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> reg1 #<span class="op">(</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">parameter</span> bit USE_RESET <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="op">)(</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">input</span>  logic clk<span class="op">,</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">input</span>  logic rstn<span class="op">,</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">input</span>  logic d<span class="op">,</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">output</span> logic q</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a><span class="kw">generate</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>USE_RESET<span class="op">)</span> <span class="kw">begin</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">always</span> <span class="op">@(</span><span class="kw">posedge</span> clk <span class="dt">or</span> <span class="kw">negedge</span> rstn<span class="op">)</span> <span class="kw">begin</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span> <span class="op">(!</span>rstn<span class="op">)</span></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>                q <span class="op">&lt;=</span> <span class="bn">1'b0</span><span class="op">;</span></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>            <span class="kw">else</span></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>                q <span class="op">&lt;=</span> d<span class="op">;</span></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">end</span></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span> <span class="kw">else</span> <span class="kw">begin</span></span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">always</span> <span class="op">@(</span><span class="kw">posedge</span> clk<span class="op">)</span> <span class="kw">begin</span></span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a>            q <span class="op">&lt;=</span> d<span class="op">;</span></span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">end</span></span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a><span class="kw">endgenerate</span></span>
<span id="cb102-23"><a href="#cb102-23" aria-hidden="true" tabindex="-1"></a><span class="kw">endmodule</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="sourceCode" id="cb103"><pre class="sourceCode verilog code-with-copy"><code class="sourceCode verilog"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> reg1 <span class="op">(</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">input</span>  logic clk<span class="op">,</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">input</span>  logic rstn<span class="op">,</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">input</span>  logic d<span class="op">,</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">output</span> logic q</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a><span class="kw">always</span> <span class="op">@(</span><span class="kw">posedge</span> clk <span class="dt">or</span> <span class="kw">negedge</span> rstn<span class="op">)</span> <span class="kw">begin</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(!</span>rstn<span class="op">)</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>        q <span class="op">&lt;=</span> <span class="bn">1'b0</span><span class="op">;</span></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>        q <span class="op">&lt;=</span> d<span class="op">;</span></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a><span class="kw">endmodule</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
<section id="systemverilog-函数" class="level3">
<h3 class="anchored" data-anchor-id="systemverilog-函数">Systemverilog 函数</h3>
<ul>
<li><p><code>$clog_2</code>: 向上取整的 <span class="math inline">\(\log_2(\cdot)\)</span>, 比如:</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode verilog code-with-copy"><code class="sourceCode verilog"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="dt">input</span> <span class="dt">wire</span> <span class="op">[</span><span class="dt">$clog2</span><span class="op">(</span>THREADS_PER_BLOCK<span class="op">):</span><span class="dv">0</span><span class="op">]</span> thread_count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
<section id="verilog-testbench" class="level3">
<h3 class="anchored" data-anchor-id="verilog-testbench">Verilog Testbench</h3>
<div class="sourceCode" id="cb105"><pre class="sourceCode verilog code-with-copy"><code class="sourceCode verilog"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="ot">`timescale 1ns / 1ps </span><span class="co">// #1 代表 1ns, 最精确可以到 #1.001</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="ot">`timescale 1ns / 1ns </span><span class="co">// #1 代表 1ns, #1.01 等是不合法的</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="dt">$stop</span> <span class="co">//停下来</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="chisel" class="level2">
<h2 class="anchored" data-anchor-id="chisel">Chisel</h2>
<ul>
<li><p><code>+&amp;</code>: 如果 <code>io.in_a</code> 和 <code>io.in_b</code> 为 <code>4.W</code> 时, 则 <code>sum</code> 为 <code>5.W</code> (带溢出).</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> sum <span class="op">=</span> io<span class="op">.</span>in_a <span class="op">+&amp;</span> io<span class="op">.</span>in_b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>允许多个 <code>:=</code> 赋值到同一个输出:</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>io<span class="op">.</span>out <span class="op">:=</span> <span class="fl">0.</span>U</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>io<span class="op">.</span>out <span class="op">:=</span> <span class="fl">1.</span>U <span class="co">// 覆盖上一个</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><code>if</code> 和 <code>when</code> 的区别:</p>
<ul>
<li><code>if</code> 用来在编译阶段决定电路是哪一种</li>
<li><code>when</code> 用来生成固定的 verilog 电路, 相当于 verilog 的 <code>if</code>.</li>
</ul></li>
<li><p><code>orR</code>: reduction OR, 对所有位进行 OR 操作. 比如 GPR 读寄存器时, 只要地址不是全 0，就读出寄存器的值 (即创建了一个虚拟的 x0 寄存器，值恒为 0):</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>io<span class="op">.</span>rdata1 <span class="op">:=</span> <span class="fu">Mux</span><span class="op">(</span>io<span class="op">.</span>raddr1<span class="op">.</span>orR<span class="op">,</span> <span class="fu">regs</span><span class="op">(</span>io<span class="op">.</span>raddr1<span class="op">),</span> <span class="fl">0.</span>U<span class="op">)</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>io<span class="op">.</span>rdata2 <span class="op">:=</span> <span class="fu">Mux</span><span class="op">(</span>io<span class="op">.</span>raddr2<span class="op">.</span>orR<span class="op">,</span> <span class="fu">regs</span><span class="op">(</span>io<span class="op">.</span>raddr2<span class="op">),</span> <span class="fl">0.</span>U<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
<section id="area-optimization-面积优化方法" class="level3">
<h3 class="anchored" data-anchor-id="area-optimization-面积优化方法">Area Optimization 面积优化方法</h3>
<blockquote class="blockquote">
<p>有时可读性强的代码会导致使用的逻辑门更多, 占用更多面积. 所以一个模块有时会写两种版本, 一种是可读性强的, 另一种是面积优化的版本.</p>
</blockquote>
<section id="cse-公共子表达式消除" class="level4">
<h4 class="anchored" data-anchor-id="cse-公共子表达式消除">CSE 公共子表达式消除</h4>
<p><strong>Common Subexpression Elimination</strong> 也是编译器优化的一种. 举个简单的例子:</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> x <span class="op">=</span> a <span class="op">+</span> b<span class="op">;</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> y <span class="op">=</span> a <span class="op">+</span> b<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>可以优化为:</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> temp <span class="op">=</span> a <span class="op">+</span> b<span class="op">;</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> x <span class="op">=</span> temp<span class="op">;</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> y <span class="op">=</span> temp<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>这样就避免了重复计算 <code>a + b</code> 两次.</p>
<p>在 RTL 设计中, 比如 <a href="#lst-AddSubSimple" class="quarto-xref">Listing&nbsp;<span class="quarto-unresolved-ref">lst-AddSubSimple</span></a> 这个简单的加减法模块, <strong>注意到 “减法” 其实等价于 “加上 B 的补码”</strong>, 可以得到更优化的版本 <a href="#lst-AddSubArea" class="quarto-xref">Listing&nbsp;<span class="quarto-unresolved-ref">lst-AddSubArea</span></a>:</p>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>AddSubSimple.scala</strong></pre>
</div>
<div class="sourceCode" id="lst-AddSubSimple" data-filename="AddSubSimple.scala"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="lst-AddSubSimple-1"><a href="#lst-AddSubSimple-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AddSubSimple <span class="kw">extends</span> Module <span class="op">{</span></span>
<span id="lst-AddSubSimple-2"><a href="#lst-AddSubSimple-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> io <span class="op">=</span> <span class="fu">IO</span><span class="op">(</span><span class="kw">new</span> Bundle <span class="op">{</span></span>
<span id="lst-AddSubSimple-3"><a href="#lst-AddSubSimple-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> a <span class="op">=</span> <span class="fu">Input</span><span class="op">(</span><span class="fu">UInt</span><span class="op">(</span><span class="fl">8.</span>W<span class="op">))</span></span>
<span id="lst-AddSubSimple-4"><a href="#lst-AddSubSimple-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> b <span class="op">=</span> <span class="fu">Input</span><span class="op">(</span><span class="fu">UInt</span><span class="op">(</span><span class="fl">8.</span>W<span class="op">))</span></span>
<span id="lst-AddSubSimple-5"><a href="#lst-AddSubSimple-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> sub <span class="op">=</span> <span class="fu">Input</span><span class="op">(</span><span class="fu">Bool</span><span class="op">())</span>   <span class="co">// true 表示减法</span></span>
<span id="lst-AddSubSimple-6"><a href="#lst-AddSubSimple-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> out <span class="op">=</span> <span class="fu">Output</span><span class="op">(</span><span class="fu">UInt</span><span class="op">(</span><span class="fl">8.</span>W<span class="op">))</span></span>
<span id="lst-AddSubSimple-7"><a href="#lst-AddSubSimple-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">})</span></span>
<span id="lst-AddSubSimple-8"><a href="#lst-AddSubSimple-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-AddSubSimple-9"><a href="#lst-AddSubSimple-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 两个独立运算单元</span></span>
<span id="lst-AddSubSimple-10"><a href="#lst-AddSubSimple-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> addRes <span class="op">=</span> io<span class="op">.</span>a <span class="op">+</span> io<span class="op">.</span>b</span>
<span id="lst-AddSubSimple-11"><a href="#lst-AddSubSimple-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> subRes <span class="op">=</span> io<span class="op">.</span>a <span class="op">-</span> io<span class="op">.</span>b</span>
<span id="lst-AddSubSimple-12"><a href="#lst-AddSubSimple-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-AddSubSimple-13"><a href="#lst-AddSubSimple-13" aria-hidden="true" tabindex="-1"></a>  io<span class="op">.</span>out <span class="op">:=</span> <span class="fu">Mux</span><span class="op">(</span>io<span class="op">.</span>sub<span class="op">,</span> subRes<span class="op">,</span> addRes<span class="op">)</span></span>
<span id="lst-AddSubSimple-14"><a href="#lst-AddSubSimple-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-AddSubSimple-15"><a href="#lst-AddSubSimple-15" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>AddSubArea.scala</strong></pre>
</div>
<div class="sourceCode" id="lst-AddSubArea" data-filename="AddSubArea.scala"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="lst-AddSubArea-1"><a href="#lst-AddSubArea-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AddSubOptimized <span class="kw">extends</span> Module <span class="op">{</span></span>
<span id="lst-AddSubArea-2"><a href="#lst-AddSubArea-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> io <span class="op">=</span> <span class="fu">IO</span><span class="op">(</span><span class="kw">new</span> Bundle <span class="op">{</span></span>
<span id="lst-AddSubArea-3"><a href="#lst-AddSubArea-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> a <span class="op">=</span> <span class="fu">Input</span><span class="op">(</span><span class="fu">UInt</span><span class="op">(</span><span class="fl">8.</span>W<span class="op">))</span></span>
<span id="lst-AddSubArea-4"><a href="#lst-AddSubArea-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> b <span class="op">=</span> <span class="fu">Input</span><span class="op">(</span><span class="fu">UInt</span><span class="op">(</span><span class="fl">8.</span>W<span class="op">))</span></span>
<span id="lst-AddSubArea-5"><a href="#lst-AddSubArea-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> sub <span class="op">=</span> <span class="fu">Input</span><span class="op">(</span><span class="fu">Bool</span><span class="op">())</span></span>
<span id="lst-AddSubArea-6"><a href="#lst-AddSubArea-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> out <span class="op">=</span> <span class="fu">Output</span><span class="op">(</span><span class="fu">UInt</span><span class="op">(</span><span class="fl">8.</span>W<span class="op">))</span></span>
<span id="lst-AddSubArea-7"><a href="#lst-AddSubArea-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">})</span></span>
<span id="lst-AddSubArea-8"><a href="#lst-AddSubArea-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-AddSubArea-9"><a href="#lst-AddSubArea-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 如果是减法，就取 -B；否则取 B</span></span>
<span id="lst-AddSubArea-10"><a href="#lst-AddSubArea-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> b_eff <span class="op">=</span> <span class="fu">Mux</span><span class="op">(</span>io<span class="op">.</span>sub<span class="op">,</span> <span class="op">-</span>io<span class="op">.</span>b<span class="op">,</span> io<span class="op">.</span>b<span class="op">)</span></span>
<span id="lst-AddSubArea-11"><a href="#lst-AddSubArea-11" aria-hidden="true" tabindex="-1"></a>  io<span class="op">.</span>out <span class="op">:=</span> io<span class="op">.</span>a <span class="op">+</span> b_eff</span>
<span id="lst-AddSubArea-12"><a href="#lst-AddSubArea-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="lst-AddSubArea-13"><a href="#lst-AddSubArea-13" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>对比他们两个 <code>sbt</code> 出来的 <code>verilog</code> 代码:</p>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>AddSubSimple.v</strong></pre>
</div>
<div class="sourceCode" id="cb111" data-filename="AddSubSimple.v"><pre class="sourceCode verilog code-with-copy"><code class="sourceCode verilog"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> AddSubSimple<span class="op">(</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">input</span>        clock<span class="op">,</span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">input</span>        reset<span class="op">,</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">input</span>  <span class="op">[</span><span class="dv">7</span><span class="op">:</span><span class="dv">0</span><span class="op">]</span> io_a<span class="op">,</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">input</span>  <span class="op">[</span><span class="dv">7</span><span class="op">:</span><span class="dv">0</span><span class="op">]</span> io_b<span class="op">,</span></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">input</span>        io_sub<span class="op">,</span></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">output</span> <span class="op">[</span><span class="dv">7</span><span class="op">:</span><span class="dv">0</span><span class="op">]</span> io_out</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">wire</span> <span class="op">[</span><span class="dv">7</span><span class="op">:</span><span class="dv">0</span><span class="op">]</span> addRes <span class="op">=</span> io_a <span class="op">+</span> io_b<span class="op">;</span></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">wire</span> <span class="op">[</span><span class="dv">7</span><span class="op">:</span><span class="dv">0</span><span class="op">]</span> subRes <span class="op">=</span> io_a <span class="op">-</span> io_b<span class="op">;</span></span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">assign</span> io_out <span class="op">=</span> io_sub <span class="op">?</span> subRes <span class="op">:</span> addRes<span class="op">;</span></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a><span class="kw">endmodule</span></span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>AddSubArea.v</strong></pre>
</div>
<div class="sourceCode" id="cb112" data-filename="AddSubArea.v"><pre class="sourceCode verilog code-with-copy"><code class="sourceCode verilog"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> AddSubArea<span class="op">(</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">input</span>        clock<span class="op">,</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">input</span>        reset<span class="op">,</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">input</span>  <span class="op">[</span><span class="dv">7</span><span class="op">:</span><span class="dv">0</span><span class="op">]</span> io_a<span class="op">,</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">input</span>  <span class="op">[</span><span class="dv">7</span><span class="op">:</span><span class="dv">0</span><span class="op">]</span> io_b<span class="op">,</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">input</span>        io_sub<span class="op">,</span></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">output</span> <span class="op">[</span><span class="dv">7</span><span class="op">:</span><span class="dv">0</span><span class="op">]</span> io_out</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">wire</span> <span class="op">[</span><span class="dv">7</span><span class="op">:</span><span class="dv">0</span><span class="op">]</span> _b_eff_T_1 <span class="op">=</span> <span class="bn">8'h0</span> <span class="op">-</span> io_b<span class="op">;</span></span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">wire</span> <span class="op">[</span><span class="dv">7</span><span class="op">:</span><span class="dv">0</span><span class="op">]</span> b_eff <span class="op">=</span> io_sub <span class="op">?</span> _b_eff_T_1 <span class="op">:</span> io_b<span class="op">;</span></span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">assign</span> io_out <span class="op">=</span> io_a <span class="op">+</span> b_eff<span class="op">;</span></span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a><span class="kw">endmodule</span></span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>


</section>
</section>
</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../cc-os/cc-os.html" class="pagination-link" aria-label="OS 操作系统原理">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">OS 操作系统原理</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../cc-cli/cc-cli.html" class="pagination-link" aria-label="Basic Linux CLI">
        <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Basic Linux CLI</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>