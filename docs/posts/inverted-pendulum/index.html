<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.41">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Marcobisky">
<meta name="dcterms.date" content="2025-03-25">
<meta name="description" content="一个完整的 MATLAB 控制系统设计指南，平衡倒立摆的线性反馈控制系统。">

<title>Control Case Study: LQR for Inverted Pendulum! – Marcobisky</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-48ffa3e5b9d089919c6712c39e5b00f2.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-71390cc8b9bae10139428574d3aab2c6.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-7296923c0d2fcbb96815fa438c9ef20b.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-3b107ac41cb128c3aa015a9f6b976a40.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Control Case Study: LQR for Inverted Pendulum! – Marcobisky">
<meta property="og:description" content="一个完整的 MATLAB 控制系统设计指南，平衡倒立摆的线性反馈控制系统。">
<meta property="og:image" content="https://marcobisky.github.io/posts/inverted-pendulum/src/cover.gif">
<meta property="og:site_name" content="Marcobisky">
<meta property="og:locale" content="en_US">
<meta name="twitter:title" content="Control Case Study: LQR for Inverted Pendulum! – Marcobisky">
<meta name="twitter:description" content="一个完整的 MATLAB 控制系统设计指南，平衡倒立摆的线性反馈控制系统。">
<meta name="twitter:image" content="https://marcobisky.github.io/posts/inverted-pendulum/src/cover.gif">
<meta name="twitter:creator" content="@Marcobisky77">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Marcobisky</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../cv"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../tinyml/index.html"> 
<span class="menu-text">TinyML</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../blog.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#intro" id="toc-intro" class="nav-link active" data-scroll-target="#intro"><span class="header-section-number">1</span> Intro</a></li>
  <li><a href="#physics-model" id="toc-physics-model" class="nav-link" data-scroll-target="#physics-model"><span class="header-section-number">2</span> Physics Model</a>
  <ul class="collapse">
  <li><a href="#kinetic-energy" id="toc-kinetic-energy" class="nav-link" data-scroll-target="#kinetic-energy"><span class="header-section-number">2.1</span> Kinetic Energy</a></li>
  <li><a href="#potential-energy" id="toc-potential-energy" class="nav-link" data-scroll-target="#potential-energy"><span class="header-section-number">2.2</span> Potential Energy</a></li>
  <li><a href="#euler-lagrange-equation" id="toc-euler-lagrange-equation" class="nav-link" data-scroll-target="#euler-lagrange-equation"><span class="header-section-number">2.3</span> Euler-Lagrange Equation</a></li>
  <li><a href="#matlab-code" id="toc-matlab-code" class="nav-link" data-scroll-target="#matlab-code"><span class="header-section-number">2.4</span> Matlab Code</a></li>
  </ul></li>
  <li><a href="#linearized-phase-space-model" id="toc-linearized-phase-space-model" class="nav-link" data-scroll-target="#linearized-phase-space-model"><span class="header-section-number">3</span> Linearized Phase Space Model</a>
  <ul class="collapse">
  <li><a href="#linearization-of-the-original-dynamics" id="toc-linearization-of-the-original-dynamics" class="nav-link" data-scroll-target="#linearization-of-the-original-dynamics"><span class="header-section-number">3.1</span> Linearization of the original dynamics</a></li>
  <li><a href="#deriving-matrix-b-for-control" id="toc-deriving-matrix-b-for-control" class="nav-link" data-scroll-target="#deriving-matrix-b-for-control"><span class="header-section-number">3.2</span> Deriving matrix <span class="math inline">\(B\)</span> for control</a></li>
  </ul></li>
  <li><a href="#controllability-of-the-system" id="toc-controllability-of-the-system" class="nav-link" data-scroll-target="#controllability-of-the-system"><span class="header-section-number">4</span> Controllability of the system</a>
  <ul class="collapse">
  <li><a href="#original-system-stability" id="toc-original-system-stability" class="nav-link" data-scroll-target="#original-system-stability"><span class="header-section-number">4.1</span> Original system stability</a></li>
  <li><a href="#controllability" id="toc-controllability" class="nav-link" data-scroll-target="#controllability"><span class="header-section-number">4.2</span> Controllability</a></li>
  </ul></li>
  <li><a href="#finding-the-feedback-matrix-k" id="toc-finding-the-feedback-matrix-k" class="nav-link" data-scroll-target="#finding-the-feedback-matrix-k"><span class="header-section-number">5</span> Finding the feedback matrix <span class="math inline">\(K\)</span></a>
  <ul class="collapse">
  <li><a href="#random-pole-placement" id="toc-random-pole-placement" class="nav-link" data-scroll-target="#random-pole-placement"><span class="header-section-number">5.1</span> Random pole placement</a></li>
  <li><a href="#linear-quadratic-regulator-lqr" id="toc-linear-quadratic-regulator-lqr" class="nav-link" data-scroll-target="#linear-quadratic-regulator-lqr"><span class="header-section-number">5.2</span> Linear Quadratic Regulator (LQR)</a></li>
  <li><a href="#simulation-by-changing-q-matrix" id="toc-simulation-by-changing-q-matrix" class="nav-link" data-scroll-target="#simulation-by-changing-q-matrix"><span class="header-section-number">5.3</span> Simulation by changing Q matrix</a></li>
  <li><a href="#simulation-by-changing-r-values" id="toc-simulation-by-changing-r-values" class="nav-link" data-scroll-target="#simulation-by-changing-r-values"><span class="header-section-number">5.4</span> Simulation by changing R values</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full column-page-left" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Control Case Study: LQR for Inverted Pendulum!</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Control-Theory</div>
    <div class="quarto-category">EN-blogs</div>
  </div>
  </div>

<div>
  <div class="description">
    一个完整的 MATLAB 控制系统设计指南，平衡倒立摆的线性反馈控制系统。
  </div>
</div>


<div class="quarto-title-meta column-page-left">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Marcobisky </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 25, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="intro" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="intro"><span class="header-section-number">1</span> Intro</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="control-block-diagram.png" class="img-fluid figure-img" style="width:70.0%"></p>
<figcaption>Control block diagram</figcaption>
</figure>
</div>
<p>The objective of this article is to provide a self-contained guide to building a linear feedback control system for the classical inverted pendulum problem in MATLAB, i.e., to design a controller by applying a force to the cart <span class="math inline">\(M\)</span> to balance the pendulum at the upright position (shown in <a href="#fig-cartpend" class="quarto-xref">Figure&nbsp;1</a>). We will use the following standard equations of a control system: <span class="math display">\[
\begin{aligned}
    \dot{\mathbf{x}} &amp;= A \mathbf{x} + B \mathbf{u} \\
    \mathbf{y} &amp;= C \mathbf{x} + D \mathbf{u} \\
    \mathbf{u} &amp;= -K \mathbf{y}.
\end{aligned}
\]</span></p>
<p>A brief description of the symbols and their physical interpretation is given in the following table. If you have difficulty understanding their meanings, don’t worry, feel free to scan the next section.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 13%">
<col style="width: 62%">
<col style="width: 24%">
</colgroup>
<thead>
<tr class="header">
<th>Symbol</th>
<th>Description</th>
<th>This Article</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(\mathbf{x} \in TM\)</span></td>
<td>System state vector in the tangent bundle of dimension <span class="math inline">\(n\)</span>.</td>
<td><span class="math inline">\(\mathbf{x} = [x, \dot{x}, \theta, \dot{\theta}]^t \in T(\mathbb{R}^1 \times \mathbb{S}^2)\)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(\mathbf{u} \in TM_c\)</span></td>
<td>The values control knobs (“actuators”) in a space of dimension <span class="math inline">\(q\)</span> (<span class="math inline">\(q &lt; n\)</span>).</td>
<td>Force on the cart <span class="math inline">\(\mathbf{u} = \mathbf{F} \in \mathbb{R}\)</span>.</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\mathbf{y} \in TM_o\)</span></td>
<td>The observable output vector of the system (the values that we can measure) in a space of dimension <span class="math inline">\(p\)</span> (<span class="math inline">\(p &lt; n\)</span>).</td>
<td>All dimension of <span class="math inline">\(\mathbf{x}\)</span> is observable <span class="math inline">\(\mathbf{y} = \mathbf{x}\)</span>.</td>
</tr>
<tr class="even">
<td><span class="math inline">\(A^{n \times n}\)</span></td>
<td>The linear infinitesimal generator of the system.</td>
<td>Modelling and linearization needed, see <a href="#eq-linearized-matrix" class="quarto-xref">Equation&nbsp;5</a>.</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(B^{n \times q}\)</span></td>
<td>How the control knobs affect the state vector.</td>
<td>Force analyzing needed, see <a href="#eq-linearized-matrix-B" class="quarto-xref">Equation&nbsp;6</a>.</td>
</tr>
<tr class="even">
<td><span class="math inline">\(C^{p \times n}\)</span></td>
<td>Convert the state vector to what we can actually measure.</td>
<td><span class="math inline">\(C = I\)</span>.</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(D^{p \times q}\)</span></td>
<td>Sometimes the control knobs affect the system observable output directly.</td>
<td>Applying the force has no direct effect on the observable <span class="math inline">\(D = 0\)</span>.</td>
</tr>
<tr class="even">
<td><span class="math inline">\(K^{q \times p}\)</span></td>
<td>The linear feedback matrix. The observable <span class="math inline">\(\mathbf{y}\)</span> is mapped linearly to the control knobs.</td>
<td>We use LQR to optimize this matrix.</td>
</tr>
</tbody>
</table>
</section>
<section id="physics-model" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="physics-model"><span class="header-section-number">2</span> Physics Model</h2>
<p>In this section, we will derive the equations of motion for the cart-pendulum system using Lagrangian Mechanics. I hope <a href="#fig-cartpend" class="quarto-xref">Figure&nbsp;1</a> will be enough to explain the notations used in this article.</p>
<div id="fig-cartpend" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cartpend-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="cartpend.png" class="img-fluid figure-img" style="width:70.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cartpend-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Cart-pendulum Model
</figcaption>
</figure>
</div>
<p>The dynamics of the system can be computed using Lagrangian Mechanics:</p>
<p><span id="eq-lagrangian"><span class="math display">\[
\boxed{
\frac{\mathrm{d}}{\mathrm{d}t}\frac{\partial L}{\partial q_i} - \frac{\partial L}{\partial q_i} = Q_i^{\text{non-conservative}},
}
\tag{1}\]</span></span> where <span class="math inline">\(q_i\)</span> is either <span class="math inline">\(x\)</span> or <span class="math inline">\(\theta\)</span> in our case. The lagrangian <span class="math inline">\(L\)</span> is system kinetic energy minus potential energy: <span class="math display">\[
L = T - V.
\]</span></p>
<section id="kinetic-energy" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="kinetic-energy"><span class="header-section-number">2.1</span> Kinetic Energy</h3>
<p>The total kinetic energy of the system is the sum of the kinetic energy of the cart and the kinetic energy of the pendulum: <span class="math display">\[
T = T_M + T_m.
\]</span></p>
<p>First we compute the position of <span class="math inline">\(m\)</span>: <span class="math display">\[
\mathbf{r}_m = \begin{bmatrix} x + \ell \sin \theta \\ -\ell \cos \theta \end{bmatrix}.
\]</span></p>
<p>Therefore, <span class="math display">\[
\begin{aligned}
    T_m &amp;= \frac{1}{2} m \dot{\mathbf{r}}_m^T \dot{\mathbf{r}}_m \\
    &amp;= \frac{1}{2} m \left[(\dot{x} + \ell \dot{\theta} \cos \theta)^2 + (\ell \dot{\theta} \sin \theta)^2\right] \\
    &amp;= \frac{1}{2} m \left[ \dot{x}^2 + \ell^2 \dot{\theta}^2 + 2 \ell \dot{x} \dot{\theta} \cos \theta \right].
\end{aligned}
\]</span></p>
<p>The kinetic energy of <span class="math inline">\(M\)</span> is easy: <span class="math display">\[
T_M = \frac{1}{2} M \dot{x}^2.
\]</span></p>
<p>The total kinetic energy is: <span class="math display">\[
T = \frac{1}{2} (M + m) \dot{x}^2 + \frac{1}{2} m \ell^2 \dot{\theta}^2 + m \ell \dot{x} \dot{\theta} \cos \theta.
\]</span></p>
</section>
<section id="potential-energy" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="potential-energy"><span class="header-section-number">2.2</span> Potential Energy</h3>
<p>Only the pendulum has potential energy: <span class="math display">\[
V = - m g \ell \cos \theta.
\]</span></p>
</section>
<section id="euler-lagrange-equation" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="euler-lagrange-equation"><span class="header-section-number">2.3</span> Euler-Lagrange Equation</h3>
<p>The lagrangian of the system is: <span class="math display">\[
\begin{aligned}
    L &amp;= T - V \\
    &amp;= \frac{1}{2} (M + m) \dot{x}^2 + \frac{1}{2} m \ell^2 \dot{\theta}^2 + m \ell \dot{x} \dot{\theta} \cos \theta + m g \ell \cos \theta.
\end{aligned}
\]</span></p>
<section id="euler-lagrange-in-x" class="level4" data-number="2.3.1">
<h4 data-number="2.3.1" class="anchored" data-anchor-id="euler-lagrange-in-x"><span class="header-section-number">2.3.1</span> Euler-Lagrange in <span class="math inline">\(x\)</span></h4>
<p>For <span class="math inline">\(q_1 = x\)</span>: <span class="math display">\[
\begin{aligned}
    \frac{\partial L}{\partial \dot{x}} &amp;= (M + m) \dot{x} + m \ell \dot{\theta} \cos \theta \\
    \frac{\mathrm{d}}{\mathrm{d}t} \left( \frac{\partial L}{\partial \dot{x}} \right) &amp;= (M + m) \ddot{x} + m \ell (-\sin \theta \dot{\theta}^2 + \cos \theta \ddot{\theta}) \\
    \frac{\partial L}{\partial x} &amp;= 0 \\
    Q_x^{\text{non-conservative}} &amp;= F - b \dot{x}.
\end{aligned}
\]</span></p>
<p>By <a href="#eq-lagrangian" class="quarto-xref">Equation&nbsp;1</a>, we have: <span id="eq-lagrangian-x"><span class="math display">\[
(M + m) \ddot{x} + m \ell (-\sin \theta \dot{\theta}^2 + \cos \theta \ddot{\theta}) = F - b \dot{x}.
\tag{2}\]</span></span></p>
</section>
<section id="euler-lagrange-in-theta" class="level4" data-number="2.3.2">
<h4 data-number="2.3.2" class="anchored" data-anchor-id="euler-lagrange-in-theta"><span class="header-section-number">2.3.2</span> Euler-Lagrange in <span class="math inline">\(\theta\)</span></h4>
<p>For <span class="math inline">\(q_2 = \theta\)</span>: <span class="math display">\[
\begin{aligned}
    \frac{\partial L}{\partial \dot{\theta}} &amp;= m \ell^2 \dot{\theta} + m \ell \dot{x} \cos \theta \\
    \frac{\mathrm{d}}{\mathrm{d}t} \left( \frac{\partial L}{\partial \dot{\theta}} \right) &amp;= m \ell^2 \ddot{\theta} + m \ell (\ddot{x} \cos \theta - \dot{x} \sin \theta \dot{\theta}) \\
    \frac{\partial L}{\partial \theta} &amp;= - m g \ell \sin \theta - m \ell \dot{x} \sin \theta \dot{\theta} \\
    Q_{\theta}^{\text{non-conservative}} &amp;= 0.
\end{aligned}
\]</span></p>
<p>By <a href="#eq-lagrangian" class="quarto-xref">Equation&nbsp;1</a>, we have: <span id="eq-lagrangian-theta"><span class="math display">\[
m \ell \ddot{x} \cos \theta + m \ell^2 \ddot{\theta} + m g \ell \sin \theta = 0.
\tag{3}\]</span></span></p>
</section>
<section id="matrix-form" class="level4" data-number="2.3.3">
<h4 data-number="2.3.3" class="anchored" data-anchor-id="matrix-form"><span class="header-section-number">2.3.3</span> Matrix Form</h4>
<p>Write <a href="#eq-lagrangian-x" class="quarto-xref">Equation&nbsp;2</a> and <a href="#eq-lagrangian-theta" class="quarto-xref">Equation&nbsp;3</a> in matrix form: <span id="eq-lagrangian-matrix-form"><span class="math display">\[
\begin{bmatrix}
    M + m &amp; m \ell \cos \theta \\
    m \ell \cos \theta &amp; m \ell^2
\end{bmatrix}
\begin{bmatrix}
    \ddot{x} \\ \ddot{\theta}
\end{bmatrix}
=
\begin{bmatrix}
    F - b \dot{x} + m \ell \sin \theta \dot{\theta}^2 \\
    - m g \ell \sin \theta
\end{bmatrix}.
\tag{4}\]</span></span></p>
</section>
</section>
<section id="matlab-code" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="matlab-code"><span class="header-section-number">2.4</span> Matlab Code</h3>
<p>The following function computes the state-space model of the inverted pendulum:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>invpend.m</strong></pre>
</div>
<div class="sourceCode" id="cb1" data-filename="invpend.m"><pre class="sourceCode matlab code-with-copy"><code class="sourceCode matlab"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">% x -&gt; state vector (x, xdot, theta, thetadot)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">% m -&gt; mass of pendulum</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">% M -&gt; mass of cart</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">% L -&gt; length of pendulum</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">% g -&gt; gravity</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">% b -&gt; friction = -b*xdot</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">% F -&gt; force applied to cart</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">% dx -&gt; derivative of state vector</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="va">dx</span> <span class="op">=</span> <span class="va">invpend</span>(<span class="va">x</span><span class="op">,</span> <span class="va">m</span><span class="op">,</span> <span class="va">M</span><span class="op">,</span> <span class="va">L</span><span class="op">,</span> <span class="va">g</span><span class="op">,</span> <span class="va">b</span><span class="op">,</span> <span class="va">F</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">% Unpack state variables</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">x1</span> <span class="op">=</span> <span class="va">x</span>(<span class="fl">1</span>)<span class="op">;</span>     <span class="co">% cart position</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="va">x2</span> <span class="op">=</span> <span class="va">x</span>(<span class="fl">2</span>)<span class="op">;</span>     <span class="co">% cart velocity (xdot)</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="va">x3</span> <span class="op">=</span> <span class="va">x</span>(<span class="fl">3</span>)<span class="op">;</span>     <span class="co">% pendulum angle (theta)</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="va">x4</span> <span class="op">=</span> <span class="va">x</span>(<span class="fl">4</span>)<span class="op">;</span>     <span class="co">% angular velocity (thetadot)</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">% Precompute useful terms</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="va">sin_theta</span> <span class="op">=</span> <span class="va">sin</span>(<span class="va">x3</span>)<span class="op">;</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="va">cos_theta</span> <span class="op">=</span> <span class="va">cos</span>(<span class="va">x3</span>)<span class="op">;</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="va">theta_dot</span> <span class="op">=</span> <span class="va">x4</span><span class="op">;</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">% Mass matrix</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="va">D</span> <span class="op">=</span> [<span class="va">M</span> <span class="op">+</span> <span class="va">m</span><span class="op">,</span>         <span class="va">m</span> <span class="op">*</span> <span class="va">L</span> <span class="op">*</span> <span class="va">cos_theta</span><span class="op">;</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>         <span class="va">m</span> <span class="op">*</span> <span class="va">L</span> <span class="op">*</span> <span class="va">cos_theta</span><span class="op">,</span>   <span class="va">m</span> <span class="op">*</span> <span class="va">L</span><span class="op">^</span><span class="fl">2</span>]<span class="op">;</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">% Right-hand side (forces/accelerations)</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="va">RHS</span> <span class="op">=</span> [<span class="va">F</span> <span class="op">-</span> <span class="va">b</span> <span class="op">*</span> <span class="va">x2</span> <span class="op">+</span> <span class="va">m</span> <span class="op">*</span> <span class="va">L</span> <span class="op">*</span> <span class="va">sin_theta</span> <span class="op">*</span> <span class="va">theta_dot</span><span class="op">^</span><span class="fl">2</span><span class="op">;</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>           <span class="op">-</span><span class="va">m</span> <span class="op">*</span> <span class="va">g</span> <span class="op">*</span> <span class="va">L</span> <span class="op">*</span> <span class="va">sin_theta</span>]<span class="op">;</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">% Solve for accelerations</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="va">accel</span> <span class="op">=</span> <span class="va">D</span> <span class="op">\</span> <span class="va">RHS</span><span class="op">;</span>  <span class="co">% Equivalent to inv(D) * RHS, but more stable</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">% Return time derivative of state vector</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="va">dx</span> <span class="op">=</span> <span class="va">zeros</span>(<span class="fl">4</span><span class="op">,</span> <span class="fl">1</span>)<span class="op">;</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="va">dx</span>(<span class="fl">1</span>) <span class="op">=</span> <span class="va">x2</span><span class="op">;</span>         <span class="co">% xdot</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    <span class="va">dx</span>(<span class="fl">2</span>) <span class="op">=</span> <span class="va">accel</span>(<span class="fl">1</span>)<span class="op">;</span>   <span class="co">% xddot</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="va">dx</span>(<span class="fl">3</span>) <span class="op">=</span> <span class="va">x4</span><span class="op">;</span>         <span class="co">% thetadot</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    <span class="va">dx</span>(<span class="fl">4</span>) <span class="op">=</span> <span class="va">accel</span>(<span class="fl">2</span>)<span class="op">;</span>   <span class="co">% thetaddot</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following function simulates the motion of the system without damping and external force:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>simulation_invpend.m</strong></pre>
</div>
<div class="sourceCode" id="cb2" data-filename="simulation_invpend.m"><pre class="sourceCode matlab code-with-copy"><code class="sourceCode matlab"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="va">clear</span> <span class="va">all</span><span class="op">;</span> <span class="va">close</span> <span class="va">all</span><span class="op">;</span> <span class="va">clc</span><span class="op">;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">% Simulation parameters</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="va">m</span> <span class="op">=</span> <span class="fl">2</span><span class="op">;</span>          <span class="co">% Mass of pendulum</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="va">M</span> <span class="op">=</span> <span class="fl">4</span><span class="op">;</span>         <span class="co">% Mass of cart</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="va">L</span> <span class="op">=</span> <span class="fl">1</span><span class="op">;</span>          <span class="co">% Length of pendulum</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="va">g</span> <span class="op">=</span> <span class="op">-</span><span class="fl">9.81</span><span class="op">;</span>       <span class="co">% Gravity</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="va">b</span> <span class="op">=</span> <span class="fl">30</span><span class="op">;</span>          <span class="co">% damping coefficient</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="va">time</span> <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">.1</span><span class="op">:</span><span class="fl">10</span><span class="op">;</span> <span class="co">% Time samples</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">% Initial conditions</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="va">x0</span> <span class="op">=</span> [<span class="fl">0</span><span class="op">;</span> <span class="fl">0</span><span class="op">;</span> <span class="fl">.2</span><span class="op">;</span> <span class="fl">0</span>]<span class="op">;</span> <span class="co">% x, xdot, theta, thetadot</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">% Solve ODE</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>[<span class="va">t</span><span class="op">,</span> <span class="va">x</span>] <span class="op">=</span> <span class="va">ode45</span>(<span class="op">@</span>(<span class="va">t</span><span class="op">,</span> <span class="va">x</span>) <span class="va">invpend</span>(<span class="va">x</span><span class="op">,</span> <span class="va">m</span><span class="op">,</span> <span class="va">M</span><span class="op">,</span> <span class="va">L</span><span class="op">,</span> <span class="va">g</span><span class="op">,</span> <span class="va">b</span><span class="op">,</span> <span class="fl">0</span>)<span class="op">,</span> <span class="va">time</span><span class="op">,</span> <span class="va">x0</span>)<span class="op">;</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co">% Animation</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="kw">for</span> <span class="va">k</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">length</span>(<span class="va">t</span>)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="va">invpend_plot</span>(<span class="va">x</span>(<span class="va">k</span><span class="op">,</span> <span class="op">:</span>)<span class="op">,</span> <span class="va">L</span><span class="op">,</span> <span class="va">true</span><span class="op">,</span> <span class="ss">'simulation_invpend.gif'</span>)<span class="op">;</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- ----------------------------------------- -->
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
invpend_plot() function
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="sourceCode" id="cb3"><pre class="sourceCode matlab code-with-copy"><code class="sourceCode matlab"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="va">invpend_plot</span>(<span class="va">x</span><span class="op">,</span> <span class="va">L</span><span class="op">,</span> <span class="va">saveGif</span><span class="op">,</span> <span class="va">gifFileName</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">% Extract state variables</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">cart_x</span> <span class="op">=</span> <span class="va">x</span>(<span class="fl">1</span>)<span class="op">;</span>    <span class="co">% Cart position</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">theta</span> <span class="op">=</span> <span class="va">x</span>(<span class="fl">3</span>)<span class="op">;</span>     <span class="co">% Pendulum angle</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">% Compute pendulum position</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">pend_x</span> <span class="op">=</span> <span class="va">cart_x</span> <span class="op">+</span> <span class="va">L</span> <span class="op">*</span> <span class="va">sin</span>(<span class="va">theta</span>)<span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">pend_y</span> <span class="op">=</span> <span class="va">L</span> <span class="op">*</span> <span class="va">cos</span>(<span class="va">theta</span>)<span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">% Figure setup</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">clf</span><span class="op">;</span> <span class="va">hold</span> <span class="va">on</span><span class="op">;</span> <span class="va">axis</span> <span class="va">equal</span><span class="op">;</span> <span class="va">grid</span> <span class="va">on</span><span class="op">;</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">xlim</span>([<span class="op">-</span><span class="fl">2</span> <span class="fl">2</span>])<span class="op">;</span> <span class="va">ylim</span>([<span class="op">-</span><span class="fl">1.5</span> <span class="fl">1.5</span>])<span class="op">;</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">% Draw cart</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="va">cart_w</span> <span class="op">=</span> <span class="fl">0.4</span><span class="op">;</span> <span class="va">cart_h</span> <span class="op">=</span> <span class="fl">0.2</span><span class="op">;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="va">rectangle</span>(<span class="ss">'Position'</span><span class="op">,</span> [<span class="va">cart_x</span> <span class="op">-</span> <span class="va">cart_w</span><span class="op">/</span><span class="fl">2</span><span class="op">,</span> <span class="op">-</span><span class="va">cart_h</span><span class="op">/</span><span class="fl">2</span><span class="op">,</span> <span class="va">cart_w</span><span class="op">,</span> <span class="va">cart_h</span>]<span class="op">,</span> <span class="op">...</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>              <span class="ss">'Curvature'</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="ss">'FaceColor'</span><span class="op">,</span> [<span class="fl">0.5</span> <span class="fl">0.5</span> <span class="fl">0.5</span>])<span class="op">;</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">% Draw pendulum</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="va">plot</span>([<span class="va">cart_x</span><span class="op">,</span> <span class="va">pend_x</span>]<span class="op">,</span> [<span class="fl">0</span><span class="op">,</span> <span class="va">pend_y</span>]<span class="op">,</span> <span class="ss">'k-'</span><span class="op">,</span> <span class="ss">'LineWidth'</span><span class="op">,</span> <span class="fl">2</span>)<span class="op">;</span> <span class="co">% Rod</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="va">plot</span>(<span class="va">pend_x</span><span class="op">,</span> <span class="va">pend_y</span><span class="op">,</span> <span class="ss">'ro'</span><span class="op">,</span> <span class="ss">'MarkerSize'</span><span class="op">,</span> <span class="fl">10</span><span class="op">,</span> <span class="ss">'MarkerFaceColor'</span><span class="op">,</span> <span class="ss">'r'</span>)<span class="op">;</span> <span class="co">% Mass</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">% Draw ground</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="va">plot</span>([<span class="op">-</span><span class="fl">2</span> <span class="fl">2</span>]<span class="op">,</span> [<span class="fl">0</span><span class="op">,</span> <span class="fl">0</span>]<span class="op">,</span> <span class="ss">'k'</span><span class="op">,</span> <span class="ss">'LineWidth'</span><span class="op">,</span> <span class="fl">2</span>)<span class="op">;</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">% If saveGif is true, save the current frame to a GIF file</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">persistent</span> <span class="va">gifFile</span> <span class="va">frameCount</span> <span class="va">currentGifName</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="va">nargin</span> <span class="op">&lt;</span> <span class="fl">3</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">saveGif</span> <span class="op">=</span> <span class="va">false</span><span class="op">;</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="va">saveGif</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">% Set default filename if not provided</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="va">nargin</span> <span class="op">&lt;</span> <span class="fl">4</span> <span class="op">||</span> <span class="va">isempty</span>(<span class="va">gifFileName</span>)</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>            <span class="va">gifFileName</span> <span class="op">=</span> <span class="ss">'invpend_animation.gif'</span><span class="op">;</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">end</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">% Reset frame count if this is a new gif file</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="va">isempty</span>(<span class="va">currentGifName</span>) <span class="op">||</span> <span class="op">~</span><span class="va">strcmp</span>(<span class="va">currentGifName</span><span class="op">,</span> <span class="va">gifFileName</span>)</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>            <span class="va">frameCount</span> <span class="op">=</span> <span class="fl">1</span><span class="op">;</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>            <span class="va">currentGifName</span> <span class="op">=</span> <span class="va">gifFileName</span><span class="op">;</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">else</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>            <span class="va">frameCount</span> <span class="op">=</span> <span class="va">frameCount</span> <span class="op">+</span> <span class="fl">1</span><span class="op">;</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>        <span class="kw">end</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">% Capture the current figure as an image</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>        <span class="va">frame</span> <span class="op">=</span> <span class="va">getframe</span>(<span class="va">gcf</span>)<span class="op">;</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>        <span class="va">im</span> <span class="op">=</span> <span class="va">frame2im</span>(<span class="va">frame</span>)<span class="op">;</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>        [<span class="va">imind</span><span class="op">,</span> <span class="va">cm</span>] <span class="op">=</span> <span class="va">rgb2ind</span>(<span class="va">im</span><span class="op">,</span> <span class="fl">256</span>)<span class="op">;</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">% Write to the GIF file</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="va">frameCount</span> <span class="op">==</span> <span class="fl">1</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>            <span class="va">imwrite</span>(<span class="va">imind</span><span class="op">,</span> <span class="va">cm</span><span class="op">,</span> <span class="va">gifFileName</span><span class="op">,</span> <span class="ss">'gif'</span><span class="op">,</span> <span class="ss">'Loopcount'</span><span class="op">,</span> <span class="va">inf</span><span class="op">,</span> <span class="ss">'DelayTime'</span><span class="op">,</span> <span class="fl">0.1</span>)<span class="op">;</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">else</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>            <span class="va">imwrite</span>(<span class="va">imind</span><span class="op">,</span> <span class="va">cm</span><span class="op">,</span> <span class="va">gifFileName</span><span class="op">,</span> <span class="ss">'gif'</span><span class="op">,</span> <span class="ss">'WriteMode'</span><span class="op">,</span> <span class="ss">'append'</span><span class="op">,</span> <span class="ss">'DelayTime'</span><span class="op">,</span> <span class="fl">0.1</span>)<span class="op">;</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>        <span class="kw">end</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>    <span class="va">drawnow</span><span class="op">;</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<!-- ----------------------------------------- -->
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="src/simulation_invpend.gif" class="img-fluid figure-img" style="width:60.0%"></p>
<figcaption>Simulation result of <code>simulation_invpend.m</code></figcaption>
</figure>
</div>
</section>
</section>
<section id="linearized-phase-space-model" class="level2 page-columns page-full" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="linearized-phase-space-model"><span class="header-section-number">3</span> Linearized Phase Space Model</h2>
<section id="linearization-of-the-original-dynamics" class="level3 page-columns page-full" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="linearization-of-the-original-dynamics"><span class="header-section-number">3.1</span> Linearization of the original dynamics</h3>
<p>In this section, we build the linear version of the original system (without control) in the phase space.</p>
<p>First of all, the state of the system can be described in a vector: <span class="math display">\[
\mathbf{x} = \begin{bmatrix}
x \\ \dot{x} \\ \theta \\ \dot{\theta}
\end{bmatrix}
\in T (\mathbb{R}^1 \times \mathbb{S}^1)
\]</span></p>
<p>Now we want to use a linear model <span class="math inline">\(\dot{\mathbf{x}} = \mathbf{Ax}\)</span> to analyze the system at <span class="math inline">\(\theta = 0\)</span>, i.e., we want to find matrix <span class="math inline">\(A \in \mathbb{C}^{4 \times 4}\)</span> s.t., <span class="math display">\[
\frac{\mathrm{d}}{\mathrm{d}t}
\begin{bmatrix}
    x \\ \dot{x} \\ \theta \\ \dot{\theta}
\end{bmatrix}
=
\overbrace{
\begin{bmatrix}
    \dot{x} \\ \ddot{x} \\ \dot{\theta} \\ \ddot{\theta}
\end{bmatrix}
}^{\dot{\mathbf{x}}}
=
\overbrace{
\begin{bmatrix}
    0 &amp; 1 &amp; 0 &amp; 0 \\
    ? &amp; ? &amp; ? &amp; ? \\
    0 &amp; 0 &amp; 0 &amp; 1 \\
    ? &amp; ? &amp; ? &amp; ?
\end{bmatrix}
}^{A}
\overbrace{
\begin{bmatrix}
    x \\ \dot{x} \\ \theta \\ \dot{\theta}
\end{bmatrix}
}^{\mathbf{x}}
\]</span></p>
<p>Note the the first and third row are trivial identities, we only need to derive the second and fourth row of <span class="math inline">\(A\)</span>. We already solved <a href="#eq-lagrangian-matrix-form" class="quarto-xref">Equation&nbsp;4</a> in <code>invpend.m</code>. But now we have to solve it explicitly to derive the partial derivatives for the jacobian: <span class="math display">\[
\begin{bmatrix}
    \ddot{x} \\ \ddot{\theta}
\end{bmatrix}
=
\phi (x, \dot{x}, \theta, \dot{\theta})
=
\begin{bmatrix}
    \frac{F - b \dot{x} + m \ell \sin \theta \dot{\theta}^2 - mg \cos \theta \sin \theta}{M + m \sin^2 \theta} \\
    \frac{- \cos \theta \left(F - b \dot{x} + m \ell \sin \theta \dot{\theta}^2\right) + (M+m) g \ell \sin \theta}{M \ell + m \ell \sin^2 \theta}
\end{bmatrix}.
\]</span></p>
<p>Now obviously the function <span class="math inline">\(\phi\)</span> is non-linear. Its jacobian<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> at phase point <span class="math inline">\(\mathbf{x}_{\text{up}} = [x, 0, 0, 0]^t\)</span> is: <span class="math display">\[
\begin{aligned}
    [J]
    &amp;=
    \begin{bmatrix}
    \frac{\partial \phi_1}{\partial x} &amp; \frac{\partial \phi_1}{\partial \dot{x}} &amp; \frac{\partial \phi_1}{\partial \theta} &amp; \frac{\partial \phi_1}{\partial \dot{\theta}} \\
    \frac{\partial \phi_2}{\partial x} &amp; \frac{\partial \phi_2}{\partial \dot{x}} &amp; \frac{\partial \phi_2}{\partial \theta} &amp; \frac{\partial \phi_2}{\partial \dot{\theta}}
    \end{bmatrix}_{\mathbf{x} = \mathbf{x}_{\text{up}}} \\
    &amp;=
    \begin{bmatrix}
    0 &amp; -\frac{b}{M} &amp; -\frac{mg}{M} &amp; 0 \\
    0 &amp; -\frac{b}{M \ell} &amp; -\frac{(m + M)g}{M \ell} &amp; 0
    \end{bmatrix}.
\end{aligned}
\]</span></p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;Just to refresh, the <em>Jacobian</em> <span class="math inline">\(J\)</span> of a (non-linear) function <span class="math inline">\(\phi: \mathbb{R}^n \to \mathbb{R}^m\)</span> at point <span class="math inline">\(p \in \mathbb{R}^n\)</span> can be viewed as the local transformation from the neighborhood of <span class="math inline">\(p\)</span> to the neighborhood of <span class="math inline">\(\phi(p)\)</span>. <span class="math inline">\(\mathbb{R}^n\)</span> and <span class="math inline">\(\mathbb{R}^m\)</span> are not viewed as vector spaces but manifolds. In our case it’s a little weird to compute the jacobian of <span class="math inline">\(A\)</span> since <span class="math inline">\(A\)</span> defines a vector field, not mapping between manifolds. Or it is? <span class="math inline">\(A\)</span> <em>is</em> indeed a mapping between manifolds! Because vector field themselves are a section of the tangent bundle. By the way, this jacobian actually takes me a lot of effort to compute.</p></div></div><p>Therefore, <span id="eq-linearized-matrix"><span class="math display">\[
A =
\begin{bmatrix}
    0 &amp; 1 &amp; 0 &amp; 0 \\
    0 &amp; -\frac{b}{M} &amp; -\frac{mg}{M} &amp; 0 \\
    0 &amp; 0 &amp; 0 &amp; 1 \\
    0 &amp; -\frac{b}{M \ell} &amp; -\frac{(m + M)g}{M \ell} &amp; 0
\end{bmatrix}.
\tag{5}\]</span></span></p>
</section>
<section id="deriving-matrix-b-for-control" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="deriving-matrix-b-for-control"><span class="header-section-number">3.2</span> Deriving matrix <span class="math inline">\(B\)</span> for control</h3>
<p>The only control knob is <span class="math inline">\(\mathbf{u} = \mathbf{F}\)</span>, the force on the cart.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="deriving-B.png" class="img-fluid figure-img" style="width:70.0%"></p>
<figcaption>The control knob <span class="math inline">\(\mathbf{F}\)</span> affects <span class="math inline">\(\dot{x}\)</span> and <span class="math inline">\(\dot{\theta}\)</span></figcaption>
</figure>
</div>
<p>By Newton’s second law, it’s obvious that <span id="eq-linearized-matrix-B"><span class="math display">\[
B \mathbf{u} =
\begin{bmatrix}
    0 \\ \frac{1}{M} \\ 0 \\ -\frac{1}{M \ell}
\end{bmatrix} F.
\tag{6}\]</span></span></p>
<p>Each entry of <span class="math inline">\(B\)</span> in <a href="#eq-linearized-matrix-B" class="quarto-xref">Equation&nbsp;6</a> is explained in the following table:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 35%">
<col style="width: 65%">
</colgroup>
<thead>
<tr class="header">
<th>Entry</th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>B(1,1)</code> = 0</td>
<td>The velocity <span class="math inline">\(\dot{x}\)</span> of the cart <span class="math inline">\(M\)</span> will not suddenly change due to the force <span class="math inline">\(F\)</span>.</td>
</tr>
<tr class="even">
<td><code>B(2,1)</code> = <span class="math inline">\(\frac{1}{M}\)</span></td>
<td>The acceleration <span class="math inline">\(\ddot{x}\)</span> flash to <span class="math inline">\(\frac{F}{M}\)</span> due to <span class="math inline">\(F\)</span>.</td>
</tr>
<tr class="odd">
<td><code>B(3,1)</code> = 0</td>
<td>The angular velocity <span class="math inline">\(\dot{\theta}\)</span> of the pendulum <span class="math inline">\(m\)</span> will not suddenly change due to the force <span class="math inline">\(F\)</span>.</td>
</tr>
<tr class="even">
<td><code>B(4,1)</code> = <span class="math inline">\(-\frac{1}{M \ell}\)</span></td>
<td>The angular acceleration <span class="math inline">\(\ddot{\theta}\)</span> of the pendulum <span class="math inline">\(m\)</span> flash to <span class="math inline">\(-\frac{F}{M \ell}\)</span> due to <span class="math inline">\(F\)</span>. The pendulum is moving backward relative to the cart, hence the negative sign.</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="controllability-of-the-system" class="level2 page-columns page-full" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="controllability-of-the-system"><span class="header-section-number">4</span> Controllability of the system</h2>
<section id="original-system-stability" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="original-system-stability"><span class="header-section-number">4.1</span> Original system stability</h3>
<p>From intuition, the system where <span class="math inline">\(\theta = 0\)</span> is unstable. How to know that from <a href="#eq-linearized-matrix" class="quarto-xref">Equation&nbsp;5</a>? We know that <strong>the system <span class="math inline">\(\dot{\mathbf{x}} = A \mathbf{x}\)</span> is stable iff all the eigenvalues of <span class="math inline">\(A\)</span> are rigorously negative</strong>. The instability of the system can be verified by the following Matlab code:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>original_system_stability.m</strong></pre>
</div>
<div class="sourceCode" id="cb4" data-filename="original_system_stability.m"><pre class="sourceCode matlab code-with-copy"><code class="sourceCode matlab"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="va">clear</span> <span class="va">all</span><span class="op">;</span> <span class="va">close</span> <span class="va">all</span><span class="op">;</span> <span class="va">clc</span><span class="op">;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">% Simulation parameters</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="va">m</span> <span class="op">=</span> <span class="fl">3</span><span class="op">;</span>          <span class="co">% Mass of pendulum</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="va">M</span> <span class="op">=</span> <span class="fl">5</span><span class="op">;</span>         <span class="co">% Mass of cart</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="va">L</span> <span class="op">=</span> <span class="fl">1</span><span class="op">;</span>          <span class="co">% Length of pendulum</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="va">g</span> <span class="op">=</span> <span class="op">-</span><span class="fl">9.81</span><span class="op">;</span>       <span class="co">% Gravity</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="va">b</span> <span class="op">=</span> <span class="fl">5</span><span class="op">;</span>          <span class="co">% damping coefficient</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">% Define matrix, xdot = Ax + Bu</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="va">A</span> <span class="op">=</span> [<span class="fl">0</span><span class="op">,</span> <span class="fl">1</span><span class="op">,</span>          <span class="fl">0</span><span class="op">,</span>              <span class="fl">0</span><span class="op">;</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>     <span class="fl">0</span><span class="op">,</span> <span class="op">-</span><span class="va">b</span><span class="op">/</span><span class="va">M</span><span class="op">,</span>       <span class="op">-</span><span class="va">m</span><span class="op">*</span><span class="va">g</span><span class="op">/</span><span class="va">M</span><span class="op">,</span>         <span class="fl">0</span><span class="op">;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>     <span class="fl">0</span><span class="op">,</span> <span class="fl">0</span><span class="op">,</span>          <span class="fl">0</span><span class="op">,</span>              <span class="fl">1</span><span class="op">;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>     <span class="fl">0</span><span class="op">,</span> <span class="op">-</span><span class="va">b</span><span class="op">/</span>(<span class="va">M</span><span class="op">*</span><span class="va">L</span>)<span class="op">,</span>   <span class="op">-</span>(<span class="va">M</span><span class="op">+</span><span class="va">m</span>)<span class="op">*</span><span class="va">g</span><span class="op">/</span>(<span class="va">M</span><span class="op">*</span><span class="va">L</span>)<span class="op">,</span> <span class="fl">0</span>]<span class="op">;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="va">B</span> <span class="op">=</span> [<span class="fl">0</span><span class="op">;</span> <span class="fl">1</span><span class="op">/</span><span class="va">M</span><span class="op">;</span> <span class="fl">0</span><span class="op">;</span> <span class="op">-</span><span class="fl">1</span><span class="op">/</span>(<span class="va">M</span><span class="op">*</span><span class="va">L</span>)]<span class="op">;</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="va">eig</span>(<span class="va">A</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- ----------------------------------------- -->
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Result of <code>original_system_stability.m</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="sourceCode" id="cb5"><pre class="sourceCode matlab code-with-copy"><code class="sourceCode matlab"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="va">ans</span> <span class="op">=</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>         <span class="fl">0</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>   <span class="op">-</span><span class="fl">4.1883</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>   <span class="op">-</span><span class="fl">0.6157</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="fl">3.8040</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Since there are two non-negative eigenvalues, the system is unstable.</p>
</div>
</div>
</div>
<!-- ----------------------------------------- -->
</section>
<section id="controllability" class="level3 page-columns page-full" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="controllability"><span class="header-section-number">4.2</span> Controllability</h3>
<p>One great thing about feedback is that we can change the <strong>fundamental dynamics</strong> of the system, changing its eigenvalues<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> to make it stable (as shown in <a href="#fig-feedback-change-dynamics" class="quarto-xref">Figure&nbsp;2</a>).</p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;Also called <strong>poles</strong> for historical reasons.</p></div></div><div id="fig-feedback-change-dynamics" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-feedback-change-dynamics-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="feedback-change-dynamics.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-feedback-change-dynamics-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Feedback control change the underlying dynamics of the system
</figcaption>
</figure>
</div>
<p>The system with linear feedback is: <span class="math display">\[
\begin{aligned}
    \dot{\mathbf{x}} &amp;= A \mathbf{x} + B \mathbf{u} \\
    \mathbf{u} &amp;= -K \mathbf{x},
\end{aligned}
\]</span> or <span class="math display">\[
\dot{\mathbf{x}} = (A - B K) \mathbf{x},
\]</span> whose dynamics could be very different from the original system <span class="math inline">\(\dot{\mathbf{x}} = A \mathbf{x}\)</span>.</p>
<p>We want to take full control of the system, i.e., does there exist some <span class="math inline">\(\mathbf{F} = \mathbf{u}(t)\)</span> to drive the system state point to anywhere in the phase space? In other words, is the system controllable?</p>
<!-- ----------------------------------------- -->
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Controllability
</div>
</div>
<div class="callout-body-container callout-body">
<div id="thm-controllability" class="callout-thm theorem">
<p><span class="theorem-title"><strong>Theorem 1</strong></span> The following statements are equivalent:</p>
<ol type="1">
<li><p>The system is controllable.</p></li>
<li><p>Its controllability matrix <span class="math inline">\(\mathcal{C}\)</span> is full rank, <span class="math display">\[
\mathcal{C} :=
\begin{bmatrix}
B &amp; AB &amp; A^2 B &amp; \cdots &amp; A^{n-1} B
\end{bmatrix}.
\]</span></p></li>
<li><p>The poles of the system can be placed arbitrarily<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>, i.e., the matrix <span class="math inline">\(A - B K\)</span> could have arbitrary eigenvalues.</p></li>
</ol>
<ol start="4" type="1">
<li>The reachability space <span class="math inline">\(\mathcal{R}\)</span> is the full phase space, <span class="math display">\[
\mathcal{R} := \{\mathbf{\xi} \in TM: \exists \text{ input } \mathbf{u}(t) \text{ s.t. } \mathbf{x}(t) = \mathbf{\xi}\}
\]</span></li>
</ol>
</div>
</div>
</div>
<!-- ----------------------------------------- -->
<div class="no-row-height column-margin column-container"><div id="fn3"><p><sup>3</sup>&nbsp;In fact, there is a built-in Matlab function <code>K = place(A, B, desired_eigs_vec)</code> to help you place the poles of the system to any desired locations.</p></div></div><p>By <a href="#thm-controllability" class="quarto-xref">Theorem&nbsp;1</a>, the system is controllable iff <code>ctrb(A, B)</code> has rank <span class="math inline">\(4\)</span>. In fact, the following Matlab code can verify this.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>sys_controllability.m</strong></pre>
</div>
<div class="sourceCode" id="cb6" data-filename="sys_controllability.m"><pre class="sourceCode matlab code-with-copy"><code class="sourceCode matlab"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="va">clear</span> <span class="va">all</span><span class="op">;</span> <span class="va">close</span> <span class="va">all</span><span class="op">;</span> <span class="va">clc</span><span class="op">;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">% Simulation parameters</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="va">m</span> <span class="op">=</span> <span class="fl">3</span><span class="op">;</span>          <span class="co">% Mass of pendulum</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="va">M</span> <span class="op">=</span> <span class="fl">5</span><span class="op">;</span>         <span class="co">% Mass of cart</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="va">L</span> <span class="op">=</span> <span class="fl">1</span><span class="op">;</span>          <span class="co">% Length of pendulum</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="va">g</span> <span class="op">=</span> <span class="op">-</span><span class="fl">9.81</span><span class="op">;</span>       <span class="co">% Gravity</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="va">b</span> <span class="op">=</span> <span class="fl">5</span><span class="op">;</span>          <span class="co">% damping coefficient</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">% Define matrix, xdot = Ax + Bu</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="va">A</span> <span class="op">=</span> [<span class="fl">0</span><span class="op">,</span> <span class="fl">1</span><span class="op">,</span>          <span class="fl">0</span><span class="op">,</span>              <span class="fl">0</span><span class="op">;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>     <span class="fl">0</span><span class="op">,</span> <span class="op">-</span><span class="va">b</span><span class="op">/</span><span class="va">M</span><span class="op">,</span>       <span class="op">-</span><span class="va">m</span><span class="op">*</span><span class="va">g</span><span class="op">/</span><span class="va">M</span><span class="op">,</span>         <span class="fl">0</span><span class="op">;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>     <span class="fl">0</span><span class="op">,</span> <span class="fl">0</span><span class="op">,</span>          <span class="fl">0</span><span class="op">,</span>              <span class="fl">1</span><span class="op">;</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>     <span class="fl">0</span><span class="op">,</span> <span class="op">-</span><span class="va">b</span><span class="op">/</span>(<span class="va">M</span><span class="op">*</span><span class="va">L</span>)<span class="op">,</span>   <span class="op">-</span>(<span class="va">M</span><span class="op">+</span><span class="va">m</span>)<span class="op">*</span><span class="va">g</span><span class="op">/</span>(<span class="va">M</span><span class="op">*</span><span class="va">L</span>)<span class="op">,</span> <span class="fl">0</span>]<span class="op">;</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="va">B</span> <span class="op">=</span> [<span class="fl">0</span><span class="op">;</span> <span class="fl">1</span><span class="op">/</span><span class="va">M</span><span class="op">;</span> <span class="fl">0</span><span class="op">;</span> <span class="op">-</span><span class="fl">1</span><span class="op">/</span>(<span class="va">M</span><span class="op">*</span><span class="va">L</span>)]<span class="op">;</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="va">rank</span>(<span class="va">ctrb</span>(<span class="va">A</span><span class="op">,</span> <span class="va">B</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- ----------------------------------------- -->
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Result of <code>sys_controllability.m</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="sourceCode" id="cb7"><pre class="sourceCode matlab code-with-copy"><code class="sourceCode matlab"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="va">ans</span> <span class="op">=</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>     <span class="fl">4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Since <span class="math inline">\(\mathcal{C}=\)</span> <code>ctrb(A, B)</code> has full rank <span class="math inline">\(4\)</span>, the system <span class="math inline">\(\dot{\mathbf{x}} = (A - B K) \mathbf{x}\)</span> is controllable.</p>
</div>
</div>
</div>
<!-- ----------------------------------------- -->
</section>
</section>
<section id="finding-the-feedback-matrix-k" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="finding-the-feedback-matrix-k"><span class="header-section-number">5</span> Finding the feedback matrix <span class="math inline">\(K\)</span></h2>
<section id="random-pole-placement" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="random-pole-placement"><span class="header-section-number">5.1</span> Random pole placement</h3>
<p>For controllable systems, <a href="#thm-controllability" class="quarto-xref">Theorem&nbsp;1</a> also guarantees that we can place the poles of the system to any desired locations, say <code>desired_eigs_vec = [-3; -4; -5; -6]</code>, just randomly some numbers in the left half of the complex plane, to ensure the stability of the system. We use <code>place()</code> in Matlab to find such <span class="math inline">\(K\)</span> and use that <span class="math inline">\(K\)</span> to simulate the control effect of the system.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>simulation_linear_control.m</strong></pre>
</div>
<div class="sourceCode" id="cb8" data-filename="simulation_linear_control.m"><pre class="sourceCode matlab code-with-copy"><code class="sourceCode matlab"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="va">clear</span> <span class="va">all</span><span class="op">;</span> <span class="va">close</span> <span class="va">all</span><span class="op">;</span> <span class="va">clc</span><span class="op">;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">%% Simulation parameters</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="va">m</span> <span class="op">=</span> <span class="fl">2</span><span class="op">;</span>          <span class="co">% Mass of pendulum</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="va">M</span> <span class="op">=</span> <span class="fl">10</span><span class="op">;</span>         <span class="co">% Mass of cart</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="va">L</span> <span class="op">=</span> <span class="fl">1</span><span class="op">;</span>          <span class="co">% Length of pendulum</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="va">g</span> <span class="op">=</span> <span class="op">-</span><span class="fl">9.81</span><span class="op">;</span>       <span class="co">% Gravity</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="va">b</span> <span class="op">=</span> <span class="fl">2</span><span class="op">;</span>          <span class="co">% damping coefficient</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="va">time</span> <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">.1</span><span class="op">:</span><span class="fl">6</span><span class="op">;</span> <span class="co">% Time samples</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">%% Initial conditions</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="va">x0</span> <span class="op">=</span> [<span class="fl">0</span><span class="op">;</span> <span class="fl">0</span><span class="op">;</span> <span class="op">-</span><span class="fl">.4</span><span class="op">;</span> <span class="fl">0</span>]<span class="op">;</span> <span class="co">% x, xdot, theta, thetadot</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co">%% pole placement</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co">% Define matrix, xdot = Ax + Bu</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="va">A</span> <span class="op">=</span> [<span class="fl">0</span><span class="op">,</span> <span class="fl">1</span><span class="op">,</span>          <span class="fl">0</span><span class="op">,</span>              <span class="fl">0</span><span class="op">;</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>     <span class="fl">0</span><span class="op">,</span> <span class="op">-</span><span class="va">b</span><span class="op">/</span><span class="va">M</span><span class="op">,</span>       <span class="op">-</span><span class="va">m</span><span class="op">*</span><span class="va">g</span><span class="op">/</span><span class="va">M</span><span class="op">,</span>         <span class="fl">0</span><span class="op">;</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>     <span class="fl">0</span><span class="op">,</span> <span class="fl">0</span><span class="op">,</span>          <span class="fl">0</span><span class="op">,</span>              <span class="fl">1</span><span class="op">;</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>     <span class="fl">0</span><span class="op">,</span> <span class="op">-</span><span class="va">b</span><span class="op">/</span>(<span class="va">M</span><span class="op">*</span><span class="va">L</span>)<span class="op">,</span>   <span class="op">-</span>(<span class="va">M</span><span class="op">+</span><span class="va">m</span>)<span class="op">*</span><span class="va">g</span><span class="op">/</span>(<span class="va">M</span><span class="op">*</span><span class="va">L</span>)<span class="op">,</span> <span class="fl">0</span>]<span class="op">;</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="va">B</span> <span class="op">=</span> [<span class="fl">0</span><span class="op">;</span> <span class="fl">1</span><span class="op">/</span><span class="va">M</span><span class="op">;</span> <span class="fl">0</span><span class="op">;</span> <span class="op">-</span><span class="fl">1</span><span class="op">/</span>(<span class="va">M</span><span class="op">*</span><span class="va">L</span>)]<span class="op">;</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="va">desired_eigs_vec</span> <span class="op">=</span> [<span class="op">-</span><span class="fl">3</span><span class="op">;</span> <span class="op">-</span><span class="fl">4</span><span class="op">;</span> <span class="op">-</span><span class="fl">5</span><span class="op">;</span> <span class="op">-</span><span class="fl">6</span>]<span class="op">;</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="va">K</span> <span class="op">=</span> <span class="va">place</span>(<span class="va">A</span><span class="op">,</span> <span class="va">B</span><span class="op">,</span> <span class="va">desired_eigs_vec</span>)<span class="op">;</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="co">% Just to verify that the poles are where we want them</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="va">eig</span>(<span class="va">A</span> <span class="op">-</span> <span class="va">B</span><span class="op">*</span><span class="va">K</span>)</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="co">%% Solve ODE</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="va">desired_state_vec</span> <span class="op">=</span> [<span class="fl">1</span><span class="op">;</span> <span class="fl">0</span><span class="op">;</span> <span class="fl">0</span><span class="op">;</span> <span class="fl">0</span>]<span class="op">;</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>[<span class="va">t</span><span class="op">,</span> <span class="va">x</span>] <span class="op">=</span> <span class="va">ode45</span>(<span class="op">@</span>(<span class="va">t</span><span class="op">,</span> <span class="va">x</span>) <span class="va">invpend</span>(<span class="va">x</span><span class="op">,</span> <span class="va">m</span><span class="op">,</span> <span class="va">M</span><span class="op">,</span> <span class="va">L</span><span class="op">,</span> <span class="va">g</span><span class="op">,</span> <span class="va">b</span><span class="op">,</span> <span class="op">-</span><span class="va">K</span> <span class="op">*</span> (<span class="va">x</span> <span class="op">-</span> <span class="va">desired_state_vec</span>))<span class="op">,</span> <span class="va">time</span><span class="op">,</span> <span class="va">x0</span>)<span class="op">;</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="co">%% Animation</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="kw">for</span> <span class="va">k</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">length</span>(<span class="va">t</span>)</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    <span class="va">invpend_plot</span>(<span class="va">x</span>(<span class="va">k</span><span class="op">,</span> <span class="op">:</span>)<span class="op">,</span> <span class="va">L</span><span class="op">,</span> <span class="va">true</span><span class="op">,</span> <span class="ss">'simulation_linear_control.gif'</span>)<span class="op">;</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-simulation-linear-control" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-simulation-linear-control-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="src/simulation_linear_control.gif" class="img-fluid figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-simulation-linear-control-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Simulation result of <code>simulation_linear_control.m</code>
</figcaption>
</figure>
</div>
<p>We can see in <a href="#fig-simulation-linear-control" class="quarto-xref">Figure&nbsp;3</a>, the inverted pendulum is able to be stabilized at the status <span class="math inline">\(\mathbf{x} = [1, 0, 0, 0]^t\)</span>.</p>
<p>By changing the desired eigenvalues, we can adjust the convergent speed of the system.</p>
<!-- ----------------------------------------- -->
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Matlab code for changing the desired eigenvalues
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="sourceCode" id="cb9"><pre class="sourceCode matlab code-with-copy"><code class="sourceCode matlab"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="va">clear</span> <span class="va">all</span><span class="op">;</span> <span class="va">close</span> <span class="va">all</span><span class="op">;</span> <span class="va">clc</span><span class="op">;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">%% Simulation parameters</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="va">m</span> <span class="op">=</span> <span class="fl">2</span><span class="op">;</span>          <span class="co">% Mass of pendulum</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="va">M</span> <span class="op">=</span> <span class="fl">10</span><span class="op">;</span>         <span class="co">% Mass of cart</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="va">L</span> <span class="op">=</span> <span class="fl">1</span><span class="op">;</span>          <span class="co">% Length of pendulum</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="va">g</span> <span class="op">=</span> <span class="op">-</span><span class="fl">9.81</span><span class="op">;</span>       <span class="co">% Gravity</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="va">b</span> <span class="op">=</span> <span class="fl">2</span><span class="op">;</span>          <span class="co">% damping coefficient</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="va">time</span> <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">.1</span><span class="op">:</span><span class="fl">12</span><span class="op">;</span> <span class="co">% Time samples</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co">%% Initial conditions</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="va">x0</span> <span class="op">=</span> [<span class="fl">0</span><span class="op">;</span> <span class="fl">0</span><span class="op">;</span> <span class="op">-</span><span class="fl">.4</span><span class="op">;</span> <span class="fl">0</span>]<span class="op">;</span> <span class="co">% x, xdot, theta, thetadot</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co">%% pole placement</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="co">% Define matrix, xdot = Ax + Bu</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="va">A</span> <span class="op">=</span> [<span class="fl">0</span><span class="op">,</span> <span class="fl">1</span><span class="op">,</span>          <span class="fl">0</span><span class="op">,</span>              <span class="fl">0</span><span class="op">;</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>     <span class="fl">0</span><span class="op">,</span> <span class="op">-</span><span class="va">b</span><span class="op">/</span><span class="va">M</span><span class="op">,</span>       <span class="op">-</span><span class="va">m</span><span class="op">*</span><span class="va">g</span><span class="op">/</span><span class="va">M</span><span class="op">,</span>         <span class="fl">0</span><span class="op">;</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>     <span class="fl">0</span><span class="op">,</span> <span class="fl">0</span><span class="op">,</span>          <span class="fl">0</span><span class="op">,</span>              <span class="fl">1</span><span class="op">;</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>     <span class="fl">0</span><span class="op">,</span> <span class="op">-</span><span class="va">b</span><span class="op">/</span>(<span class="va">M</span><span class="op">*</span><span class="va">L</span>)<span class="op">,</span>   <span class="op">-</span>(<span class="va">M</span><span class="op">+</span><span class="va">m</span>)<span class="op">*</span><span class="va">g</span><span class="op">/</span>(<span class="va">M</span><span class="op">*</span><span class="va">L</span>)<span class="op">,</span> <span class="fl">0</span>]<span class="op">;</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="va">B</span> <span class="op">=</span> [<span class="fl">0</span><span class="op">;</span> <span class="fl">1</span><span class="op">/</span><span class="va">M</span><span class="op">;</span> <span class="fl">0</span><span class="op">;</span> <span class="op">-</span><span class="fl">1</span><span class="op">/</span>(<span class="va">M</span><span class="op">*</span><span class="va">L</span>)]<span class="op">;</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="va">desired_eigs_vec_1</span> <span class="op">=</span> [<span class="op">-</span><span class="fl">1</span><span class="op">;</span> <span class="op">-</span><span class="fl">2</span><span class="op">;</span> <span class="op">-</span><span class="fl">3</span><span class="op">;</span> <span class="op">-</span><span class="fl">4</span>]<span class="op">;</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="va">desired_eigs_vec_2</span> <span class="op">=</span> [<span class="op">-</span><span class="fl">2</span><span class="op">;</span> <span class="op">-</span><span class="fl">3</span><span class="op">;</span> <span class="op">-</span><span class="fl">4</span><span class="op">;</span> <span class="op">-</span><span class="fl">5</span>]<span class="op">;</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a><span class="va">desired_eigs_vec_3</span> <span class="op">=</span> [<span class="op">-</span><span class="fl">3</span><span class="op">;</span> <span class="op">-</span><span class="fl">4</span><span class="op">;</span> <span class="op">-</span><span class="fl">5</span><span class="op">;</span> <span class="op">-</span><span class="fl">6</span>]<span class="op">;</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="va">desired_eigs_vec_4</span> <span class="op">=</span> [<span class="op">-</span><span class="fl">4</span><span class="op">;</span> <span class="op">-</span><span class="fl">5</span><span class="op">;</span> <span class="op">-</span><span class="fl">6</span><span class="op">;</span> <span class="op">-</span><span class="fl">7</span>]<span class="op">;</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="va">K</span> <span class="op">=</span> <span class="va">place</span>(<span class="va">A</span><span class="op">,</span> <span class="va">B</span><span class="op">,</span> <span class="va">desired_eigs_vec_4</span>)<span class="op">;</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="co">% Just to verify that the poles are where we want them</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="va">eig</span>(<span class="va">A</span> <span class="op">-</span> <span class="va">B</span><span class="op">*</span><span class="va">K</span>)</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="co">%% Solve ODE</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a><span class="va">desired_state_vec</span> <span class="op">=</span> [<span class="fl">1</span><span class="op">;</span> <span class="fl">0</span><span class="op">;</span> <span class="fl">0</span><span class="op">;</span> <span class="fl">0</span>]<span class="op">;</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>[<span class="va">t</span><span class="op">,</span> <span class="va">x</span>] <span class="op">=</span> <span class="va">ode45</span>(<span class="op">@</span>(<span class="va">t</span><span class="op">,</span> <span class="va">x</span>) <span class="va">invpend</span>(<span class="va">x</span><span class="op">,</span> <span class="va">m</span><span class="op">,</span> <span class="va">M</span><span class="op">,</span> <span class="va">L</span><span class="op">,</span> <span class="va">g</span><span class="op">,</span> <span class="va">b</span><span class="op">,</span> <span class="op">-</span><span class="va">K</span> <span class="op">*</span> (<span class="va">x</span> <span class="op">-</span> <span class="va">desired_state_vec</span>))<span class="op">,</span> <span class="va">time</span><span class="op">,</span> <span class="va">x0</span>)<span class="op">;</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="co">%% Animation</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a><span class="kw">for</span> <span class="va">k</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">length</span>(<span class="va">t</span>)</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">% invpend_plot(x(k, :), L, true, 'convergence_speed_4.gif');</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    <span class="va">invpend_plot</span>(<span class="va">x</span>(<span class="va">k</span><span class="op">,</span> <span class="op">:</span>)<span class="op">,</span> <span class="va">L</span><span class="op">,</span> <span class="va">false</span>)<span class="op">;</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<!-- ----------------------------------------- -->
<div>

</div>
<div class="quarto-layout-panel" data-layout-nrow="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="src/convergence_speed_1.gif" class="img-fluid figure-img"></p>
<figcaption><code>desired_eigs_vec_1 = [-1; -2; -3; -4]</code></figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="src/convergence_speed_2.gif" class="img-fluid figure-img"></p>
<figcaption><code>desired_eigs_vec_2 = [-2; -3; -4; -5]</code></figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="src/convergence_speed_3.gif" class="img-fluid figure-img"></p>
<figcaption><code>desired_eigs_vec_3 = [-3; -4; -5; -6]</code></figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="src/convergence_speed_4.gif" class="img-fluid figure-img"></p>
<figcaption><code>desired_eigs_vec_4 = [-4; -5; -6; -7]</code></figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>We can see that more negative eigenvalues lead to faster convergence, at the risk of breaking the linearity limit and making the system less robust. So we need to make a trade-off between the convergence speed and the robustness (convergence speed is usually limited by the power of the control). Also, we may want to change the convergence style: whether to make the cart move as quickly as possible, or save as much energy as much as possible as long as the pendulum is inverted? Thankfully there is a way to find the required and “optimal” (in a sense) eigenvalues – the Linear Quadratic Regulator (LQR).</p>
</section>
<section id="linear-quadratic-regulator-lqr" class="level3" data-number="5.2">
<h3 data-number="5.2" class="anchored" data-anchor-id="linear-quadratic-regulator-lqr"><span class="header-section-number">5.2</span> Linear Quadratic Regulator (LQR)</h3>
<p>The idea is to define a metric (“loss function” in optimization jargon) to measure the badness of the eigenvalues (either too less robust or cost a lot to control), and then minimize that metric. Someone came up with this weird <a href="#eq-lqr-loss-function" class="quarto-xref">Equation&nbsp;7</a>:</p>
<p><span id="eq-lqr-loss-function"><span class="math display">\[
\tilde{J} := \int_0^\infty (\mathbf{x}^t Q \mathbf{x} + \mathbf{u}^t R \mathbf{u}) \ \mathrm{d}t,
\tag{7}\]</span></span> where <span class="math inline">\(Q^{n \times n}\)</span> and <span class="math inline">\(R^{q \times q}\)</span> are symmetric, positive-definite matrices, which typically are diagonal. In our example, we could choose <span class="math display">\[
Q =
\begin{bmatrix}
    1 &amp; 0 &amp; 0 &amp; 0 \\
    0 &amp; 1 &amp; 0 &amp; 0 \\
    0 &amp; 0 &amp; 5 &amp; 0 \\
    0 &amp; 0 &amp; 0 &amp; 70
\end{bmatrix},
\quad
R = 0.5,
\]</span> which we put bigger penalties on <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\dot{\theta}\)</span> because we want them to converge to their expected value quickly. For the position <span class="math inline">\(x\)</span> and velocity <span class="math inline">\(\dot{x}\)</span>, we don’t care much, so we put a small penalty on them. Also we put a penalty on the control input <span class="math inline">\(F\)</span> since our control device is able to provide large enough instantaneous force and we don’t care the expenditure of energy.</p>
<p>Therefore, <span class="math inline">\(\tilde{J}\)</span> will be: <span class="math display">\[
\tilde{J} = \int_0^\infty (x^2 + \dot{x}^2 + 5 \theta^2 + 70 \dot{\theta}^2 + 0.5 F^2) \  \mathrm{d}t.
\]</span></p>
<p>Now we are using <strong>L</strong>inear feedback to <strong>R</strong>egulate a system to minimize a <strong>Q</strong>uadratic loss function, hence the name <strong>Linear Quadratic Regulator (LQR)</strong>.</p>
<p>The solution to this LQR problem deserves a separate lecture, the solution is given by the <a href="https://en.wikipedia.org/wiki/Algebraic_Riccati_equation">Algebraic Riccati Equation</a>. But in Matlab, there is a one-line command we can use to solve the corresponding <span class="math inline">\(K\)</span> matrix:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode matlab code-with-copy"><code class="sourceCode matlab"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="va">K</span> <span class="op">=</span> <span class="va">lqr</span>(<span class="va">A</span><span class="op">,</span> <span class="va">B</span><span class="op">,</span> <span class="va">Q</span><span class="op">,</span> <span class="va">R</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="simulation-by-changing-q-matrix" class="level3" data-number="5.3">
<h3 data-number="5.3" class="anchored" data-anchor-id="simulation-by-changing-q-matrix"><span class="header-section-number">5.3</span> Simulation by changing Q matrix</h3>
<p>We simulate the dynamics result with different <span class="math inline">\(Q\)</span> matrices and fixed <span class="math inline">\(R = 0.01\)</span>:</p>
<!-- ----------------------------------------- -->
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Matlab code for comparing different Q matrices
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="sourceCode" id="cb11"><pre class="sourceCode matlab code-with-copy"><code class="sourceCode matlab"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="va">clear</span> <span class="va">all</span><span class="op">;</span> <span class="va">close</span> <span class="va">all</span><span class="op">;</span> <span class="va">clc</span><span class="op">;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">%% Simulation parameters</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="va">m</span> <span class="op">=</span> <span class="fl">2</span><span class="op">;</span>          <span class="co">% Mass of pendulum</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="va">M</span> <span class="op">=</span> <span class="fl">10</span><span class="op">;</span>         <span class="co">% Mass of cart</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="va">L</span> <span class="op">=</span> <span class="fl">1</span><span class="op">;</span>          <span class="co">% Length of pendulum</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="va">g</span> <span class="op">=</span> <span class="op">-</span><span class="fl">9.81</span><span class="op">;</span>       <span class="co">% Gravity</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="va">b</span> <span class="op">=</span> <span class="fl">2</span><span class="op">;</span>          <span class="co">% damping coefficient</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="va">time</span> <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">.4</span><span class="op">:</span><span class="fl">100</span><span class="op">;</span> <span class="co">% Time samples</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">%% Initial conditions</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="va">x0</span> <span class="op">=</span> [<span class="fl">0</span><span class="op">;</span> <span class="fl">0</span><span class="op">;</span> <span class="op">-</span><span class="fl">.4</span><span class="op">;</span> <span class="fl">0</span>]<span class="op">;</span> <span class="co">% x, xdot, theta, thetadot</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">%% LQR pole placement</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co">% Define matrix, xdot = Ax + Bu</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="va">A</span> <span class="op">=</span> [<span class="fl">0</span><span class="op">,</span> <span class="fl">1</span><span class="op">,</span>          <span class="fl">0</span><span class="op">,</span>              <span class="fl">0</span><span class="op">;</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>     <span class="fl">0</span><span class="op">,</span> <span class="op">-</span><span class="va">b</span><span class="op">/</span><span class="va">M</span><span class="op">,</span>       <span class="op">-</span><span class="va">m</span><span class="op">*</span><span class="va">g</span><span class="op">/</span><span class="va">M</span><span class="op">,</span>         <span class="fl">0</span><span class="op">;</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>     <span class="fl">0</span><span class="op">,</span> <span class="fl">0</span><span class="op">,</span>          <span class="fl">0</span><span class="op">,</span>              <span class="fl">1</span><span class="op">;</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>     <span class="fl">0</span><span class="op">,</span> <span class="op">-</span><span class="va">b</span><span class="op">/</span>(<span class="va">M</span><span class="op">*</span><span class="va">L</span>)<span class="op">,</span>   <span class="op">-</span>(<span class="va">M</span><span class="op">+</span><span class="va">m</span>)<span class="op">*</span><span class="va">g</span><span class="op">/</span>(<span class="va">M</span><span class="op">*</span><span class="va">L</span>)<span class="op">,</span> <span class="fl">0</span>]<span class="op">;</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="va">B</span> <span class="op">=</span> [<span class="fl">0</span><span class="op">;</span> <span class="fl">1</span><span class="op">/</span><span class="va">M</span><span class="op">;</span> <span class="fl">0</span><span class="op">;</span> <span class="op">-</span><span class="fl">1</span><span class="op">/</span>(<span class="va">M</span><span class="op">*</span><span class="va">L</span>)]<span class="op">;</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="co">% Define penalty Q and R matrix</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="co">% Desired: Move the cart to the desired position as fast as possible</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="co">% Q = [400, 0,  0,  0;</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="co">%      0, 50,  0,  0;</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="co">%      0, 0,  1,  0;</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="co">%      0, 0,  0,  1];</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="co">% Desired: Move the cart as smooth as possible</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="va">Q</span> <span class="op">=</span> [<span class="fl">20</span><span class="op">,</span> <span class="fl">0</span><span class="op">,</span>  <span class="fl">0</span><span class="op">,</span>  <span class="fl">0</span><span class="op">;</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>     <span class="fl">0</span><span class="op">,</span> <span class="fl">400</span><span class="op">,</span>  <span class="fl">0</span><span class="op">,</span>  <span class="fl">0</span><span class="op">;</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>     <span class="fl">0</span><span class="op">,</span> <span class="fl">0</span><span class="op">,</span>  <span class="fl">1</span><span class="op">,</span>  <span class="fl">0</span><span class="op">;</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>     <span class="fl">0</span><span class="op">,</span> <span class="fl">0</span><span class="op">,</span>  <span class="fl">0</span><span class="op">,</span>  <span class="fl">1</span>]<span class="op">;</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a><span class="co">% Desired: Don't change the angle so much</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="co">% Q = [4, 0,  0,  0;</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="co">%      0, 4,  0,  0;</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a><span class="co">%      0, 0,  500,  0;</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a><span class="co">%      0, 0,  0,  50];</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a><span class="co">% Desired: Save energy</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a><span class="va">R</span> <span class="op">=</span> <span class="fl">.01</span><span class="op">;</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a><span class="va">K</span> <span class="op">=</span> <span class="va">lqr</span>(<span class="va">A</span><span class="op">,</span> <span class="va">B</span><span class="op">,</span> <span class="va">Q</span><span class="op">,</span> <span class="va">R</span>)</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a><span class="co">% Just to verify the stability of the closed loop system</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a><span class="va">eig</span>(<span class="va">A</span> <span class="op">-</span> <span class="va">B</span><span class="op">*</span><span class="va">K</span>)</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a><span class="co">%% Solve ODE</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a><span class="va">desired_state_vec</span> <span class="op">=</span> [<span class="fl">1</span><span class="op">;</span> <span class="fl">0</span><span class="op">;</span> <span class="fl">0</span><span class="op">;</span> <span class="fl">0</span>]<span class="op">;</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>[<span class="va">t</span><span class="op">,</span> <span class="va">x</span>] <span class="op">=</span> <span class="va">ode45</span>(<span class="op">@</span>(<span class="va">t</span><span class="op">,</span> <span class="va">x</span>) <span class="va">invpend</span>(<span class="va">x</span><span class="op">,</span> <span class="va">m</span><span class="op">,</span> <span class="va">M</span><span class="op">,</span> <span class="va">L</span><span class="op">,</span> <span class="va">g</span><span class="op">,</span> <span class="va">b</span><span class="op">,</span> <span class="op">-</span><span class="va">K</span> <span class="op">*</span> (<span class="va">x</span> <span class="op">-</span> <span class="va">desired_state_vec</span>))<span class="op">,</span> <span class="va">time</span><span class="op">,</span> <span class="va">x0</span>)<span class="op">;</span></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a><span class="co">%% Animation</span></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a><span class="kw">for</span> <span class="va">k</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">length</span>(<span class="va">t</span>)</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>    <span class="va">invpend_plot</span>(<span class="va">x</span>(<span class="va">k</span><span class="op">,</span> <span class="op">:</span>)<span class="op">,</span> <span class="va">L</span><span class="op">,</span> <span class="va">true</span><span class="op">,</span> <span class="ss">'simulation_lqr_4.gif'</span>)<span class="op">;</span></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">% invpend_plot(x(k, :), L, false);</span></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<!-- ----------------------------------------- -->
<div>

</div>
<div class="quarto-layout-panel" data-layout-nrow="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="src/simulation_lqr_1.gif" class="img-fluid figure-img"></p>
<figcaption><span class="math inline">\(Q = \operatorname{diag}(400, 50, 1, 1)\)</span>: Fast lock in</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="src/simulation_lqr_2.gif" class="img-fluid figure-img"></p>
<figcaption><span class="math inline">\(Q = \operatorname{diag}(20, 400, 1, 1)\)</span>: Smooth cart movement</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="src/simulation_lqr_3.gif" class="img-fluid figure-img"></p>
<figcaption><span class="math inline">\(Q = \operatorname{diag}(4, 4, 500, 50)\)</span>: Keep straight up</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="simulation-by-changing-r-values" class="level3" data-number="5.4">
<h3 data-number="5.4" class="anchored" data-anchor-id="simulation-by-changing-r-values"><span class="header-section-number">5.4</span> Simulation by changing R values</h3>
<p>We simulate the dynamics result with fixed <span class="math inline">\(Q - \operatorname{diag} (20, 400, 1, 1)\)</span> matrix and different <span class="math inline">\(R\)</span> values:</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-nrow="3">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="src/simulation_lqr_4.gif" class="img-fluid figure-img" style="width:60.0%"></p>
<figcaption><span class="math inline">\(R = 0.001\)</span>: More control power</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="src/simulation_lqr_5.gif" class="img-fluid figure-img" style="width:60.0%"></p>
<figcaption><span class="math inline">\(R = 1.5\)</span>: Median control power</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="src/simulation_lqr_6.gif" class="img-fluid figure-img" style="width:60.0%"></p>
<figcaption><span class="math inline">\(R = 5\)</span>: Least control power</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="references" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="references">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-karljohanstrm_2021_feedback" class="csl-entry" role="listitem">
Åström, Karl Johan, and Richard M Murray. 2021. <em>Feedback Systems</em>. Princeton University Press.
</div>
<div id="ref-brunton_2019_datadriven" class="csl-entry" role="listitem">
Brunton, Steven L, and Jose Nathan Kutz. 2019. <em>Data-Driven Science and Engineering : Machine Learning, Dynamical Systems, and Control</em>. Cambridge University Press.
</div>
<div id="ref-jdavidpowell_2012_feedback" class="csl-entry" role="listitem">
Powell, J David. 2012. <em>Feedback Control of Dynamic Systems : International Version/Matlab &amp; Simulink.</em> Pearson Education Limited.
</div>
</div>


</section>


</main> <!-- /main -->
<!-- Cloudflare Web Analytics --><script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;d0b3c27b7e5c43938065722a5136416f&quot;}"></script><!-- End Cloudflare Web Analytics -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/marcobisky\.github\.io");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="Marcobisky.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© Copyright 2025 Marcobisky.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>